'****************************************************************************************
'Generated By  : Kim Tae Ho 
'시스템구분    : RMS/PD/Server Control Class
'실행   환경   : COM+ Service Server Package
'프로그램명    : ccPDCMPREESTLIST.vb
'기         능 : - 가견적관리
'특이  사항    : - CE 단 Query 복사 기능
'                -
'----------------------------------------------------------------------------------------
'HISTORY    :1) 2008.11.12 Kim Tae Ho
'            2) 
'****************************************************************************************

Imports System.Xml                  ' XML처리
Imports SCGLControl                 ' ControlClass의 Base Class
Imports SCGLUtil.cbSCGLConfig       ' ConfigurationClass
Imports SCGLUtil.cbSCGLErr          '오류처리 클래스
Imports SCGLUtil.cbSCGLXml          'XML처리 클래스
Imports SCGLUtil.cbSCGLUtil         '기타유틸리티 클래스
Imports ePDCO                       '엔터티 추가

' 엔티티 클래스 사용시 해당 엔티티 클래스의 프로젝트를 참조한 후 Imports 하십시요. 
' Imports 엔티티프로젝트
Public Class ccPDCOPREESTDTL
    Inherits ccControl
#Region "GROUP BLOCK : 전역 또는 모듈레벨의 변수/상수 선언"
    Private CLASS_NAME = "ccPDCOPREESTDTL"                  '자신의 클래스명
    Private mobjcePD_PREEST_HDR As ePDCO.cePD_PREEST_HDR            '견적헤더
    Private mobjcePD_PREEST_DTL As ePDCO.cePD_PREEST_DTL            '견적상세
    Private mobjcePD_PRODUCTIONCOMMI_INPUT As ePDCO.cePD_PRODUCTIONCOMMI_INPUT  '간접비템프
    Private mobjcePD_PREEST_TEMP As ePDCO.cePD_PREEST_TEMP  '간접비템프
    Private mobjcePD_PREEST_ESTIMATE_HDR As ePDCO.cePD_PREEST_ESTIMATE_HDR '본견적시 가견적 저장 테이블
    Private mobjcePD_PREEST_ESTIMATE_DTL As ePDCO.cePD_PREEST_ESTIMATE_DTL '본견적시 가견적 저장 테이블


    'Private Const .DBConnStr = "Provider=SQLOLEDB;Data Source=10.110.10.86;Initial Catalog=MCDEV;DSN=MCDEV;UID=devadmin;Pwd=password"
#End Region

#Region "GROUP BLOCK : Function Section"
    ' =============== 견적 헤더 조회 ==>> 확정분이 없을 경우
    Public Function SelectRtn_HDRLESS(ByVal strInfoXML As String, _
                                      ByRef intRowCnt As Integer, _
                                      ByRef intColCnt As Integer, _
                                      ByVal strCODE As String) As String

        Dim strCols As String         '컬럼변수
        Dim strWhere As String       'Where조건 변수
        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim strXMLData As String    'XML  Return 변수(XML  을 사용할 때 선언)
        Dim Con1
        strCols = " '' PREESTNO,"
        strCols = strCols & " '' PREESTNAME,"
        strCols = strCols & " DBO.MD_GETPUBNAME_FUN(B.JOBGUBN) JOBGUBN,"
        strCols = strCols & " DBO.MD_GET_CUSTNAME_FUN(C.CLIENTSUBCODE) CLIENTSUBNAME,"
        strCols = strCols & " DBO.PD_JOBCUST_NAME_FUN(C.SUBSEQ) SUBSEQNAME,"
        strCols = strCols & " DBO.MD_GETPUBNAME_FUN(B.CREPART) CREPART,"
        strCols = strCols & " DBO.PD_COMMITION_FUN(C.CLIENTCODE) SUSURATE,0 SUSUAMT,0 COMMITION,0 NONCOMMITION,0 SUMAMT,"
        strCols = strCols & " DBO.MD_GET_CUSTNAME_FUN(C.CLIENTCODE) CLIENTNAME,B.JOBNAME,B.JOBNO,B.REQDAY CREDAY,C.CLIENTSUBCODE,C.CLIENTCODE,C.SUBSEQ"
        'JOBNO,CREDAY,CLIENTSUBCODE,CLIENTCODE

        If strCODE <> "" Then Con1 = String.Format(" AND (B.JOBNO = '{0}')", strCODE)
        strWhere = BuildFields(" ", Con1)
        strFormat = "SELECT {0} FROM PD_JOBNO B,PD_PONO C WHERE B.PROJECTNO = C.PROJECTNO {1} "

        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보 Config 개체
            strSQL = String.Format(strFormat, strCols, strWhere)
            Try
                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                ' ------ Array 데이터 조회 (True 일때 헤더정보 포함 조회(Sheet Data Binding 할 경우 사용), False 일때 데이터만 조회)
                'vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                'Return vntData
                ' ------ XML 데이터 조회
                strXMLData = .mobjSCGLSql.SQLSelectXml(strSQL, intRowCnt, intColCnt)
                Return strXMLData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_HDRLESS")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function
    ' =============== 견적 헤더 조회 ==>> 확정분이 있을경우(사용)
    Public Function SelectRtn_HDR(ByVal strInfoXML As String, _
                                  ByRef intRowCnt As Integer, _
                                  ByRef intColCnt As Integer, _
                                  ByVal strCODE As String) As String

        Dim strCols As String         '컬럼변수
        Dim strWhere As String       'Where조건 변수
        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)     
        Dim strXMLData As String    'XML  Return 변수(XML  을 사용할 때 선언)
        Dim Con1
        Dim strUSER
        Dim intRtn

        With mobjSCGLConfig '기본정보 Config 개체
            Try
                SetConfig(strInfoXML) '기본정보 Setting

                strUSER = mobjSCGLConfig.WRKUSR

                'If strCODE <> "" Then Con1 = String.Format(" AND (A.PREESTNO = '{0}')", strCODE)

                'strWhere = BuildFields(" ", Con1)

                strFormat = " SELECT"
                strFormat = strFormat & " CASE A.CONFIRMGBN WHEN 'T' THEN '본견적' ELSE '가견적' END PREESTGBN,"
                strFormat = strFormat & " A.PREESTNO,"
                strFormat = strFormat & " A.PREESTNAME,"
                strFormat = strFormat & " CASE A.CONFIRMGBN WHEN 'F' THEN ISNULL(A.SUSURATE,0) ELSE ISNULL(D.SUSURATE,0) END ESTSUSURATE, "
                strFormat = strFormat & " CASE A.CONFIRMGBN WHEN 'F' THEN ISNULL(A.SUSUAMT,0) ELSE ISNULL(D.SUSUAMT,0) END ESTSUSUAMT,"
                strFormat = strFormat & " CASE A.CONFIRMGBN WHEN 'F' THEN ISNULL(A.SUMAMT,0) ELSE ISNULL(D.SUMAMT,0)  END ESTSUMAMT,"
                strFormat = strFormat & " CASE A.CONFIRMGBN WHEN 'F' THEN ISNULL(A.COMMITION,0)+ISNULL(A.NONCOMMITION,0) "
                strFormat = strFormat & " ELSE ISNULL(D.COMMITION,0)+ISNULL(D.NONCOMMITION,0) END ESTAMT ,"
                strFormat = strFormat & " CASE A.CONFIRMGBN WHEN 'F' THEN 0 ELSE ISNULL(A.SUSURATE,0) END SUSURATE, "
                strFormat = strFormat & " CASE A.CONFIRMGBN WHEN 'F' THEN 0 ELSE ISNULL(A.SUSUAMT,0) END SUSUAMT,"
                strFormat = strFormat & " CASE A.CONFIRMGBN WHEN 'F' THEN 0 ELSE A.SUMAMT  END SUMAMT,"
                strFormat = strFormat & " CASE A.CONFIRMGBN WHEN 'F' THEN 0 ELSE A.COMMITION+A.NONCOMMITION END  AMT ,"
                strFormat = strFormat & " ISNULL(A.COMMITION,0) COMMITION,"
                strFormat = strFormat & " ISNULL(A.NONCOMMITION,0) NONCOMMITION,"
                strFormat = strFormat & " B.JOBNAME, A.CONFIRMFLAG AGREEYEARMON,"
                strFormat = strFormat & " B.JOBNO, "
                strFormat = strFormat & " DBO.PD_ENDFLAGPREESTNO_FUN(A.PREESTNO) ENDFLAG,"
                strFormat = strFormat & " A.MEMO,"
                strFormat = strFormat & " DBO.PD_ENDFLAGEXE_FUN(B.JOBNO) ENDFLAGEXE,"
                strFormat = strFormat & " DBO.PD_PREESTCONFIRM_FUN(A.JOBNO) SETCONFIRMFLAG,"
                strFormat = strFormat & " A.CLIENTCODE, A.TIMCODE, A.SUBSEQ"
                strFormat = strFormat & " FROM PD_PREEST_HDR A "
                strFormat = strFormat & " INNER JOIN PD_JOBNO B ON A.JOBNO = B.JOBNO "
                strFormat = strFormat & " LEFT JOIN PD_PREEST_ESTIMATE_HDR D ON A.PREESTNO = D.PREESTNO "
                strFormat = strFormat & " WHERE 1=1  "
                strFormat = strFormat & " AND (A.PREESTNO = '" & strCODE & "') "

                strSQL = String.Format(strFormat)

                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)

                ' ------ XML 데이터 조회
                strXMLData = .mobjSCGLSql.SQLSelectXml(strSQL, intRowCnt, intColCnt)
                '트랜젝션 걸림(조회시, PD_SUBITEM_INPUT >> TEMP 값무조건 삭제)

                .mobjSCGLSql.SQLBeginTrans()
                mobjcePD_PREEST_HDR = New cePD_PREEST_HDR(mobjSCGLConfig)
                intRtn = mobjcePD_PREEST_HDR.TempDeleteDo(strUSER)
                .mobjSCGLSql.SQLCommitTrans()

                Return strXMLData
            Catch err As Exception
                ' 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()



                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_HDR")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_PREEST_HDR.Dispose()
            End Try
        End With
    End Function
    ' =============== 본견적 이 있는지 없는지 확인 (사용)
    Public Function SelectRtn_ExeCount(ByVal strInfoXML As String, _
                                       ByRef intRowCnt As Integer, _
                                       ByRef intColCnt As Integer, _
                                       ByVal strCODE As String) As String

        Dim strCols As String         '컬럼변수
        Dim strWhere As String       'Where조건 변수
        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim strXMLData As String    'XML  Return 변수(XML  을 사용할 때 선언)
        Dim Con1



        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보 Config 개체
            strSQL = "SELECT PREESTNO FROM PD_PREEST_HDR WHERE CONFIRMGBN = 'T' AND JOBNO ='" & strCODE & "'"
            Try
                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                ' ------ Array 데이터 조회 (True 일때 헤더정보 포함 조회(Sheet Data Binding 할 경우 사용), False 일때 데이터만 조회)
                'vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                'Return vntData
                ' ------ XML 데이터 조회
                strXMLData = .mobjSCGLSql.SQLSelectOneScalar(strSQL) ', intRowCnt, intColCnt
                Return strXMLData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_ExeCount")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    ' =============== 제작번호로 견적 번호 가져오기(사용)
    Public Function SelectRtn_PREESTNO(ByVal strInfoXML As String, _
                                       ByRef intRowCnt As Integer, _
                                       ByRef intColCnt As Integer, _
                                       ByVal strCODE As String) As Object

        Dim strCols As String         '컬럼변수
        Dim strWhere As String       'Where조건 변수
        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim strXMLData As String    'XML  Return 변수(XML  을 사용할 때 선언)
        Dim Con1

        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보 Config 개체
            strSQL = "SELECT TOP 1 PREESTNO FROM PD_PREEST_HDR WHERE JOBNO = '" & strCODE & "' AND ISNULL(CONFIRMFLAG,'') <> '' "
            Try
                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                ' ------ Array 데이터 조회 (True 일때 헤더정보 포함 조회(Sheet Data Binding 할 경우 사용), False 일때 데이터만 조회)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return vntData
                ' ------ XML 데이터 조회
                'strXMLData = .mobjSCGLSql.SQLSelectXml(strSQL, intRowCnt, intColCnt)
                'Return strXMLData '
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_PREESTNO")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    ' =============== 가견적 상세내역 리스트 조회(사용)
    Public Function SelectRtn_DTL(ByVal strInfoXML As String, _
                                  ByRef intRowCnt As Integer, _
                                  ByRef intColCnt As Integer, _
                                  ByVal strCODE As String) As Object

        Dim strWhere As String       'Where조건 변수
        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim Con1

        'If strCODE <> "" Then Con1 = String.Format(" AND (A.PREESTNO = '{0}')", strCODE)
        'strWhere = BuildFields(" ", Con1)

        strSQL = " SELECT "
        strSQL = strSQL & " ROW_NUMBER() OVER (ORDER BY A.PRINT_SEQ) PRINT_SEQ, "
        strSQL = strSQL & " A.ITEMCODESEQ, A.PREESTNO, A.ITEMCODESEQ, "
        strSQL = strSQL & " DBO.PD_ITEMDIVNAME_FUN(A.ITEMCODE) DIVNAME, "
        strSQL = strSQL & " DBO.PD_ITEMCLASSNAME_FUN(A.ITEMCODE) CLASSNAME, "
        strSQL = strSQL & " A.ITEMCODE, "
        strSQL = strSQL & " DBO.PD_ITEMCODENAME_FUN(A.ITEMCODE) ITEMCODENAME, "
        strSQL = strSQL & " A.STD, A.COMMIFLAG, "
        strSQL = strSQL & " isnull(A.QTY,0) QTY, "
        strSQL = strSQL & " isnull(A.PRICE,0) PRICE, "
        strSQL = strSQL & " isnull(A.AMT,0) AMT, "
        strSQL = strSQL & " CASE ISNULL(B.PREESTNO,'') WHEN '' THEN '' ELSE 'T' END AS GBN, "
        strSQL = strSQL & " A.FAKENAME,isnull(A.SUSUAMT,0) SUSUAMT,  "
        strSQL = strSQL & " DBO.PD_PREESTSUBDETAILGBN_FUN(A.PREESTNO, A.ITEMCODE, A.ITEMCODESEQ) SUBDETAIL, "
        strSQL = strSQL & " 'N' SAVEFLAG, "
        strSQL = strSQL & " DBO.PD_ITEMCODEDETAILYN_FUN(A.ITEMCODE) DETAILYNFLAG,A.IMESEQ, "
        strSQL = strSQL & " DBO.PD_PRODUCTIONCOMMISSION_FUN(A.ITEMCODE) PRODUCTIONCOMMISSION "
        strSQL = strSQL & " FROM PD_PREEST_DTL A "
        strSQL = strSQL & " LEFT JOIN "
        strSQL = strSQL & "       ( "
        strSQL = strSQL & "       SELECT PREESTNO,ITEMCODE,ITEMCODESEQ  "
        strSQL = strSQL & "       FROM PD_EXE_DTL  "
        strSQL = strSQL & "       GROUP BY PREESTNO,ITEMCODE,ITEMCODESEQ "
        strSQL = strSQL & "       ) B ON A.PREESTNO = B.PREESTNO AND A.ITEMCODE = B.ITEMCODE AND A.ITEMCODESEQ = B.ITEMCODESEQ "
        strSQL = strSQL & " WHERE 1=1 "
        strSQL = strSQL & " AND (A.PREESTNO = '" & strCODE & "') "
        strSQL = strSQL & " ORDER BY  A.PRINT_SEQ "

        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보 Config 개체
            'strSQL = String.Format(strFormat, strWhere)
            Try
                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                ' ------ Array 데이터 조회 (True 일때 헤더정보 포함 조회(Sheet Data Binding 할 경우 사용), False 일때 데이터만 조회)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return vntData

            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_DTL")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    ' ==============가견적 및 본견적 수정 저장(사용)
    ' strCHKCONFIRM = F:가견적, T:본견적 [가견적 및 본견적 구분]
    ' strTR = U: 업데이트,I: 인서트[내역복사 후 본견적으로 저장시 Inser,Update 구분용] 헤더가 존재하지 않는 EST_COPY 또는 신규 입력 헤더는 TYPE0 을 따른다

    Public Function ProcessRtn_PREESTHDR(ByVal strInfoXML As String, _
                                         ByVal strMasterXML As String, _
                                         ByVal vntData As Object, _
                                         ByRef strPREESTNO As String, _
                                         ByVal strAGREEYEARMON As String, _
                                         ByVal strCHKCONFIRM As String, _
                                         ByVal strTR As String, _
                                         ByVal strPRODUCTIONCHK As String, _
                                         ByVal strPROCESS As String) As Integer
        Dim intRtn As Integer '결과값 변수
        Dim i, intColCnt, intRows As Integer '루프, 컬럼Cnt, 로우Cnt 변수

        Dim strJOBNO As String
        Dim strSQL As String
        Dim intPREESTRtn As String
        Dim intcheck As Integer
        Dim intDel2 As Integer


        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보를 가지고 있는 Config 개체
            Try
                mobjcePD_PREEST_HDR = New cePD_PREEST_HDR(mobjSCGLConfig)
                mobjcePD_PREEST_DTL = New cePD_PREEST_DTL(mobjSCGLConfig)
                mobjcePD_PREEST_ESTIMATE_HDR = New cePD_PREEST_ESTIMATE_HDR(mobjSCGLConfig)
                mobjcePD_PREEST_ESTIMATE_DTL = New cePD_PREEST_ESTIMATE_DTL(mobjSCGLConfig)


                'XML Element 변수 선언 (strMasterXML을 변환)
                Dim xmlRoot As XmlElement
                xmlRoot = XMLGetRoot(strMasterXML) 'XML 데이터

                'DB접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                'Master 데이터 처리
                strJOBNO = XMLGetElement(xmlRoot, "JOBNO")

                If strPROCESS = "EXPROCESS" Then
                    '본견적 변경시 가견적 백업 장소에 없다면 insert
                    intcheck = SelectRtn_ESTIMATE_CHECK(strPREESTNO)
                    If intcheck = 0 Then
                        '먼저 같은잡의 견적들을 지우고 새로 넣는다.

                        '본견적이 가견적이될때 예전에 백업받은 금액을 넣어준다.
                        intDel2 = mobjcePD_PREEST_ESTIMATE_HDR.Update_Preest_hdr(strJOBNO)
                        intDel2 = mobjcePD_PREEST_ESTIMATE_DTL.Update_Preest_dtl(strJOBNO)

                        intDel2 = mobjcePD_PREEST_ESTIMATE_HDR.DeleteDo(strJOBNO)
                        intDel2 = mobjcePD_PREEST_ESTIMATE_DTL.DeleteDo(strJOBNO)
                        intRtn = InsertRtn3_HDR(xmlRoot, strPREESTNO, strAGREEYEARMON)
                        intDel2 = mobjcePD_PREEST_ESTIMATE_DTL.INSERT_DTL(strPREESTNO)

                        strSQL = strSQL & " UPDATE PD_SUBITEM_DTL  "
                        strSQL = strSQL & " SET PRINT_SEQ_OLD = PRINT_SEQ, EXEPRICE=PRICE, EXEQTY=QTY,  EXETERM=TERM, EXEAMT=AMT, EXEMEMO=MEMO"
                        strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "'; "

                        strSQL = strSQL & " UPDATE PD_PRODUCTIONCOMMI_HDR  "
                        strSQL = strSQL & " SET EXEAMT=AMT, EXECOMMIRATE=COMMIRATE "
                        strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "'; "

                        strSQL = strSQL & " UPDATE PD_PRODUCTIONCOMMI_DTL  "
                        strSQL = strSQL & " SET SORT_SEQ_OLD = SORT_SEQ, EXEAMT=AMT, EXECHK=CHK "
                        strSQL = strSQL & "  WHERE PREESTNO = '" & strPREESTNO & "'; "

                        intPREESTRtn = mobjcePD_PREEST_DTL.Batch_Insert(strSQL)
                    End If
                End If

                '견적 헤더 저장
                If strTR = "I" And strPREESTNO = "" Then
                    strPREESTNO = SelectRtn_ESTSEQNO()
                End If

                intRtn = ProcessRtn_HDR(xmlRoot, strPREESTNO, strAGREEYEARMON, strCHKCONFIRM, strTR)

                If IsArray(vntData) Then
                    intRtn = ProcessRtn_DETAIL_ONE(vntData, strPREESTNO, strPRODUCTIONCHK, strJOBNO)
                End If

                intRtn = ProcessRtn_DIVAMT(strJOBNO, strPREESTNO, strCHKCONFIRM)

                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_PREESTHDR")
            Finally
                'Resource해제
                mobjcePD_PREEST_HDR.Dispose()
                mobjcePD_PREEST_DTL.Dispose()
                mobjcePD_PREEST_ESTIMATE_HDR.Dispose()
                mobjcePD_PREEST_ESTIMATE_DTL.Dispose()
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    Public Function ProcessRtn_DIVAMT(ByVal strJOBNO As String, _
                                      ByVal strPREESTNO As String, _
                                      ByVal strCHKCONFIRM As String) As Integer

        '헷갈리지 않게 적어놓기
        'PD_PREEST_DTL 에 INSERT 한다.
        '노란행을 확인하여 간접비와 상세내역을 INSERT 한다.

        Dim intRtn As Integer
        Dim strDIVAMTSQL
        Dim intCnt
        Dim intDIVAMTRtn, intRtnUpdate

        With mobjSCGLConfig
            Try
                '''사용할 Entity 개체생성(Config 정보를 넘겨생성)
                mobjcePD_PREEST_DTL = New cePD_PREEST_DTL(mobjSCGLConfig)
                mobjcePD_PREEST_HDR = New cePD_PREEST_HDR(mobjSCGLConfig)

                '''해당하는Row 만큼 Loop
                If strCHKCONFIRM = "T" Then
                    intCnt = SelectRtn_DIVSEQ(strJOBNO)
                    If intCnt = 0 Then
                        'DIVAMT 에 인서트 
                        strDIVAMTSQL = " INSERT INTO PD_DIVAMT "
                        strDIVAMTSQL = strDIVAMTSQL & " (PREESTNO,SEQ,JOBNO,YEARMON,CREDAY,CLIENTCODE,TIMCODE, "
                        strDIVAMTSQL = strDIVAMTSQL & " DIVAMT,ADJAMT,JOBNAME,ENDFLAG,CUSER,CDATE,SUBSEQ,CONFIRMFLAG) "
                        strDIVAMTSQL = strDIVAMTSQL & " SELECT "
                        strDIVAMTSQL = strDIVAMTSQL & " PREESTNO,1 SEQ,JOBNO,SUBSTRING(CONFIRMFLAG,1,6) YEARMON, "
                        strDIVAMTSQL = strDIVAMTSQL & " CONFIRMFLAG CREDAY,CLIENTCODE,TIMCODE,SUMAMT DIVAMT,0 ADJAMT, "
                        strDIVAMTSQL = strDIVAMTSQL & " DBO.PD_JOBNAME_FUN(JOBNO) JOBNAME,'PF02' ENDFLAG,CUSER,CDATE,SUBSEQ,'1' CONFIRMFLAG "
                        strDIVAMTSQL = strDIVAMTSQL & " FROM PD_PREEST_HDR WHERE PREESTNO = '" & strPREESTNO & "' "

                        intDIVAMTRtn = mobjcePD_PREEST_DTL.Batch_Insert(strDIVAMTSQL)
                        intRtnUpdate = mobjcePD_PREEST_HDR.UpdateENDFLAG(strJOBNO)

                    ElseIf intCnt > 0 Then
                        'DIVAMT DELETE 후 신규 Row INSERT [현재 이전 저장되어 있던 내역을 전체 삭제 하고 수정된 견적내역을 대표견적으로 재청구요청을 할수 있게 하였음]
                        strDIVAMTSQL = " DELETE FROM PD_DIVAMT WHERE JOBNO = '" & strJOBNO & "' ; "
                        strDIVAMTSQL = strDIVAMTSQL & " INSERT INTO PD_DIVAMT "
                        strDIVAMTSQL = strDIVAMTSQL & " (PREESTNO,SEQ,JOBNO,YEARMON,CREDAY,CLIENTCODE,TIMCODE, "
                        strDIVAMTSQL = strDIVAMTSQL & " DIVAMT,ADJAMT,JOBNAME,ENDFLAG,CUSER,CDATE,SUBSEQ,CONFIRMFLAG) "
                        strDIVAMTSQL = strDIVAMTSQL & " SELECT "
                        strDIVAMTSQL = strDIVAMTSQL & " PREESTNO,1 SEQ,JOBNO,SUBSTRING(CONFIRMFLAG,1,6) YEARMON,CONFIRMFLAG CREDAY, "
                        strDIVAMTSQL = strDIVAMTSQL & " CLIENTCODE,TIMCODE,SUMAMT DIVAMT,0 ADJAMT, "
                        strDIVAMTSQL = strDIVAMTSQL & " DBO.PD_JOBNAME_FUN(JOBNO) JOBNAME,'PF02' ENDFLAG,CUSER,CDATE,SUBSEQ,'1' CONFIRMFLAG "
                        strDIVAMTSQL = strDIVAMTSQL & " FROM PD_PREEST_HDR "
                        strDIVAMTSQL = strDIVAMTSQL & " WHERE PREESTNO = '" & strPREESTNO & "'; "

                        strDIVAMTSQL = strDIVAMTSQL & " DELETE FROM PD_DEMAND_DTL WHERE JOBNO = '" & strJOBNO & "'; "
                        strDIVAMTSQL = strDIVAMTSQL & " DELETE FROM PD_DEMAND_MST WHERE JOBNO = '" & strJOBNO & "'; "

                        intDIVAMTRtn = mobjcePD_PREEST_DTL.Batch_Insert(strDIVAMTSQL)

                    End If
                End If
                Return intRtn
            Catch err As Exception

                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_DIVAMT")
            Finally

                mobjcePD_PREEST_DTL.Dispose()
                mobjcePD_PREEST_HDR.Dispose()

            End Try
        End With
    End Function

    '견적 삭제후에 헤더 다시 계산.
    Public Function ProcessRtn_DelProc(ByVal strInfoXML As String, _
                                       ByVal strMasterXML As String, _
                                       ByRef strPREESTNO As String, _
                                       ByVal strAGREEYEARMON As String, _
                                       ByVal strCHKCONFIRM As String, _
                                       ByVal strTR As String) As Integer
        Dim intRtn As Integer '결과값 변수
        Dim i, intColCnt, intRows As Integer '루프, 컬럼Cnt, 로우Cnt 변수

        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보를 가지고 있는 Config 개체
            Try
                'XML Element 변수 선언 (strMasterXML을 변환)
                Dim xmlRoot As XmlElement
                xmlRoot = XMLGetRoot(strMasterXML) 'XML 데이터

                'DB접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                'Master 데이터 처리

                'intRtn = ProcessRtn_HDR(xmlRoot, strPREESTNO, strAGREEYEARMON, strCHKCONFIRM, strTR)


                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_DelProc")
            Finally
                'Resource해제
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    '============== 가견적 및 본견적 수정저장 하는 경우 헤더(사용) TYPE 0
    Public Function ProcessRtn_HDR(ByVal xmlRoot As XmlElement, _
                                   ByVal strPREESTNO As String, _
                                   ByVal strAGREEYEARMON As String, _
                                   ByVal strCHKCONFIRM As String, _
                                   ByVal strTR As String) As Integer
        Dim strPONO
        Dim intRtn
        Dim intRtnNew As Integer
        Dim strCUSTCODE As String
        Dim strSQL As String
        Dim strJOBNO As String
        Dim intCnt As Integer
        Dim strDIVAMTSQL As String
        Dim intDIVAMTRtn As Integer
        Dim intPREESTRtn As String
        Dim strPREESTHDRSQL As String
        Dim strEXESQL As String
        Dim strPreSql As String
        Dim intDel As Integer
        Dim intDel2 As Integer
        Dim intRtnUpdate As Integer
        Dim intcheck As Integer

        With mobjSCGLConfig
            Try

                ''' 사용할 Entity 개체생성(Config 정보를 넘겨생성)
                mobjcePD_PREEST_HDR = New cePD_PREEST_HDR(mobjSCGLConfig)
                mobjcePD_PREEST_DTL = New cePD_PREEST_DTL(mobjSCGLConfig)
                mobjcePD_PREEST_ESTIMATE_HDR = New cePD_PREEST_ESTIMATE_HDR(mobjSCGLConfig)
                mobjcePD_PREEST_ESTIMATE_DTL = New cePD_PREEST_ESTIMATE_DTL(mobjSCGLConfig)


                strJOBNO = XMLGetElement(xmlRoot, "JOBNO")

                If strTR = "U" Or strTR = "UU" Then

                    If XMLGetElement(xmlRoot, "PREESTGBN") = "본견적" Then
                        
                        '    intRtn = UpdateRtn_HDR(xmlRoot, strPREESTNO, strAGREEYEARMON)

                        intRtn = UpdateRtn_HDR_BASIC(xmlRoot, strPREESTNO, strAGREEYEARMON)
                    Else
                        '    intRtn = UpdateRtn_HDR2(xmlRoot, strPREESTNO, strAGREEYEARMON)

                        intRtn = UpdateRtn_HDR_BASIC2(xmlRoot, strPREESTNO, strAGREEYEARMON)
                        '뒤바꿔서 금액 넣기
                    End If
                Else
                    intRtn = InsertRtn2_HDR(xmlRoot, strPREESTNO, strAGREEYEARMON)

                    '저장을 하지 않고 바로 본견적으로 저장할 경우 상단에서 InsertRtn3_HDR 한번 타는데 여기서 예외로 타기때문에 체크를 삽입..20110726.SH
                    intcheck = SelectRtn_ESTIMATE_CHECK(strPREESTNO)
                    If intcheck = 0 Then
                        intRtn = InsertRtn3_HDR(xmlRoot, strPREESTNO, strAGREEYEARMON)
                    End If
                End If

                '본견적일경우
                If strCHKCONFIRM = "T" Then

                    intCnt = SelectRtn_DIVSEQ(strJOBNO)
                    If intCnt = 0 Then
                        'DIVAMT 에 인서트 
                        strDIVAMTSQL = " INSERT INTO PD_DIVAMT "
                        strDIVAMTSQL = strDIVAMTSQL & " (PREESTNO,SEQ,JOBNO,YEARMON,CREDAY,CLIENTCODE,TIMCODE, "
                        strDIVAMTSQL = strDIVAMTSQL & " DIVAMT,ADJAMT,JOBNAME,ENDFLAG,CUSER,CDATE,SUBSEQ,CONFIRMFLAG) "
                        strDIVAMTSQL = strDIVAMTSQL & " SELECT "
                        strDIVAMTSQL = strDIVAMTSQL & " PREESTNO,1 SEQ,JOBNO,SUBSTRING(CONFIRMFLAG,1,6) YEARMON, "
                        strDIVAMTSQL = strDIVAMTSQL & " CONFIRMFLAG CREDAY,CLIENTCODE,TIMCODE,SUMAMT DIVAMT,0 ADJAMT, "
                        strDIVAMTSQL = strDIVAMTSQL & " DBO.PD_JOBNAME_FUN(JOBNO) JOBNAME,'PF02' ENDFLAG,CUSER,CDATE,SUBSEQ,'1' CONFIRMFLAG "
                        strDIVAMTSQL = strDIVAMTSQL & " FROM PD_PREEST_HDR WHERE PREESTNO = '" & strPREESTNO & "' "

                        intDIVAMTRtn = mobjcePD_PREEST_DTL.Batch_Insert(strDIVAMTSQL)
                        intRtnUpdate = mobjcePD_PREEST_HDR.UpdateENDFLAG(strJOBNO)

                    ElseIf intCnt > 0 Then
                        'DIVAMT DELETE 후 신규 Row INSERT [현재 이전 저장되어 있던 내역을 전체 삭제 하고 수정된 견적내역을 대표견적으로 재청구요청을 할수 있게 하였음]
                        strDIVAMTSQL = " DELETE FROM PD_DIVAMT WHERE JOBNO = '" & strJOBNO & "' ; "
                        strDIVAMTSQL = strDIVAMTSQL & " INSERT INTO PD_DIVAMT "
                        strDIVAMTSQL = strDIVAMTSQL & " (PREESTNO,SEQ,JOBNO,YEARMON,CREDAY,CLIENTCODE,TIMCODE, "
                        strDIVAMTSQL = strDIVAMTSQL & " DIVAMT,ADJAMT,JOBNAME,ENDFLAG,CUSER,CDATE,SUBSEQ,CONFIRMFLAG) "
                        strDIVAMTSQL = strDIVAMTSQL & " SELECT "
                        strDIVAMTSQL = strDIVAMTSQL & " PREESTNO,1 SEQ,JOBNO,SUBSTRING(CONFIRMFLAG,1,6) YEARMON,CONFIRMFLAG CREDAY, "
                        strDIVAMTSQL = strDIVAMTSQL & " CLIENTCODE,TIMCODE,SUMAMT DIVAMT,0 ADJAMT, "
                        strDIVAMTSQL = strDIVAMTSQL & " DBO.PD_JOBNAME_FUN(JOBNO) JOBNAME,'PF02' ENDFLAG,CUSER,CDATE,SUBSEQ,'1' CONFIRMFLAG "
                        strDIVAMTSQL = strDIVAMTSQL & " FROM PD_PREEST_HDR "
                        strDIVAMTSQL = strDIVAMTSQL & " WHERE PREESTNO = '" & strPREESTNO & "'; "

                        strDIVAMTSQL = strDIVAMTSQL & " DELETE FROM PD_DEMAND_DTL WHERE JOBNO = '" & strJOBNO & "'; "
                        strDIVAMTSQL = strDIVAMTSQL & " DELETE FROM PD_DEMAND_MST WHERE JOBNO = '" & strJOBNO & "'; "

                        intDIVAMTRtn = mobjcePD_PREEST_DTL.Batch_Insert(strDIVAMTSQL)
                        'PD_DIVAMT 에 미청구내역 저장분이 존재 할수 있으므로 삭제처리

                    End If

                    If strTR <> "UU" Then

                        '본견적은 1개 이여야 하기 때문에  본견적으로 유지 및 본견적으로 변경 시 일단 모두 가견적 상태로 두고 현재 본견적인 것만 본견적 플레그를 확정한다.
                        strPreSql = " UPDATE PD_SUBITEM_DTL  "
                        strPreSql = strPreSql & " SET CONFIRMGBN = 'F', EXEPRICE=0 , EXEQTY=0, EXETERM=0, EXEAMT=AMT, EXEMEMO='' "
                        strPreSql = strPreSql & " FROM "
                        strPreSql = strPreSql & " ( "
                        strPreSql = strPreSql & " 	 SELECT "
                        strPreSql = strPreSql & "	 PREESTNO "
                        strPreSql = strPreSql & "	 FROM "
                        strPreSql = strPreSql & "	 ( "
                        strPreSql = strPreSql & " 	 SELECT A.PREESTNO,B.JOBNO "
                        strPreSql = strPreSql & "    FROM PD_SUBITEM_DTL A,PD_PREEST_HDR B "
                        strPreSql = strPreSql & "    WHERE A.PREESTNO = B.PREESTNO "
                        strPreSql = strPreSql & "    GROUP BY A.PREESTNO,B.JOBNO "
                        strPreSql = strPreSql & "	 ) DATA1, "
                        strPreSql = strPreSql & "	 ( "
                        strPreSql = strPreSql & "	 SELECT B.JOBNO  "
                        strPreSql = strPreSql & "	 FROM PD_SUBITEM_DTL A,PD_PREEST_HDR B  "
                        strPreSql = strPreSql & " 	 WHERE A.PREESTNO = B.PREESTNO AND A.PREESTNO = '" & strPREESTNO & "' "
                        strPreSql = strPreSql & "     GROUP BY B.JOBNO"
                        strPreSql = strPreSql & "	 )DATA2 "
                        strPreSql = strPreSql & "	 WHERE DATA1.JOBNO = DATA2.JOBNO "
                        strPreSql = strPreSql & ") DATASET "
                        strPreSql = strPreSql & "WHERE PD_SUBITEM_DTL.PREESTNO = DATASET.PREESTNO; "

                        strPreSql = strPreSql & " UPDATE PD_PRODUCTIONCOMMI_HDR "
                        strPreSql = strPreSql & " SET EXEAMT=0, EXECOMMIRATE=0 "
                        strPreSql = strPreSql & " WHERE PREESTNO IN "
                        strPreSql = strPreSql & " ( "
                        strPreSql = strPreSql & "       SELECT PREESTNO "
                        strPreSql = strPreSql & "       FROM PD_PREEST_HDR  "
                        strPreSql = strPreSql & "       WHERE JOBNO = '" & strJOBNO & "' and PREESTNO <> '" & strPREESTNO & "' "
                        strPreSql = strPreSql & "       GROUP BY PREESTNO "
                        strPreSql = strPreSql & " ); "

                        strPreSql = strPreSql & " UPDATE PD_PRODUCTIONCOMMI_DTL "
                        strPreSql = strPreSql & " SET EXEAMT=0, EXECHK='0' WHERE PREESTNO IN "
                        strPreSql = strPreSql & " ( "
                        strPreSql = strPreSql & "       SELECT PREESTNO "
                        strPreSql = strPreSql & "       FROM PD_PREEST_HDR WHERE JOBNO = '" & strJOBNO & "'and PREESTNO <> '" & strPREESTNO & "' "
                        strPreSql = strPreSql & "       GROUP BY PREESTNO "
                        strPreSql = strPreSql & " ) "


                        '여기여기
                        '여기서부턴 해당견적만 다시 가견적금액을 실행견적금액으로 이동.
                        'strPreSql = strPreSql & " UPDATE PD_PRODUCTIONCOMMI_HDR SET EXEAMT=AMT, EXECOMMIRATE=COMMIRATE WHERE PREESTNO = '" & strPREESTNO & "'; "
                        'strPreSql = strPreSql & " UPDATE PD_PRODUCTIONCOMMI_DTL SET EXEAMT=AMT WHERE PREESTNO = '" & strPREESTNO & "'; "

                        strPREESTHDRSQL = strPreSql & "UPDATE PD_SUBITEM_DTL "
                        strPREESTHDRSQL = strPREESTHDRSQL & " SET CONFIRMGBN = 'T', EXEPRICE=PRICE, EXEQTY=QTY, EXETERM=TERM, EXEAMT=AMT, EXEMEMO=MEMO "
                        strPREESTHDRSQL = strPREESTHDRSQL & " WHERE PREESTNO = '" & strPREESTNO & "' ; "
                        strPREESTHDRSQL = strPREESTHDRSQL & " UPDATE PD_PREEST_HDR "
                        strPREESTHDRSQL = strPREESTHDRSQL & " SET CONFIRMGBN = 'F' "
                        strPREESTHDRSQL = strPREESTHDRSQL & " WHERE JOBNO = '" & strJOBNO & "'; "

                        strPREESTHDRSQL = strPREESTHDRSQL & " UPDATE PD_PREEST_HDR "
                        strPREESTHDRSQL = strPREESTHDRSQL & " SET CONFIRMGBN = 'T' "
                        strPREESTHDRSQL = strPREESTHDRSQL & " WHERE PREESTNO = '" & strPREESTNO & "'; "

                        strPREESTHDRSQL = strPREESTHDRSQL & " UPDATE PD_JOBNO "
                        strPREESTHDRSQL = strPREESTHDRSQL & " SET PREESTNO = '" & strPREESTNO & "',AGREEYEARMON =  '" & strAGREEYEARMON & "' "
                        strPREESTHDRSQL = strPREESTHDRSQL & " WHERE JOBNO = '" & strJOBNO & "'; "

                        'strPreSql = strPreSql & " UPDATE PD_SUBITEM_DTL SET EXEPRICE=PRICE, EXEQTY=QTY,  EXETERM=TERM, EXEAMT=AMT, EXEMEMO=MEMO WHERE PREESTNO = '" & strPREESTNO & "'; "

                        'strPREESTHDRSQL = strPreSql & " UPDATE PD_PRODUCTIONCOMMI_DTL SET EXEAMT=AMT WHERE PREESTNO = '" & strPREESTNO & "'; "

                        intPREESTRtn = mobjcePD_PREEST_DTL.Batch_Insert(strPREESTHDRSQL)

                    End If
                    '확정견적일 경우 무조건 업데이트 한다. [정산의 청구견적의 합계 금액을 UPDATE 해야 한다.]
                    'NONCOMMITION,COMMITION,SUSURATE,SUSUAMT
                    'strEXESQL = "UPDATE PD_EXE_HDR SET NONCOMMITION = B.NONCOMMITION,COMMITION = B.COMMITION,SUSURATE = B.SUSURATE,SUSUAMT = B.SUSUAMT FROM PD_PREEST_HDR B WHERE PD_EXE_HDR.PREESTNO = B.PREESTNO AND PD_EXE_HDR.JOBNO = '" & strJOBNO & "' "
                    'intRtnNew = mobjcePD_PREEST_HDR.NewUpdate(strEXESQL)
                End If

                '저장시 SUBITEM 변경 내역의 삭제 처리
                strSQL = " DELETE FROM PD_SUBITEM_DTL "
                strSQL = strSQL & "FROM PD_SUBITEM_DTL AS A JOIN  "
                strSQL = strSQL & "(  "
                strSQL = strSQL & "    SELECT ITEMCODE,ITEMCODESEQ,PREESTNO "
                strSQL = strSQL & "    FROM "
                strSQL = strSQL & "    ( "
                strSQL = strSQL & "        SELECT ITEMCODE,ITEMCODESEQ,PREESTNO FROM PD_SUBITEM_DTL WHERE PREESTNO = '" & strPREESTNO & "' "
                strSQL = strSQL & "        EXCEPT "
                strSQL = strSQL & "        SELECT ITEMCODE,ITEMCODESEQ,PREESTNO FROM PD_PREEST_DTL WHERE PREESTNO = '" & strPREESTNO & "' "
                strSQL = strSQL & "    ) DELDATA "
                strSQL = strSQL & ")  AS B "
                strSQL = strSQL & "ON  A.PREESTNO = B.PREESTNO AND A.ITEMCODESEQ = B.ITEMCODESEQ AND A.ITEMCODE = B.ITEMCODE "

                intDel = mobjcePD_PREEST_HDR.SubItemDeleteDo(strSQL)

                Return intRtn
            Catch err As Exception
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_HDR")
            Finally
                mobjcePD_PREEST_HDR.Dispose()
                mobjcePD_PREEST_DTL.Dispose()
                mobjcePD_PREEST_ESTIMATE_HDR.Dispose()
                mobjcePD_PREEST_ESTIMATE_DTL.Dispose()

            End Try
        End With
    End Function
    '============== 가견적 내역 저장 
    Public Function ProcessRtn(ByVal strInfoXML As String, _
                               ByVal vntData As Object, _
                               ByVal strPREESTNO As String) As Integer '데이터 INSERT/UPDATE
        Dim intRtn As Integer
        Dim i, intColCnt, intRows As Integer
        Dim strCODE As String
        Dim strSQL As String
        '확정내역 수정시 외주정산내역 자동업데이트 필요 변수
        Dim lngQTY As Double
        Dim lngPRICE As Double
        Dim lngAMT As Double
        Dim strITEMCODE As String
        Dim intITEMCODESEQ As Integer
        Dim intUpdateRtn As Integer


        SetConfig(strInfoXML)
        With mobjSCGLConfig
            Try

                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                If IsArray(vntData) Then
                    '''사용할 Entity 개체생성(Config 정보를 넘겨생성)
                    mobjcePD_PREEST_DTL = New cePD_PREEST_DTL(mobjSCGLConfig)
                    '''vntData의 컬럼수, 로우수를 변수입력
                    intColCnt = UBound(vntData, 1) : intRows = UBound(vntData, 2)
                    For i = 1 To intRows
                        '인서트
                        If GetElement(vntData, "ITEMCODESEQ", intColCnt, i, NULL_NUM, True) = -999999 Then
                            strCODE = SelectRtn_SEQNO(strPREESTNO)
                            intRtn = InsertRtn(vntData, intColCnt, i, strCODE)
                        Else
                            '업데이트
                            '가견적이 업데이트 될때 정산이 있거나 없거나 자동으로 내역 업데이트 한다.
                            lngQTY = GetElement(vntData, "QTY", intColCnt, i, NULL_NUM, True)
                            lngPRICE = GetElement(vntData, "PRICE", intColCnt, i, NULL_NUM, True)
                            lngAMT = GetElement(vntData, "AMT", intColCnt, i, NULL_NUM, True)
                            strITEMCODE = GetElement(vntData, "ITEMCODE", intColCnt, i)
                            intITEMCODESEQ = GetElement(vntData, "ITEMCODESEQ", intColCnt, i, NULL_NUM, True)
                            'QTY,PRICE,AMT


                            strSQL = "UPDATE PD_EXE_DTL "
                            strSQL = strSQL & " SET QTY = " & lngQTY
                            strSQL = strSQL & " ,PRICE =" & lngPRICE
                            strSQL = strSQL & " ,AMT =" & lngAMT
                            strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "'  AND ITEMCODE = '" & strITEMCODE & "' "
                            strSQL = strSQL & " AND ISNULL(QTY,999999) <> 999999 AND ITEMCODESEQ = " & intITEMCODESEQ


                            intRtn = UpdateRtn(vntData, intColCnt, i)
                            intUpdateRtn = mobjcePD_PREEST_DTL.ExeUpdate(strSQL)
                        End If
                    Next
                End If
                .mobjSCGLSql.SQLCommitTrans()
                Return intRows
            Catch err As Exception
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn")
            Finally
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_PREEST_DTL.Dispose()
            End Try
        End With
    End Function
    '============== 가견적 ITEMCODESEQ 생성
    Public Function SelectRtn_SEQNO(ByVal strPREESTNO As String) As String
        '여기부터 단순조회
        Dim strSQL, strRtn As String
        'SetConfig(strInfoXML) '기본정보 Setting
        Dim strPRECODE As String
        With mobjSCGLConfig '기본정보 Config 개체

            Try

                strSQL = " SELECT ISNULL(MAX(ITEMCODESEQ),0) +1 "
                strSQL = strSQL & " FROM PD_PREEST_DTL WHERE PREESTNO = '" & strPREESTNO & "'"

                strRtn = .mobjSCGLSql.SQLSelectOneScalar(strSQL)
                Return strRtn
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_SEQNO")
            Finally
            End Try
        End With
        '여기까지 단순조회
    End Function

    '============== productioncommi_dtl  SEQ생성
    Public Function SelectRtn_PRODUCTIONCOMMI_SEQNO(ByVal strPREESTNO As String) As String
        '여기부터 단순조회
        Dim strSQL, strFormat, strRtn As String
        'SetConfig(strInfoXML) '기본정보 Setting
        Dim strPRECODE As String
        With mobjSCGLConfig '기본정보 Config 개체

            Try

                strSQL = "SELECT ISNULL(MAX(SEQ),0) +1 FROM PD_PRODUCTIONCOMMI_DTL WHERE PREESTNO = '" & strPREESTNO & "'"
                strRtn = .mobjSCGLSql.SQLSelectOneScalar(strSQL)
                Return strRtn
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_PRODUCTIONCOMMI_SEQNO")
            Finally
            End Try
        End With
        '여기까지 단순조회
    End Function

    '================견적 세부내역 삭제(사용)
    Public Function DeleteRtn(ByVal strInfoXML As String, _
                              ByVal strPREESTNO As String, _
                              ByVal dblITEMCODESEQ As Double, _
                              ByVal strITEMCODE As String, _
                              ByVal strDETAILYNFLAG As String, _
                              ByVal strPRODUCTSUSUCHK As String, _
                              ByVal strJOBNO As String, _
                              ByVal strCHKCONFIRM As String) As Integer

        Dim intRtn As Integer      'Return변수( 처리건수 또는 0 )
        Dim strSQL As String
        Dim strSQLTXT As String
        Dim intDelProRtn As Integer
        Dim intDelRtn As Integer
        Dim intDelProduction As Integer
        Dim strSQLPROD As String
        SetConfig(strInfoXML)    '기본정보 Setting
        With mobjSCGLConfig    '기본정보 Config 개체
            Try
                ' 사용할Entity 개체생성(Config 정보를 넘겨생성)
                mobjcePD_PREEST_DTL = New cePD_PREEST_DTL(mobjSCGLConfig)
                ' DB 접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()

                ' 엔티티 오브젝트의 Delete 메소드 호출
                intRtn = mobjcePD_PREEST_DTL.DeleteDo(strPREESTNO, dblITEMCODESEQ)

                '간접비 항목 삭제 일경우
                If strITEMCODE = "242001" Then
                    strSQL = " DELETE FROM PD_PRODUCTIONCOMMI_DTL WHERE PREESTNO='" & strPREESTNO & "'; "
                    strSQL = strSQL & " DELETE FROM PD_PRODUCTIONCOMMI_HDR WHERE PREESTNO='" & strPREESTNO & "'; "


                    intDelProRtn = mobjcePD_PREEST_DTL.SqlExe(strSQL)
                End If

                If strDETAILYNFLAG = "Y" Then '조건추가: 제작비 수수료가 존재 한다면......
                    'Subitem 삭제
                    strSQLTXT = "DELETE FROM PD_SUBITEM_DTL WHERE PREESTNO = '" & strPREESTNO & "' AND ITEMCODE = '" & strITEMCODE & "' AND ITEMCODESEQ = '" & dblITEMCODESEQ & "' ;"

                    intDelRtn = mobjcePD_PREEST_DTL.SqlExe(strSQLTXT)

                    '견적 헤더 업데이트
                    strSQLPROD = " UPDATE PD_PREEST_HDR "
                    strSQLPROD = strSQLPROD & " SET NONCOMMITION = A.NONCOMMITION,"
                    strSQLPROD = strSQLPROD & " COMMITION=A.COMMITION,"
                    strSQLPROD = strSQLPROD & " SUSUAMT = A.SUSUAMT,"
                    strSQLPROD = strSQLPROD & " AMT = A.NONCOMMITION + A.COMMITION,"
                    strSQLPROD = strSQLPROD & " SUMAMT = A.NONCOMMITION + A.COMMITION + A.SUSUAMT"
                    strSQLPROD = strSQLPROD & " FROM ("
                    strSQLPROD = strSQLPROD & " 	SELECT "
                    strSQLPROD = strSQLPROD & " 	SUM(CASE WHEN COMMIFLAG = '0' THEN ISNULL(AMT,0) ELSE 0 END) NONCOMMITION,"
                    strSQLPROD = strSQLPROD & " 	SUM(CASE WHEN COMMIFLAG = '1' THEN ISNULL(AMT,0) ELSE 0 END) COMMITION,"
                    strSQLPROD = strSQLPROD & " 	SUM(ISNULL(SUSUAMT,0)) SUSUAMT"
                    strSQLPROD = strSQLPROD & " 	FROM PD_PREEST_DTL"
                    strSQLPROD = strSQLPROD & " 	WHERE PREESTNO = '" & strPREESTNO & "' "
                    strSQLPROD = strSQLPROD & " ) A"
                    strSQLPROD = strSQLPROD & " WHERE PREESTNO = '" & strPREESTNO & "' "

                    intDelProduction = mobjcePD_PREEST_DTL.SqlExe(strSQLPROD)
                Else
                    '견적 헤더 업데이트
                    strSQLPROD = " UPDATE PD_PREEST_HDR "
                    strSQLPROD = strSQLPROD & " SET NONCOMMITION = A.NONCOMMITION,"
                    strSQLPROD = strSQLPROD & " COMMITION=A.COMMITION,"
                    strSQLPROD = strSQLPROD & " SUSUAMT = A.SUSUAMT,"
                    strSQLPROD = strSQLPROD & " AMT = A.NONCOMMITION + A.COMMITION,"
                    strSQLPROD = strSQLPROD & " SUMAMT = A.NONCOMMITION + A.COMMITION + A.SUSUAMT"
                    strSQLPROD = strSQLPROD & " FROM ("
                    strSQLPROD = strSQLPROD & " 	SELECT "
                    strSQLPROD = strSQLPROD & " 	SUM(CASE WHEN COMMIFLAG = '0' THEN ISNULL(AMT,0) ELSE 0 END) NONCOMMITION,"
                    strSQLPROD = strSQLPROD & " 	SUM(CASE WHEN COMMIFLAG = '1' THEN ISNULL(AMT,0) ELSE 0 END) COMMITION,"
                    strSQLPROD = strSQLPROD & " 	SUM(ISNULL(SUSUAMT,0)) SUSUAMT"
                    strSQLPROD = strSQLPROD & " 	FROM PD_PREEST_DTL"
                    strSQLPROD = strSQLPROD & " 	WHERE PREESTNO = '" & strPREESTNO & "' "
                    strSQLPROD = strSQLPROD & " ) A"
                    strSQLPROD = strSQLPROD & " WHERE PREESTNO = '" & strPREESTNO & "' "

                    intDelProduction = mobjcePD_PREEST_DTL.SqlExe(strSQLPROD)
                End If

                If strPRODUCTSUSUCHK = "T" Then    '[간접비가 있다면 간접비에도 영향을 줘야 한다.
                    '간접비 세부 항목 삭제
                    strSQLPROD = " DELETE FROM PD_PRODUCTIONCOMMI_DTL "
                    strSQLPROD = strSQLPROD & " WHERE PREESTNO = '" & strPREESTNO & "' AND ITEMCODE = '" & strITEMCODE & "' "
                    strSQLPROD = strSQLPROD & " AND ITEMCODESEQ =" & dblITEMCODESEQ & "; "

                    '간접비 헤더 내역 업데이트
                    strSQLPROD = strSQLPROD & " UPDATE PD_PRODUCTIONCOMMI_HDR "
                    strSQLPROD = strSQLPROD & " SET AMT = "
                    strSQLPROD = strSQLPROD & "( "
                    strSQLPROD = strSQLPROD & "     SELECT  "
                    strSQLPROD = strSQLPROD & "     FLOOR(A.COMMIRATE* B.SUMAMT*0.01) "
                    strSQLPROD = strSQLPROD & "     FROM "
                    strSQLPROD = strSQLPROD & "     ( "
                    strSQLPROD = strSQLPROD & "         SELECT PREESTNO,COMMIRATE "
                    strSQLPROD = strSQLPROD & "         FROM PD_PRODUCTIONCOMMI_HDR "
                    strSQLPROD = strSQLPROD & "         WHERE PREESTNO = '" & strPREESTNO & "' "
                    strSQLPROD = strSQLPROD & "     ) A, "
                    strSQLPROD = strSQLPROD & "     ( "
                    strSQLPROD = strSQLPROD & "         SELECT PREESTNO,SUM(AMT) SUMAMT "
                    strSQLPROD = strSQLPROD & "         FROM PD_PRODUCTIONCOMMI_DTL "
                    strSQLPROD = strSQLPROD & "         WHERE PREESTNO = '" & strPREESTNO & "' "
                    strSQLPROD = strSQLPROD & "         AND CHK ='1' GROUP BY PREESTNO "
                    strSQLPROD = strSQLPROD & "     ) B "
                    strSQLPROD = strSQLPROD & "     WHERE A.PREESTNO = B.PREESTNO "
                    strSQLPROD = strSQLPROD & ") "
                    strSQLPROD = strSQLPROD & "WHERE PD_PRODUCTIONCOMMI_HDR.PREESTNO = '" & strPREESTNO & "'; "

                    '견적 상세 업데이트
                    strSQLPROD = strSQLPROD & " UPDATE C"
                    strSQLPROD = strSQLPROD & " SET "
                    strSQLPROD = strSQLPROD & " C.AMT = FLOOR(CASE B.CONFIRMGBN WHEN 'T' THEN A.EXEAMT ELSE A.AMT END),"
                    strSQLPROD = strSQLPROD & " C.PRICE = FLOOR(CASE B.CONFIRMGBN WHEN 'T' THEN A.EXEAMT ELSE A.AMT END),"
                    strSQLPROD = strSQLPROD & " C.SUSUAMT = FLOOR(CASE B.CONFIRMGBN WHEN 'T' THEN A.EXEAMT ELSE A.AMT END * B.SUSURATE/100)"
                    strSQLPROD = strSQLPROD & " FROM PD_PREEST_DTL C, PD_PRODUCTIONCOMMI_HDR A, PD_PREEST_HDR B"
                    strSQLPROD = strSQLPROD & " WHERE C.PREESTNO = B.PREESTNO"
                    strSQLPROD = strSQLPROD & " AND A.PREESTNO = B.PREESTNO"
                    strSQLPROD = strSQLPROD & " AND C.PREESTNO = '" & strPREESTNO & "'"
                    strSQLPROD = strSQLPROD & " AND C.ITEMCODE = '242001';"

                    '견적 헤더 업데이트
                    strSQLPROD = strSQLPROD & " UPDATE PD_PREEST_HDR "
                    strSQLPROD = strSQLPROD & " SET NONCOMMITION = A.NONCOMMITION,"
                    strSQLPROD = strSQLPROD & " COMMITION=A.COMMITION,"
                    strSQLPROD = strSQLPROD & " SUSUAMT = A.SUSUAMT,"
                    strSQLPROD = strSQLPROD & " AMT = A.NONCOMMITION + A.COMMITION,"
                    strSQLPROD = strSQLPROD & " SUMAMT = A.NONCOMMITION + A.COMMITION + A.SUSUAMT"
                    strSQLPROD = strSQLPROD & " FROM ("
                    strSQLPROD = strSQLPROD & " 	SELECT "
                    strSQLPROD = strSQLPROD & " 	SUM(CASE WHEN COMMIFLAG = '0' THEN ISNULL(AMT,0) ELSE 0 END) NONCOMMITION,"
                    strSQLPROD = strSQLPROD & " 	SUM(CASE WHEN COMMIFLAG = '1' THEN ISNULL(AMT,0) ELSE 0 END) COMMITION,"
                    strSQLPROD = strSQLPROD & " 	SUM(ISNULL(SUSUAMT,0)) SUSUAMT"
                    strSQLPROD = strSQLPROD & " 	FROM PD_PREEST_DTL"
                    strSQLPROD = strSQLPROD & " 	WHERE PREESTNO = '" & strPREESTNO & "' "
                    strSQLPROD = strSQLPROD & " ) A"
                    strSQLPROD = strSQLPROD & " WHERE PREESTNO = '" & strPREESTNO & "'; "

                    '간접비에 저장된 상세견적은 간접비 상세의 견적과 정렬구분을 통일한다.
                    strSQLPROD = strSQLPROD & " UPDATE A"
                    strSQLPROD = strSQLPROD & " SET A.ATTR06 = B.PRINT_SEQ"
                    strSQLPROD = strSQLPROD & " FROM PD_PRODUCTIONCOMMI_DTL A, PD_PREEST_DTL B"
                    strSQLPROD = strSQLPROD & " WHERE A.PREESTNO = B.PREESTNO"
                    strSQLPROD = strSQLPROD & " AND A.ITEMCODE = B.ITEMCODE"
                    strSQLPROD = strSQLPROD & " AND A.ITEMCODESEQ = B.ITEMCODESEQ"
                    strSQLPROD = strSQLPROD & " AND A.PREESTNO = '" & strPREESTNO & "';"

                    intDelProduction = mobjcePD_PREEST_DTL.SqlExe(strSQLPROD)

                Else
                    '견적 헤더 업데이트
                    strSQLPROD = " UPDATE PD_PREEST_HDR "
                    strSQLPROD = strSQLPROD & " SET NONCOMMITION = A.NONCOMMITION,"
                    strSQLPROD = strSQLPROD & " COMMITION=A.COMMITION,"
                    strSQLPROD = strSQLPROD & " SUSUAMT = A.SUSUAMT,"
                    strSQLPROD = strSQLPROD & " AMT = A.NONCOMMITION + A.COMMITION,"
                    strSQLPROD = strSQLPROD & " SUMAMT = A.NONCOMMITION + A.COMMITION + A.SUSUAMT"
                    strSQLPROD = strSQLPROD & " FROM ("
                    strSQLPROD = strSQLPROD & " 	SELECT "
                    strSQLPROD = strSQLPROD & " 	SUM(CASE WHEN COMMIFLAG = '0' THEN ISNULL(AMT,0) ELSE 0 END) NONCOMMITION,"
                    strSQLPROD = strSQLPROD & " 	SUM(CASE WHEN COMMIFLAG = '1' THEN ISNULL(AMT,0) ELSE 0 END) COMMITION,"
                    strSQLPROD = strSQLPROD & " 	SUM(ISNULL(SUSUAMT,0)) SUSUAMT"
                    strSQLPROD = strSQLPROD & " 	FROM PD_PREEST_DTL"
                    strSQLPROD = strSQLPROD & " 	WHERE PREESTNO = '" & strPREESTNO & "' "
                    strSQLPROD = strSQLPROD & " ) A"
                    strSQLPROD = strSQLPROD & " WHERE PREESTNO = '" & strPREESTNO & "' "

                    intDelProduction = mobjcePD_PREEST_DTL.SqlExe(strSQLPROD)
                End If

                intRtn = ProcessRtn_DIVAMT(strJOBNO, strPREESTNO, strCHKCONFIRM)

                ' 트랜잭션 Commit
                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션 RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & "DeleteRtn")
            Finally
                'DB접속 종료
                .mobjSCGLSql.SQLDisconnect()
                '사용한 Entity(개체Dispose)
                mobjcePD_PREEST_DTL.Dispose()
            End Try
        End With
    End Function
    '================견적 세부내역 삭제(사용)
    Public Function DeleteRtn_TempDel(ByVal strInfoXML As String, _
                                      ByVal strPREESTNO As String, _
                                      ByVal dblITEMCODESEQ As Double, _
                                      ByVal strITEMCODE As String, _
                                      ByVal strDETAILYNFLAG As String) As Integer
        'PREESTNO,ITEMCODESEQ
        Dim intRtn As Integer      'Return변수( 처리건수 또는 0 )
        Dim strSQL As String
        Dim strSQLTXT As String
        Dim intDelProRtn As Integer
        Dim intDelRtn As Integer
        SetConfig(strInfoXML)    '기본정보 Setting
        With mobjSCGLConfig    '기본정보 Config 개체
            Try
                ' 사용할Entity 개체생성(Config 정보를 넘겨생성)
                mobjcePD_PREEST_DTL = New cePD_PREEST_DTL(mobjSCGLConfig)
                ' DB 접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                ' 엔티티 오브젝트의 Delete 메소드 호출
                intRtn = mobjcePD_PREEST_DTL.DeleteDo(strPREESTNO, dblITEMCODESEQ)
                '간접비 항목 삭제 일경우
                If strITEMCODE = "242001" Then

                    strSQL = " DELETE FROM PD_PRODUCTIONCOMMI_INPUT "
                    strSQL = strSQL & " WHERE PREESTNO='" & strPREESTNO & "'; "

                    strSQL = strSQL & " DELETE FROM PD_PRODUCTIONCOMMI_HDRINPUT "
                    strSQL = strSQL & " WHERE PREESTNO='" & strPREESTNO & "' "

                    intDelProRtn = mobjcePD_PREEST_DTL.SqlExe(strSQL)
                End If
                '상세부문 내역 삭제일 경우
                If strDETAILYNFLAG = "Y" And strITEMCODE <> "242001" Then

                    strSQLTXT = "DELETE FROM PD_SUBITEM_INPUT "
                    strSQLTXT = strSQLTXT & " WHERE PREESTNO = '" & strPREESTNO & "' "
                    strSQLTXT = strSQLTXT & " AND ITEMCODE = '" & strITEMCODE & "' "
                    strSQLTXT = strSQLTXT & " AND ITEMCODESEQ = '" & dblITEMCODESEQ & "'; "

                    intDelRtn = mobjcePD_PREEST_DTL.SqlExe(strSQLTXT)
                End If
                ' 트랜잭션 Commit
                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션 RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & "DeleteRtn_TempDel")
            Finally
                'DB접속 종료
                .mobjSCGLSql.SQLDisconnect()
                '사용한 Entity(개체Dispose)
                mobjcePD_PREEST_DTL.Dispose()
            End Try
        End With
    End Function

    Public Function DeleteRtn_Check(ByVal strInfoXML As String, _
                                    ByRef intRowCnt As Integer, _
                                    ByRef intColCnt As Integer, _
                                    ByVal strJOBNO As String) As Object     'XML  데이터 조회시

        Dim strSQL As String
        Dim strFormat, strSelFields, strWhere As String
        Dim Con1, Con2 As String
        Dim vntData As Object
        Dim strField

        With mobjSCGLConfig
            Try
                SetConfig(strInfoXML)   '기본정보 설정

                Con1 = ""
                Con2 = ""

                If strJOBNO <> "" Then Con1 = String.Format(" AND (JOBNO = '{0}')", strJOBNO)

                strWhere = BuildFields(" ", Con1)

                strFormat = strFormat & "  SELECT "
                strFormat = strFormat & "  TRANSYEARMON,"
                strFormat = strFormat & "  TRANSNO"
                strFormat = strFormat & "  FROM PD_DIVAMT"
                strFormat = strFormat & "  WHERE 1=1 {0} "
                strFormat = strFormat & "  AND ISNULL(CONFIRMFLAG, '0') >= '3' "

                '거래명세서 생성시 청구지만 매니저승인 CONFIRMFLAG >= 3  인것이 지워지면 안됨.

                'strFormat = strFormat & "  AND ISNULL(TRANSYEARMON, '') <> ''"
                'strFormat = strFormat & "  AND ISNULL(CAST(TRANSNO AS VARCHAR(10)), '') <> ''"

                strSQL = String.Format(strFormat, strWhere)

                .mobjSCGLSql.SQLConnect(.DBConnStr)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt)
                Return vntData
            Catch err As Exception
                Throw RaiseSysErr(err, CLASS_NAME & ".DeleteRtn_Check")
            Finally
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function




    ' =============== 가견적 확정여부 조회
    Public Function SelectRtn_Confirm(ByVal strInfoXML As String, _
                                      ByRef intRowCnt As Integer, _
                                      ByRef intColCnt As Integer, _
                                      ByVal strPREESTNO As String, _
                                      ByVal strJOBNO As String) As Object

        Dim strCols As String         '컬럼변수
        Dim strWhere As String       'Where조건 변수
        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim strXMLData As String    'XML  Return 변수(XML  을 사용할 때 선언)
        Dim Con1 As String

        strCols = "JOBNO"



        'If strPREESTNO <> "" Then Con1 = String.Format(" AND (PREESTNO = '{0}')", strPREESTNO)
        If strJOBNO <> "" Then Con1 = String.Format(" AND (JOBNO = '{0}')", strJOBNO)
        strWhere = BuildFields(" ", Con1)

        strFormat = "SELECT {0} FROM PD_JOBNO WHERE PREESTNO = '" & strPREESTNO & "'  AND ISNULL(PREESTNO ,'') <>'' {1} "

        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보 Config 개체
            strSQL = String.Format(strFormat, strCols, strWhere)
            Try
                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                ' ------ Array 데이터 조회 (True 일때 헤더정보 포함 조회(Sheet Data Binding 할 경우 사용), False 일때 데이터만 조회)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return vntData

            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_Confirm")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    ' ============== 본견적으로 저장 - Type1. 가견적이 본견적으로 변경되는 경우....(사용)
    Public Function ProcessRtn_Confirm(ByVal strInfoXML As String, _
                                       ByVal vntData As Object, _
                                       ByVal strPREESTNO As String, _
                                       ByVal strJOBNO As String, _
                                       ByVal strAGREEDAY As String, _
                                       ByVal strPRODUCTIONCHK As String) As Integer '데이터 INSERT/UPDATE
        Dim intRtn As Integer '결과값 변수
        Dim i, intColCnt, intRows As Integer '루프, 컬럼Cnt, 로우Cnt 변수
        Dim strSQL As String
        Dim strAGREEYEARMON As String
        Dim intCnt As Integer
        Dim strDIVAMTSQL As String
        Dim intDIVAMTRtn As Integer
        Dim strUSER As String
        Dim strDATE As String


        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보를 가지고 있는 Config 개체
            Try
                strUSER = .WRKUSR
                strDATE = Now

                mobjcePD_PREEST_DTL = New cePD_PREEST_DTL(mobjSCGLConfig)
                'DB접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                'Master 데이터 처리

                '저장이 되어있지 않은 데이터가 있을 수 있기 때문에 저장을 한번더 태운다....
                If IsArray(vntData) Then
                    intRtn = ProcessRtn_DETAIL_ONE(vntData, strPREESTNO, strPRODUCTIONCHK, strJOBNO)
                End If

                strSQL = strSQL & " UPDATE PD_JOBNO "
                strSQL = strSQL & " SET PREESTNO = '" & strPREESTNO & "',AGREEYEARMON =  '" & strAGREEDAY & "' "
                strSQL = strSQL & " WHERE JOBNO = '" & strJOBNO & "'; "

                strSQL = strSQL & " UPDATE PD_PREEST_HDR "
                strSQL = strSQL & " SET CONFIRMGBN = 'T' ,UUSER = '" & strUSER & "',UDATE = '" & strDATE & "' "
                strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "' "
                strSQL = strSQL & " AND JOBNO = '" & strJOBNO & "'; "

                strSQL = strSQL & " UPDATE PD_SUBITEM_DTL "
                strSQL = strSQL & " SET CONFIRMGBN = 'T' "
                strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "'; "

                '본견적이 되는순간 실행견적으로보고 가견적을 따로 저장해 놓는다. [PD_PREEST_ESTIMATE에 같은잡이 있다면 다 지우고 다시 INSERT]
                'DTL은 PREEST_HDR 의 JOB을 조회해서 PREESTNO를 GROUPBY 해서 다 삭제 하여야 한다. 그래야 헤더삭제할때처럼 같은 잡의 견적 모두 삭제.

                strSQL = strSQL & " DELETE FROM PD_PREEST_ESTIMATE_HDR "
                strSQL = strSQL & " WHERE JOBNO = '" & strJOBNO & "'; "

                strSQL = strSQL & " DELETE FROM PD_PREEST_ESTIMATE_DTL "
                strSQL = strSQL & " WHERE PREESTNO IN "
                strSQL = strSQL & " ( "
                strSQL = strSQL & "     SELECT PREESTNO "
                strSQL = strSQL & "     FROM PD_PREEST_HDR "
                strSQL = strSQL & "     WHERE JOBNO = '" & strJOBNO & "' "
                strSQL = strSQL & "     GROUP BY PREESTNO   "
                strSQL = strSQL & " );"

                strSQL = strSQL & " INSERT INTO PD_PREEST_ESTIMATE_HDR "
                strSQL = strSQL & " SELECT * FROM PD_PREEST_HDR "
                strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "' "
                strSQL = strSQL & " AND JOBNO = '" & strJOBNO & "'; "

                strSQL = strSQL & " INSERT INTO PD_PREEST_ESTIMATE_DTL "
                strSQL = strSQL & " SELECT * FROM PD_PREEST_DTL "
                strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "';"


                '예상 로직 1
                '****실행견적으로 생각해야하는 PD_PREEST_HDR의 금액은 상세내역이 있는건이면 [이동]버튼을 누른효과를 줘서 PD_PREEST_HDR의 금액과 실행금액을 맞춰준다.
                strSQL = strSQL & " UPDATE PD_SUBITEM_DTL "
                strSQL = strSQL & " SET PRINT_SEQ_OLD = PRINT_SEQ, EXEPRICE=PRICE, EXEQTY=QTY,  EXETERM=TERM, EXEAMT=AMT, EXEMEMO=MEMO "
                strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "'; "

                strSQL = strSQL & " UPDATE PD_PRODUCTIONCOMMI_HDR "
                strSQL = strSQL & " SET EXEAMT=AMT, EXECOMMIRATE=COMMIRATE "
                strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "'; "

                strSQL = strSQL & " UPDATE PD_PRODUCTIONCOMMI_DTL "
                strSQL = strSQL & " SET EXEAMT=AMT, EXECHK=CHK "
                strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "'; "

                '예상 로직 2
                '******가견적 백업본을 받았으니 실행견적으로 생각해야하는 PD_PREEST_HDR견적금액은 아직들어가지않은 실행금액이므로 0으로 업데이트 해줘야 한다.
                'strSQL = strSQL & " UPDATE PD_PREEST_HDR SET AMT=0,SUSUAMT=0,SUSURATE=0,SUMAMT=0, COMMITION=0,NONCOMMITION=0 WHERE PREESTNO = '" & strPREESTNO & "' AND JOBNO = '" & strJOBNO & "';"

                intRtn = mobjcePD_PREEST_DTL.UpdateDo_Confirm(strSQL)

                '선행처리: 기존의 미청구요청내역 저장분을 삭제처리....
                '기존의 DIVAMT 의 내역을 지우고, 다시 투입 하게 되는데, 분할되지 않은 1번 대표좝으로 Insert 한다.
                strDIVAMTSQL = " DELETE FROM PD_DEMAND_DTL WHERE JOBNO ='" & strJOBNO & "'; "
                strDIVAMTSQL = strDIVAMTSQL & " DELETE FROM PD_DEMAND_MST WHERE JOBNO ='" & strJOBNO & "'; "
                strDIVAMTSQL = strDIVAMTSQL & " DELETE FROM PD_DIVAMT WHERE JOBNO ='" & strJOBNO & "'; "

                'DIVAMT 에 INSERT
                strDIVAMTSQL = strDIVAMTSQL & " INSERT INTO PD_DIVAMT (PREESTNO,SEQ,JOBNO,YEARMON,CONFIRMFLAG,CLIENTCODE,TIMCODE, "
                strDIVAMTSQL = strDIVAMTSQL & " DIVAMT,ADJAMT,JOBNAME,UUSER,UDATE,SUBSEQ,CREDAY,ENDFLAG) "

                strDIVAMTSQL = strDIVAMTSQL & " SELECT PREESTNO,1 SEQ,JOBNO,SUBSTRING(CONFIRMFLAG,1,6) YEARMON, "
                strDIVAMTSQL = strDIVAMTSQL & " '1' CONFIRMFLAG,CLIENTCODE,TIMCODE,SUMAMT DIVAMT,0 ADJAMT, "
                strDIVAMTSQL = strDIVAMTSQL & " DBO.PD_JOBNAME_FUN(JOBNO) JOBNAME,'" & strUSER & "' UUSER, "
                strDIVAMTSQL = strDIVAMTSQL & " '" & strDATE & "' UDATE,SUBSEQ,CONFIRMFLAG,'PF02' ENDFLAG "
                strDIVAMTSQL = strDIVAMTSQL & " FROM PD_PREEST_HDR "
                strDIVAMTSQL = strDIVAMTSQL & " WHERE PREESTNO = '" & strPREESTNO & "' "

                intDIVAMTRtn = mobjcePD_PREEST_DTL.Batch_Insert(strDIVAMTSQL)
                'End If


                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_Confirm")
            Finally
                'Resource해제
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_PREEST_DTL.Dispose()
            End Try
        End With
    End Function

    ' ============== 가견적 확정취소
    Public Function ProcessRtn_ConfirmCancel(ByVal strInfoXML As String, _
                                             ByVal strPREESTNO As String, _
                                             ByVal strJOBNO As String) As Integer '데이터 INSERT/UPDATE
        Dim intRtn As Integer '결과값 변수
        Dim strSQL As String
        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보를 가지고 있는 Config 개체
            Try

                mobjcePD_PREEST_DTL = New cePD_PREEST_DTL(mobjSCGLConfig)
                'DB접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                'Master 데이터 처리
                strSQL = " UPDATE PD_JOBNO "
                strSQL = strSQL & " SET PREESTNO = '',AGREEYEARMON = '' "
                strSQL = strSQL & " WHERE JOBNO = '" & strJOBNO & "'; "

                strSQL = strSQL & " UPDATE PD_PREEST_HDR "
                strSQL = strSQL & " SET CONFIRMFLAG = '' "
                strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "'; "

                strSQL = strSQL & " DELETE FROM PD_DIVAMT "
                strSQL = strSQL & " WHERE JOBNO = '" & strJOBNO & "' "
                strSQL = strSQL & " AND PREESTNO = '" & strPREESTNO & "' "

                intRtn = mobjcePD_PREEST_DTL.UpdateDo_ConfirmCancel(strSQL)

                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_ConfirmCancel")
            Finally
                'Resource해제
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_PREEST_DTL.Dispose()
            End Try
        End With
    End Function

    ' ============== Copy견적 헤더 저장(사용)
    Public Function ProcessRtn_HDRLESS(ByVal strInfoXML As String, _
                                       ByVal strMasterXML As String, _
                                       ByVal vntData As Object, _
                                       ByRef strPREESTNO As String, _
                                       ByVal strAGREEYEARMON As String) As Integer
        Dim intRtn As Integer '결과값 변수
        Dim i, intColCnt, intRows As Integer '루프, 컬럼Cnt, 로우Cnt 변수
        Dim strJOBNO

        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보를 가지고 있는 Config 개체
            Try
                'XML Element 변수 선언 (strMasterXML을 변환)
                Dim xmlRoot As XmlElement
                xmlRoot = XMLGetRoot(strMasterXML) 'XML 데이터

                strJOBNO = XMLGetElement(xmlRoot, "JOBNO")

                'DB접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                'Master 데이터 처리
                strPREESTNO = SelectRtn_ESTSEQNO()

                '견적 헤더 저장
                intRtn = ProcessRtn_FAKEHDR(xmlRoot, strPREESTNO, strAGREEYEARMON)

                'Detail 데이터 처리
                intRtn = ProcessRtn_DETAIL_ONE(vntData, strPREESTNO, "F", strJOBNO)

                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_HDRLESS")
            Finally
                'Resource해제
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    ' ============== Copy 견적 Detail 저장(사용)
    Public Function ProcessRtn_DETAIL_ONE(ByVal vntData As Object, _
                                          ByVal strPREESTNO As String, _
                                          ByVal strPRODUCTIONCHK As String, _
                                          ByVal strJOBNO As String) As Integer

        '헷갈리지 않게 적어놓기
        'PD_PREEST_DTL 에 INSERT 한다.
        '노란행을 확인하여 간접비와 상세내역을 INSERT 한다.

        Dim intRtn As Integer
        Dim i, intColCnt, intRows As Integer
        Dim dblID As Double '자동 ID 를사용할 때만 사용

        Dim dblIMESEQ As Double
        Dim strITEMCODE As String
        Dim dblITEMCODESEQ As Double
        Dim intSave As Integer
        Dim strSQLTXT As String
        Dim strSQL As String
        Dim intSubRtn As Integer
        Dim dblAMT As Double
        Dim dblProdSeq As Double
        Dim strTempSql As String
        Dim intSave_ProdEdit As Integer
        Dim strSQL_prodEdit As String
        Dim intcheck As Integer


        With mobjSCGLConfig
            Try
                If IsArray(vntData) Then
                    '''사용할 Entity 개체생성(Config 정보를 넘겨생성)
                    mobjcePD_PREEST_DTL = New cePD_PREEST_DTL(mobjSCGLConfig)
                    mobjcePD_PREEST_ESTIMATE_DTL = New cePD_PREEST_ESTIMATE_DTL(mobjSCGLConfig)

                    '''vntData의 컬럼수, 로우수를 변수입력
                    intColCnt = UBound(vntData, 1) : intRows = UBound(vntData, 2)
                    '''해당하는Row 만큼 Loop
                    For i = 1 To intRows
                        strITEMCODE = GetElement(vntData, "ITEMCODE", intColCnt, i)
                        dblAMT = GetElement(vntData, "AMT", intColCnt, i, NULL_NUM, True)


                        If GetElement(vntData, "ITEMCODESEQ", intColCnt, i, NULL_NUM, True) = -999999 Then
                            dblID = GetElement(vntData, "IMESEQ", intColCnt, i)
                            'PD_PREEST_DTL  을 여기서 저장
                            intRtn = InsertRtn_LESS(vntData, intColCnt, i, strPREESTNO, dblID)

                            '여기에서 팝업에 다녀온 값을 모두 insert
                            If GetElement(vntData, "SAVEFLAG", intColCnt, i) = "Y" Then
                                '분기처리: SAVEFLAG 가 "Y" 이더라도 견적상세부문 과 프로덕션 간접비 등으로 나뉘어지게 된다.
                                dblIMESEQ = GetElement(vntData, "IMESEQ", intColCnt, i)

                                '상세견적
                                strSQLTXT = " INSERT INTO PD_SUBITEM_DTL "
                                strSQLTXT = strSQLTXT & " SELECT "
                                strSQLTXT = strSQLTXT & " '" & strPREESTNO & "' PREESTNO,SEQ,SUBITEMCODESEQ," & dblID & " ITEMCODESEQ,ITEMCODE,"
                                strSQLTXT = strSQLTXT & " IMESEQ,PRINT_SEQ,PRINT_SEQ,SORTSEQ,PRICE,QTY,TERM,AMT,MEMO,EXEPRICE, "
                                strSQLTXT = strSQLTXT & " EXEQTY,EXETERM,EXEAMT,EXEMEMO,CONFIRMGBN,SUBITEMNAME, "
                                strSQLTXT = strSQLTXT & " ATTR01,ATTR02,ATTR03,ATTR04,ATTR05,ATTR06,ATTR07,ATTR08,ATTR09,ATTR10,CUSER,CDATE,UUSER,UDATE"
                                strSQLTXT = strSQLTXT & " FROM PD_SUBITEM_INPUT "
                                strSQLTXT = strSQLTXT & " WHERE ATTR01 = '" & strJOBNO & "'"
                                strSQLTXT = strSQLTXT & " AND  ITEMCODE = '" & strITEMCODE & "' AND ITEMCODESEQ =" & dblIMESEQ & "; "

                                '간접비 수정(입력시 간접비에도 투입) 단,, 간접비내역이 존재한다면,,
                                dblProdSeq = SelectRtn_PRODUCTIONCOMMI_SEQNO(strPREESTNO)
                                '간접비
                                If strPRODUCTIONCHK = "T" Then
                                    If strITEMCODE = "242001" Then
                                        '간접비가 변경이 되었다면 INSERT
                                        strSQL = " INSERT INTO PD_PRODUCTIONCOMMI_HDR "
                                        strSQL = strSQL & " (PREESTNO,AMT,COMMIRATE,EXEAMT,EXECOMMIRATE,MEMO,CUSER,CDATE,UUSER,UDATE)"

                                        strSQL = strSQL & " SELECT '" & strPREESTNO & "' PREESTNO,AMT,COMMIRATE,ISNULL(EXEAMT,0) EXEAMT, "
                                        strSQL = strSQL & " ISNULL(EXECOMMIRATE,0) EXECOMMIRATE,MEMO,CUSER,CDATE,UUSER,UDATE  "
                                        strSQL = strSQL & " FROM PD_PRODUCTIONCOMMI_HDRINPUT "
                                        strSQL = strSQL & " WHERE PREESTNO in ('" & strPREESTNO & "','9999999999'); "

                                        strSQL = strSQL & " INSERT INTO PD_PRODUCTIONCOMMI_DTL "
                                        strSQL = strSQL & " (PREESTNO,SEQ,ITEMCODESEQ,ITEMCODE,AMT,CHK,EXEAMT,EXECHK,ATTR06,CUSER,CDATE,UUSER,UDATE) "

                                        strSQL = strSQL & " SELECT '" & strPREESTNO & "' PREESTNO,SEQ,ITEMCODESEQ,ITEMCODE,AMT,CHK, "
                                        strSQL = strSQL & " isnull(EXEAMT,0) EXEAMT,EXECHK,ATTR06,CUSER,CDATE,UUSER,UDATE "
                                        strSQL = strSQL & " FROM PD_PRODUCTIONCOMMI_INPUT "
                                        strSQL = strSQL & " WHERE PREESTNO in ('" & strPREESTNO & "','9999999999'); "

                                        intSave = mobjcePD_PREEST_DTL.PromotionCommi(strSQL)
                                    Else '간접비가 있는 상황에서 신규추가한 preest_dtl 내역의 데이터가 있는경우 insert 해줘야 함.20110928_SH 해더는 아래 재계산

                                        strSQL = " INSERT INTO PD_PRODUCTIONCOMMI_DTL "
                                        strSQL = strSQL & " (PREESTNO,SEQ,ITEMCODESEQ,ITEMCODE,AMT,CHK,EXEAMT,EXECHK,ATTR06,CUSER,CDATE,UUSER,UDATE) "

                                        strSQL = strSQL & " SELECT PREESTNO,'" & dblProdSeq & "' SEQ,IMESEQ ITEMCODESEQ,ITEMCODE,"
                                        strSQL = strSQL & " CASE DBO.PD_PREESTCONFIRMFLAG_FUN(PREESTNO) WHEN 'T' THEN 0 ELSE AMT END AMT,"
                                        strSQL = strSQL & " 0 CHK,"
                                        strSQL = strSQL & " CASE DBO.PD_PREESTCONFIRMFLAG_FUN(PREESTNO) WHEN 'T' THEN AMT ELSE 0 END EXEAMT,"
                                        strSQL = strSQL & " 0 EXECHK,PRINT_SEQ,"
                                        strSQL = strSQL & " CUSER,CDATE,UUSER,UDATE"
                                        strSQL = strSQL & " FROM PD_PREEST_DTL"
                                        strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "'"
                                        strSQL = strSQL & " AND ITEMCODE = '" & strITEMCODE & "'"
                                        strSQL = strSQL & " AND ITEMCODESEQ = " & dblIMESEQ & "; "

                                        '간접비에 저장된 상세견적은 간접비 상세의 견적과 정렬구분을 통일한다.
                                        strSQL = strSQL & " UPDATE A"
                                        strSQL = strSQL & " SET A.ATTR06 = B.PRINT_SEQ"
                                        strSQL = strSQL & " FROM PD_PRODUCTIONCOMMI_DTL A, PD_PREEST_DTL B"
                                        strSQL = strSQL & " WHERE A.PREESTNO = B.PREESTNO"
                                        strSQL = strSQL & " AND A.ITEMCODE = B.ITEMCODE"
                                        strSQL = strSQL & " AND A.ITEMCODESEQ = B.ITEMCODESEQ"
                                        strSQL = strSQL & " AND A.PREESTNO = '" & strPREESTNO & "';"

                                        intSave = mobjcePD_PREEST_DTL.PromotionCommi(strSQL)
                                    End If

                                    '간접비 헤더 내역 업데이트
                                    strSQLTXT = strSQLTXT & " UPDATE PD_PRODUCTIONCOMMI_HDR "
                                    strSQLTXT = strSQLTXT & " SET AMT =  "
                                    strSQLTXT = strSQLTXT & "( "
                                    strSQLTXT = strSQLTXT & "   SELECT  "
                                    strSQLTXT = strSQLTXT & "   FLOOR(A.COMMIRATE* B.SUMAMT*0.01) "
                                    strSQLTXT = strSQLTXT & "   FROM "
                                    strSQLTXT = strSQLTXT & "       ( "
                                    strSQLTXT = strSQLTXT & "           SELECT PREESTNO,COMMIRATE "
                                    strSQLTXT = strSQLTXT & "           FROM PD_PRODUCTIONCOMMI_HDR "
                                    strSQLTXT = strSQLTXT & "           WHERE PREESTNO = '" & strPREESTNO & "' "
                                    strSQLTXT = strSQLTXT & "       ) A, "
                                    strSQLTXT = strSQLTXT & "       ( "
                                    strSQLTXT = strSQLTXT & "           SELECT PREESTNO,SUM(AMT) SUMAMT "
                                    strSQLTXT = strSQLTXT & "           FROM PD_PRODUCTIONCOMMI_DTL WHERE PREESTNO = '" & strPREESTNO & "'  "
                                    strSQLTXT = strSQLTXT & "           AND  ISNULL(CHK,'0') = '1' "
                                    strSQLTXT = strSQLTXT & "            GROUP BY PREESTNO "
                                    strSQLTXT = strSQLTXT & "       ) B "
                                    strSQLTXT = strSQLTXT & "       WHERE A.PREESTNO = B.PREESTNO "
                                    strSQLTXT = strSQLTXT & ") "
                                    strSQLTXT = strSQLTXT & "WHERE PD_PRODUCTIONCOMMI_HDR.PREESTNO = '" & strPREESTNO & "'; "

                                    '간접비 견적상세 내역 수정
                                    strSQLTXT = strSQLTXT & " UPDATE C"
                                    strSQLTXT = strSQLTXT & " SET "
                                    strSQLTXT = strSQLTXT & " C.AMT = FLOOR(CASE B.CONFIRMGBN WHEN 'T' THEN A.EXEAMT ELSE A.AMT END),"
                                    strSQLTXT = strSQLTXT & " C.PRICE = FLOOR(CASE B.CONFIRMGBN WHEN 'T' THEN A.EXEAMT ELSE A.AMT END),"
                                    strSQLTXT = strSQLTXT & " C.SUSUAMT = CASE ISNULL(COMMIFLAG,0) WHEN 0 THEN 0 ELSE FLOOR(CASE B.CONFIRMGBN WHEN 'T' THEN A.EXEAMT ELSE A.AMT END * B.SUSURATE/100) END "
                                    strSQLTXT = strSQLTXT & " FROM PD_PREEST_DTL C, PD_PRODUCTIONCOMMI_HDR A, PD_PREEST_HDR B"
                                    strSQLTXT = strSQLTXT & " WHERE C.PREESTNO = B.PREESTNO"
                                    strSQLTXT = strSQLTXT & " AND A.PREESTNO = B.PREESTNO"
                                    strSQLTXT = strSQLTXT & " AND C.PREESTNO = '" & strPREESTNO & "'"
                                    strSQLTXT = strSQLTXT & " AND C.ITEMCODE = '242001';"

                                    strSQLTXT = strSQLTXT & " UPDATE PD_PREEST_HDR "
                                    strSQLTXT = strSQLTXT & " SET NONCOMMITION = A.NONCOMMITION,"
                                    strSQLTXT = strSQLTXT & " COMMITION=A.COMMITION,"
                                    strSQLTXT = strSQLTXT & " SUSUAMT = A.SUSUAMT,"
                                    strSQLTXT = strSQLTXT & " AMT = A.NONCOMMITION + A.COMMITION,"
                                    strSQLTXT = strSQLTXT & " SUMAMT = A.NONCOMMITION + A.COMMITION + A.SUSUAMT"
                                    strSQLTXT = strSQLTXT & " FROM ("
                                    strSQLTXT = strSQLTXT & " 	SELECT "
                                    strSQLTXT = strSQLTXT & " 	SUM(CASE WHEN COMMIFLAG = '0' THEN ISNULL(AMT,0) ELSE 0 END) NONCOMMITION,"
                                    strSQLTXT = strSQLTXT & " 	SUM(CASE WHEN COMMIFLAG = '1' THEN ISNULL(AMT,0) ELSE 0 END) COMMITION,"
                                    strSQLTXT = strSQLTXT & " 	SUM(ISNULL(SUSUAMT,0)) SUSUAMT"
                                    strSQLTXT = strSQLTXT & " 	FROM PD_PREEST_DTL"
                                    strSQLTXT = strSQLTXT & " 	WHERE PREESTNO = '" & strPREESTNO & "' "
                                    strSQLTXT = strSQLTXT & " ) A"
                                    strSQLTXT = strSQLTXT & " WHERE PREESTNO = '" & strPREESTNO & "' "

                                    intSave = mobjcePD_PREEST_DTL.SubitemInsert(strSQLTXT)
                                Else
                                    strSQLTXT = strSQLTXT & " UPDATE PD_PREEST_HDR "
                                    strSQLTXT = strSQLTXT & " SET NONCOMMITION = A.NONCOMMITION,"
                                    strSQLTXT = strSQLTXT & " COMMITION=A.COMMITION,"
                                    strSQLTXT = strSQLTXT & " SUSUAMT = A.SUSUAMT,"
                                    strSQLTXT = strSQLTXT & " AMT = A.NONCOMMITION + A.COMMITION,"
                                    strSQLTXT = strSQLTXT & " SUMAMT = A.NONCOMMITION + A.COMMITION + A.SUSUAMT"
                                    strSQLTXT = strSQLTXT & " FROM ("
                                    strSQLTXT = strSQLTXT & " 	SELECT "
                                    strSQLTXT = strSQLTXT & " 	SUM(CASE WHEN COMMIFLAG = '0' THEN ISNULL(AMT,0) ELSE 0 END) NONCOMMITION,"
                                    strSQLTXT = strSQLTXT & " 	SUM(CASE WHEN COMMIFLAG = '1' THEN ISNULL(AMT,0) ELSE 0 END) COMMITION,"
                                    strSQLTXT = strSQLTXT & " 	SUM(ISNULL(SUSUAMT,0)) SUSUAMT"
                                    strSQLTXT = strSQLTXT & " 	FROM PD_PREEST_DTL"
                                    strSQLTXT = strSQLTXT & " 	WHERE PREESTNO = '" & strPREESTNO & "' "
                                    strSQLTXT = strSQLTXT & " ) A"
                                    strSQLTXT = strSQLTXT & " WHERE PREESTNO = '" & strPREESTNO & "' "

                                    intSave = mobjcePD_PREEST_DTL.SubitemInsert(strSQLTXT)
                                End If ' 간접비냐 아니냐
                            Else '견적 헤더 업데이트  
                                '간접비 수정(입력시 간접비에도 투입) 단,, 간접비내역이 존재한다면,,
                                dblProdSeq = SelectRtn_PRODUCTIONCOMMI_SEQNO(strPREESTNO)

                                '[노란행이없어도 견적 추가 하면 간접비가 있다면 추가 되어야 한다._20110928_SH]
                                If strPRODUCTIONCHK = "T" Then
                                    strSQL = strSQL & " INSERT INTO PD_PRODUCTIONCOMMI_DTL "
                                    strSQL = strSQL & " (PREESTNO,SEQ,ITEMCODESEQ,ITEMCODE,AMT,CHK,EXEAMT,EXECHK,ATTR06,CUSER,CDATE,UUSER,UDATE) "

                                    strSQL = strSQL & " SELECT PREESTNO,'" & dblProdSeq & "' SEQ,IMESEQ ITEMCODESEQ,ITEMCODE,"
                                    strSQL = strSQL & " CASE DBO.PD_PREESTCONFIRMFLAG_FUN(PREESTNO) WHEN 'T' THEN 0 ELSE ISNULL(AMT,0) END AMT,"
                                    strSQL = strSQL & " 0 CHK,"
                                    strSQL = strSQL & " CASE DBO.PD_PREESTCONFIRMFLAG_FUN(PREESTNO) WHEN 'T' THEN ISNULL(AMT,0) ELSE 0 END EXEAMT,"
                                    strSQL = strSQL & " 0 EXECHK,PRINT_SEQ,"
                                    strSQL = strSQL & " CUSER,CDATE,UUSER,UDATE"
                                    strSQL = strSQL & " FROM PD_PREEST_DTL"
                                    strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "'"
                                    strSQL = strSQL & " AND ITEMCODE = '" & strITEMCODE & "'"
                                    strSQL = strSQL & " AND ITEMCODESEQ = " & dblID & "; "

                                    '간접비에 저장된 상세견적은 간접비 상세의 견적과 정렬구분을 통일한다.
                                    strSQL = strSQL & " UPDATE A"
                                    strSQL = strSQL & " SET A.ATTR06 = B.PRINT_SEQ"
                                    strSQL = strSQL & " FROM PD_PRODUCTIONCOMMI_DTL A, PD_PREEST_DTL B"
                                    strSQL = strSQL & " WHERE A.PREESTNO = B.PREESTNO"
                                    strSQL = strSQL & " AND A.ITEMCODE = B.ITEMCODE"
                                    strSQL = strSQL & " AND A.ITEMCODESEQ = B.ITEMCODESEQ"
                                    strSQL = strSQL & " AND A.PREESTNO = '" & strPREESTNO & "';"

                                    intSave = mobjcePD_PREEST_DTL.PromotionCommi(strSQL)
                                End If
                                strSQLTXT = strSQLTXT & " UPDATE PD_PREEST_HDR "
                                strSQLTXT = strSQLTXT & " SET NONCOMMITION = A.NONCOMMITION,"
                                strSQLTXT = strSQLTXT & " COMMITION=A.COMMITION,"
                                strSQLTXT = strSQLTXT & " SUSUAMT = A.SUSUAMT,"
                                strSQLTXT = strSQLTXT & " AMT = A.NONCOMMITION + A.COMMITION,"
                                strSQLTXT = strSQLTXT & " SUMAMT = A.NONCOMMITION + A.COMMITION + A.SUSUAMT"
                                strSQLTXT = strSQLTXT & " FROM ("
                                strSQLTXT = strSQLTXT & " 	SELECT "
                                strSQLTXT = strSQLTXT & " 	SUM(CASE WHEN COMMIFLAG = '0' THEN ISNULL(AMT,0) ELSE 0 END) NONCOMMITION,"
                                strSQLTXT = strSQLTXT & " 	SUM(CASE WHEN COMMIFLAG = '1' THEN ISNULL(AMT,0) ELSE 0 END) COMMITION,"
                                strSQLTXT = strSQLTXT & " 	SUM(ISNULL(SUSUAMT,0)) SUSUAMT"
                                strSQLTXT = strSQLTXT & " 	FROM PD_PREEST_DTL"
                                strSQLTXT = strSQLTXT & " 	WHERE PREESTNO = '" & strPREESTNO & "' "
                                strSQLTXT = strSQLTXT & " ) A"
                                strSQLTXT = strSQLTXT & " WHERE PREESTNO = '" & strPREESTNO & "' "

                                intSave = mobjcePD_PREEST_DTL.SubitemInsert(strSQLTXT)

                            End If '변경내역이 있느냐 없느냐

                        Else
                            dblITEMCODESEQ = GetElement(vntData, "ITEMCODESEQ", intColCnt, i, NULL_NUM, True)
                            '견적 세부내역 업데이트
                            intRtn = UpdateRtn(vntData, intColCnt, i)

                            '견적 상세내역 기존내역 삭제후 다시  INSERT 한다.[단 팝업을 다녀와서 수정된 건에 한하여]
                            If GetElement(vntData, "SAVEFLAG", intColCnt, i) = "Y" Then

                                strSQL_prodEdit = " DELETE FROM PD_SUBITEM_DTL"
                                strSQL_prodEdit = strSQL_prodEdit & " WHERE ATTR01 = '" & strJOBNO & "' "
                                strSQL_prodEdit = strSQL_prodEdit & " AND PREESTNO = '" & strPREESTNO & "' "
                                strSQL_prodEdit = strSQL_prodEdit & " AND ITEMCODE = '" & strITEMCODE & "' "
                                strSQL_prodEdit = strSQL_prodEdit & " AND ITEMCODESEQ = " & dblITEMCODESEQ & "; "

                                strSQL_prodEdit = strSQL_prodEdit & " INSERT INTO PD_SUBITEM_DTL "
                                strSQL_prodEdit = strSQL_prodEdit & " SELECT "
                                strSQL_prodEdit = strSQL_prodEdit & " '" & strPREESTNO & "' PREESTNO,SEQ,SUBITEMCODESEQ,ITEMCODESEQ,ITEMCODE,"
                                strSQL_prodEdit = strSQL_prodEdit & " IMESEQ,PRINT_SEQ,PRINT_SEQ,SORTSEQ,PRICE,QTY,TERM,AMT,MEMO,EXEPRICE, "
                                strSQL_prodEdit = strSQL_prodEdit & " EXEQTY,EXETERM,EXEAMT,EXEMEMO,CONFIRMGBN,SUBITEMNAME, "
                                strSQL_prodEdit = strSQL_prodEdit & " ATTR01,ATTR02,ATTR03,ATTR04,ATTR05,ATTR06,ATTR07,ATTR08,ATTR09,ATTR10,CUSER,CDATE,UUSER,UDATE"
                                strSQL_prodEdit = strSQL_prodEdit & " FROM PD_SUBITEM_INPUT "
                                strSQL_prodEdit = strSQL_prodEdit & " WHERE ATTR01 = '" & strJOBNO & "'"
                                strSQL_prodEdit = strSQL_prodEdit & " AND ITEMCODE = '" & strITEMCODE & "' "
                                strSQL_prodEdit = strSQL_prodEdit & " AND ITEMCODESEQ = " & dblITEMCODESEQ & "; "

                                '견적 세부내역 업데이트 에따라 간접비 상세내역 업데이트
                                If strPRODUCTIONCHK = "T" Then
                                    If strITEMCODE = "242001" Then
                                        '변경된 간접비에 대하여 수정한건이 있다면 DELETE INSERT 한다.

                                        strSQL_prodEdit = strSQL_prodEdit & " DELETE FROM PD_PRODUCTIONCOMMI_HDR"
                                        strSQL_prodEdit = strSQL_prodEdit & " WHERE PREESTNO = '" & strPREESTNO & "' ; "

                                        strSQL_prodEdit = strSQL_prodEdit & " INSERT INTO PD_PRODUCTIONCOMMI_HDR "
                                        strSQL_prodEdit = strSQL_prodEdit & " (PREESTNO,AMT,COMMIRATE,EXEAMT,EXECOMMIRATE,MEMO,CUSER,CDATE,UUSER,UDATE)"
                                        strSQL_prodEdit = strSQL_prodEdit & " SELECT '" & strPREESTNO & "' PREESTNO,AMT,COMMIRATE,ISNULL(EXEAMT,0) EXEAMT, "
                                        strSQL_prodEdit = strSQL_prodEdit & " ISNULL(EXECOMMIRATE,0) EXECOMMIRATE,MEMO,CUSER,CDATE,UUSER,UDATE  "
                                        strSQL_prodEdit = strSQL_prodEdit & " FROM PD_PRODUCTIONCOMMI_HDRINPUT "
                                        strSQL_prodEdit = strSQL_prodEdit & " WHERE PREESTNO in ('" & strPREESTNO & "','9999999999'); "


                                        strSQL_prodEdit = strSQL_prodEdit & " DELETE FROM PD_PRODUCTIONCOMMI_DTL"
                                        strSQL_prodEdit = strSQL_prodEdit & " WHERE PREESTNO = '" & strPREESTNO & "' ; "

                                        strSQL_prodEdit = strSQL_prodEdit & " INSERT INTO PD_PRODUCTIONCOMMI_DTL "
                                        strSQL_prodEdit = strSQL_prodEdit & " (PREESTNO,SEQ,ITEMCODESEQ,ITEMCODE,AMT,CHK,EXEAMT,EXECHK,ATTR06,CUSER,CDATE,UUSER,UDATE) "
                                        strSQL_prodEdit = strSQL_prodEdit & " SELECT '" & strPREESTNO & "' PREESTNO,SEQ,ITEMCODESEQ,ITEMCODE,AMT,CHK, "
                                        strSQL_prodEdit = strSQL_prodEdit & " isnull(EXEAMT,0) EXEAMT,EXECHK,ATTR06,CUSER,CDATE,UUSER,UDATE "
                                        strSQL_prodEdit = strSQL_prodEdit & " FROM PD_PRODUCTIONCOMMI_INPUT "
                                        strSQL_prodEdit = strSQL_prodEdit & " WHERE PREESTNO in ('" & strPREESTNO & "','9999999999'); "
                                    Else
                                        '간접비에 저장된 상세견적은 간접비 상세의 견적과 정렬구분을 통일한다.
                                        strSQL = strSQL & " UPDATE A"
                                        strSQL = strSQL & " SET A.ATTR06 = B.PRINT_SEQ"
                                        strSQL = strSQL & " FROM PD_PRODUCTIONCOMMI_DTL A, PD_PREEST_DTL B"
                                        strSQL = strSQL & " WHERE A.PREESTNO = B.PREESTNO"
                                        strSQL = strSQL & " AND A.ITEMCODE = B.ITEMCODE"
                                        strSQL = strSQL & " AND A.ITEMCODESEQ = B.ITEMCODESEQ"
                                        strSQL = strSQL & " AND A.PREESTNO = '" & strPREESTNO & "';"

                                        intSave = mobjcePD_PREEST_DTL.PromotionCommi(strSQL)
                                    End If

                                    strSQL_prodEdit = strSQL_prodEdit & " UPDATE PD_PRODUCTIONCOMMI_DTL  "
                                    strSQL_prodEdit = strSQL_prodEdit & " SET ITEMCODE = '" & strITEMCODE & "', "
                                    strSQL_prodEdit = strSQL_prodEdit & " AMT = CASE ISNULL(DBO.PD_PREESTCONFIRMFLAG_FUN(PREESTNO),'F') WHEN 'T' THEN AMT ELSE " & dblAMT & " END , "
                                    strSQL_prodEdit = strSQL_prodEdit & " EXEAMT = CASE ISNULL(DBO.PD_PREESTCONFIRMFLAG_FUN(PREESTNO),'F') WHEN 'T' THEN " & dblAMT & " ELSE EXEAMT END "
                                    strSQL_prodEdit = strSQL_prodEdit & " WHERE PREESTNO = '" & strPREESTNO & "' "
                                    strSQL_prodEdit = strSQL_prodEdit & " AND ITEMCODESEQ = " & dblITEMCODESEQ & "; "

                                    '간접비 헤더 내역 업데이트
                                    strSQL_prodEdit = strSQL_prodEdit & " UPDATE PD_PRODUCTIONCOMMI_HDR "
                                    strSQL_prodEdit = strSQL_prodEdit & " SET AMT =  "
                                    strSQL_prodEdit = strSQL_prodEdit & " ( "
                                    strSQL_prodEdit = strSQL_prodEdit & "   SELECT  "
                                    strSQL_prodEdit = strSQL_prodEdit & "   FLOOR(A.COMMIRATE* B.SUMAMT*0.01) "
                                    strSQL_prodEdit = strSQL_prodEdit & "   FROM "
                                    strSQL_prodEdit = strSQL_prodEdit & "   ( "
                                    strSQL_prodEdit = strSQL_prodEdit & "       SELECT PREESTNO,COMMIRATE "
                                    strSQL_prodEdit = strSQL_prodEdit & "       FROM PD_PRODUCTIONCOMMI_HDR "
                                    strSQL_prodEdit = strSQL_prodEdit & "       WHERE PREESTNO = '" & strPREESTNO & "' "
                                    strSQL_prodEdit = strSQL_prodEdit & "   ) A, "
                                    strSQL_prodEdit = strSQL_prodEdit & "   ( "
                                    strSQL_prodEdit = strSQL_prodEdit & "       SELECT PREESTNO, "
                                    strSQL_prodEdit = strSQL_prodEdit & "       SUM(AMT) SUMAMT "
                                    strSQL_prodEdit = strSQL_prodEdit & "       FROM PD_PRODUCTIONCOMMI_DTL "
                                    strSQL_prodEdit = strSQL_prodEdit & "       WHERE PREESTNO = '" & strPREESTNO & "' "
                                    strSQL_prodEdit = strSQL_prodEdit & "       AND ISNULL(CHK,'0')= '1'  "
                                    strSQL_prodEdit = strSQL_prodEdit & "       GROUP BY PREESTNO"
                                    strSQL_prodEdit = strSQL_prodEdit & "   ) B "
                                    strSQL_prodEdit = strSQL_prodEdit & "   WHERE A.PREESTNO = B.PREESTNO "
                                    strSQL_prodEdit = strSQL_prodEdit & " ) ,"
                                    strSQL_prodEdit = strSQL_prodEdit & " EXEAMT =  "
                                    strSQL_prodEdit = strSQL_prodEdit & " ( "
                                    strSQL_prodEdit = strSQL_prodEdit & "   SELECT  "
                                    strSQL_prodEdit = strSQL_prodEdit & "   FLOOR(A.EXECOMMIRATE* B.SUMAMT*0.01) "
                                    strSQL_prodEdit = strSQL_prodEdit & "   FROM "
                                    strSQL_prodEdit = strSQL_prodEdit & "   ( "
                                    strSQL_prodEdit = strSQL_prodEdit & "       SELECT PREESTNO,EXECOMMIRATE "
                                    strSQL_prodEdit = strSQL_prodEdit & "       FROM PD_PRODUCTIONCOMMI_HDR "
                                    strSQL_prodEdit = strSQL_prodEdit & "       WHERE PREESTNO = '" & strPREESTNO & "' "
                                    strSQL_prodEdit = strSQL_prodEdit & "   ) A, "
                                    strSQL_prodEdit = strSQL_prodEdit & "   ( "
                                    strSQL_prodEdit = strSQL_prodEdit & "       SELECT PREESTNO, "
                                    strSQL_prodEdit = strSQL_prodEdit & "       SUM(EXEAMT)   SUMAMT "
                                    strSQL_prodEdit = strSQL_prodEdit & "       FROM PD_PRODUCTIONCOMMI_DTL "
                                    strSQL_prodEdit = strSQL_prodEdit & "       WHERE PREESTNO = '" & strPREESTNO & "' "
                                    strSQL_prodEdit = strSQL_prodEdit & "       AND ISNULL(EXECHK,'0')  = '1' "
                                    strSQL_prodEdit = strSQL_prodEdit & "       GROUP BY PREESTNO"
                                    strSQL_prodEdit = strSQL_prodEdit & "   ) B "
                                    strSQL_prodEdit = strSQL_prodEdit & "   WHERE A.PREESTNO = B.PREESTNO "
                                    strSQL_prodEdit = strSQL_prodEdit & " ) "
                                    strSQL_prodEdit = strSQL_prodEdit & " WHERE PD_PRODUCTIONCOMMI_HDR.PREESTNO = '" & strPREESTNO & "'; "

                                    '간접비 견적상세 내역 수정

                                    strSQL_prodEdit = strSQL_prodEdit & " UPDATE C"
                                    strSQL_prodEdit = strSQL_prodEdit & " SET "
                                    strSQL_prodEdit = strSQL_prodEdit & " C.AMT = FLOOR(CASE B.CONFIRMGBN WHEN 'T' THEN A.EXEAMT ELSE A.AMT END),"
                                    strSQL_prodEdit = strSQL_prodEdit & " C.PRICE = FLOOR(CASE B.CONFIRMGBN WHEN 'T' THEN A.EXEAMT ELSE A.AMT END),"
                                    strSQL_prodEdit = strSQL_prodEdit & " C.SUSUAMT = CASE ISNULL(COMMIFLAG,0) WHEN 0 THEN 0 ELSE FLOOR(CASE B.CONFIRMGBN WHEN 'T' THEN A.EXEAMT ELSE A.AMT END * B.SUSURATE/100) END "
                                    strSQL_prodEdit = strSQL_prodEdit & " FROM PD_PREEST_DTL C, PD_PRODUCTIONCOMMI_HDR A, PD_PREEST_HDR B"
                                    strSQL_prodEdit = strSQL_prodEdit & " WHERE C.PREESTNO = B.PREESTNO"
                                    strSQL_prodEdit = strSQL_prodEdit & " AND A.PREESTNO = B.PREESTNO"
                                    strSQL_prodEdit = strSQL_prodEdit & " AND C.PREESTNO = '" & strPREESTNO & "'"
                                    strSQL_prodEdit = strSQL_prodEdit & " AND C.ITEMCODE = '242001';"


                                    '견적 헤더 업데이트
                                    strSQL_prodEdit = strSQL_prodEdit & " UPDATE PD_PREEST_HDR "
                                    strSQL_prodEdit = strSQL_prodEdit & " SET NONCOMMITION = A.NONCOMMITION,"
                                    strSQL_prodEdit = strSQL_prodEdit & " COMMITION=A.COMMITION,"
                                    strSQL_prodEdit = strSQL_prodEdit & " SUSUAMT = A.SUSUAMT,"
                                    strSQL_prodEdit = strSQL_prodEdit & " AMT = A.NONCOMMITION + A.COMMITION,"
                                    strSQL_prodEdit = strSQL_prodEdit & " SUMAMT = A.NONCOMMITION + A.COMMITION + A.SUSUAMT"
                                    strSQL_prodEdit = strSQL_prodEdit & " FROM ("
                                    strSQL_prodEdit = strSQL_prodEdit & " 	SELECT "
                                    strSQL_prodEdit = strSQL_prodEdit & " 	SUM(CASE WHEN COMMIFLAG = '0' THEN ISNULL(AMT,0) ELSE 0 END) NONCOMMITION,"
                                    strSQL_prodEdit = strSQL_prodEdit & " 	SUM(CASE WHEN COMMIFLAG = '1' THEN ISNULL(AMT,0) ELSE 0 END) COMMITION,"
                                    strSQL_prodEdit = strSQL_prodEdit & " 	SUM(ISNULL(SUSUAMT,0)) SUSUAMT"
                                    strSQL_prodEdit = strSQL_prodEdit & " 	FROM PD_PREEST_DTL"
                                    strSQL_prodEdit = strSQL_prodEdit & " 	WHERE PREESTNO = '" & strPREESTNO & "' "
                                    strSQL_prodEdit = strSQL_prodEdit & " ) A"
                                    strSQL_prodEdit = strSQL_prodEdit & " WHERE PREESTNO = '" & strPREESTNO & "' "

                                    intSave_ProdEdit = mobjcePD_PREEST_DTL.SubitemInsert(strSQL_prodEdit)
                                Else
                                    '견적 헤더 업데이트
                                    strSQL_prodEdit = strSQL_prodEdit & " UPDATE PD_PREEST_HDR "
                                    strSQL_prodEdit = strSQL_prodEdit & " SET NONCOMMITION = A.NONCOMMITION,"
                                    strSQL_prodEdit = strSQL_prodEdit & " COMMITION=A.COMMITION,"
                                    strSQL_prodEdit = strSQL_prodEdit & " SUSUAMT = A.SUSUAMT,"
                                    strSQL_prodEdit = strSQL_prodEdit & " AMT = A.NONCOMMITION + A.COMMITION,"
                                    strSQL_prodEdit = strSQL_prodEdit & " SUMAMT = A.NONCOMMITION + A.COMMITION + A.SUSUAMT"
                                    strSQL_prodEdit = strSQL_prodEdit & " FROM ("
                                    strSQL_prodEdit = strSQL_prodEdit & " 	SELECT "
                                    strSQL_prodEdit = strSQL_prodEdit & " 	SUM(CASE WHEN COMMIFLAG = '0' THEN ISNULL(AMT,0) ELSE 0 END) NONCOMMITION,"
                                    strSQL_prodEdit = strSQL_prodEdit & " 	SUM(CASE WHEN COMMIFLAG = '1' THEN ISNULL(AMT,0) ELSE 0 END) COMMITION,"
                                    strSQL_prodEdit = strSQL_prodEdit & " 	SUM(ISNULL(SUSUAMT,0)) SUSUAMT"
                                    strSQL_prodEdit = strSQL_prodEdit & " 	FROM PD_PREEST_DTL"
                                    strSQL_prodEdit = strSQL_prodEdit & " 	WHERE PREESTNO = '" & strPREESTNO & "' "
                                    strSQL_prodEdit = strSQL_prodEdit & " ) A"
                                    strSQL_prodEdit = strSQL_prodEdit & " WHERE PREESTNO = '" & strPREESTNO & "' "


                                    intSave_ProdEdit = mobjcePD_PREEST_DTL.SubitemInsert(strSQL_prodEdit)
                                End If ' 간접비가 존재하냐 안하냐
                            Else
                                If strPRODUCTIONCHK = "T" Then
                                    '간접비에 저장된 상세견적은 간접비 상세의 견적과 정렬구분을 통일한다.
                                    strSQL = " UPDATE A"
                                    strSQL = strSQL & " SET A.ATTR06 = B.PRINT_SEQ"
                                    strSQL = strSQL & " FROM PD_PRODUCTIONCOMMI_DTL A, PD_PREEST_DTL B"
                                    strSQL = strSQL & " WHERE A.PREESTNO = B.PREESTNO"
                                    strSQL = strSQL & " AND A.ITEMCODE = B.ITEMCODE"
                                    strSQL = strSQL & " AND A.ITEMCODESEQ = B.ITEMCODESEQ"
                                    strSQL = strSQL & " AND A.PREESTNO = '" & strPREESTNO & "';"

                                    intSave = mobjcePD_PREEST_DTL.PromotionCommi(strSQL)
                                End If
                                strSQL_prodEdit = strSQL_prodEdit & " UPDATE PD_PREEST_HDR "
                                strSQL_prodEdit = strSQL_prodEdit & " SET NONCOMMITION = A.NONCOMMITION,"
                                strSQL_prodEdit = strSQL_prodEdit & " COMMITION=A.COMMITION,"
                                strSQL_prodEdit = strSQL_prodEdit & " SUSUAMT = A.SUSUAMT,"
                                strSQL_prodEdit = strSQL_prodEdit & " AMT = A.NONCOMMITION + A.COMMITION,"
                                strSQL_prodEdit = strSQL_prodEdit & " SUMAMT = A.NONCOMMITION + A.COMMITION + A.SUSUAMT"
                                strSQL_prodEdit = strSQL_prodEdit & " FROM ("
                                strSQL_prodEdit = strSQL_prodEdit & " 	SELECT "
                                strSQL_prodEdit = strSQL_prodEdit & " 	SUM(CASE WHEN COMMIFLAG = '0' THEN ISNULL(AMT,0) ELSE 0 END) NONCOMMITION,"
                                strSQL_prodEdit = strSQL_prodEdit & " 	SUM(CASE WHEN COMMIFLAG = '1' THEN ISNULL(AMT,0) ELSE 0 END) COMMITION,"
                                strSQL_prodEdit = strSQL_prodEdit & " 	SUM(ISNULL(SUSUAMT,0)) SUSUAMT"
                                strSQL_prodEdit = strSQL_prodEdit & " 	FROM PD_PREEST_DTL"
                                strSQL_prodEdit = strSQL_prodEdit & " 	WHERE PREESTNO = '" & strPREESTNO & "' "
                                strSQL_prodEdit = strSQL_prodEdit & " ) A"
                                strSQL_prodEdit = strSQL_prodEdit & " WHERE PREESTNO = '" & strPREESTNO & "' "

                                intSave_ProdEdit = mobjcePD_PREEST_DTL.SubitemInsert(strSQL_prodEdit)
                            End If '수정저장이냐 신규 저장이냐
                        End If
                    Next
                End If

                Return intRtn
            Catch err As Exception

                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_DETAIL_ONE")
            Finally

                mobjcePD_PREEST_DTL.Dispose()
                mobjcePD_PREEST_ESTIMATE_DTL.Dispose()

            End Try
        End With
    End Function
    ' =============== 현재PD_SUBITEM_DTL 의 합계금액을 가져온다. (사용)
    Public Function SelectRtn_DtlSum(ByVal strInfoXML As String, _
                                     ByRef intTempRowCnt As Integer, _
                                     ByRef intTempColCnt As Integer, _
                                     ByVal strJOBNO As String, _
                                     ByVal strITEMCODE As String, _
                                     ByVal dblITEMCODESEQ As Double) As Object

        Dim strCols As String         '컬럼변수
        Dim strWhere As String       'Where조건 변수
        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim strXMLData As String    'XML  Return 변수(XML  을 사용할 때 선언)
        Dim Con1



        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보 Config 개체
            strSQL = " SELECT ISNULL(SUM(AMT),0) AMT, ISNULL(SUM(EXEAMT),0) EXEAMT  "
            strSQL = strSQL & " FROM PD_SUBITEM_DTL "
            strSQL = strSQL & " WHERE ATTR01 = '" & strJOBNO & "' "
            strSQL = strSQL & " AND ITEMCODE ='" & strITEMCODE & "' "
            strSQL = strSQL & " And ITEMCODESEQ = " & dblITEMCODESEQ

            Try
                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                ' ------ Array 데이터 조회 (True 일때 헤더정보 포함 조회(Sheet Data Binding 할 경우 사용), False 일때 데이터만 조회)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intTempRowCnt, intTempColCnt, , True)
                Return vntData
                ' ------ XML 데이터 조회
                'vntData = .mobjSCGLSql.SQLSelectOneScalar(strSQL) ', intRowCnt, intColCnt
                'Return vntData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_DtlSum")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    ' =============== 현재PD_SUBITEM_INPUT 의 합계금액을 가져온다. Est_Copy 일 경우 ITEMCODE 만 비교하여 조회될수 있도록 한다. (사용)
    Public Function SelectRtn_TempSumEstCopy(ByVal strInfoXML As String, _
                                             ByRef intTempRowCnt As Integer, _
                                             ByRef intTempColCnt As Integer, _
                                             ByVal strITEMCODE As String) As Object

        Dim strCols As String         '컬럼변수
        Dim strWhere As String       'Where조건 변수
        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim strXMLData As String    'XML  Return 변수(XML  을 사용할 때 선언)
        Dim Con1



        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보 Config 개체
            strSQL = "SELECT SUM(AMT) FROM PD_SUBITEM_INPUT WHERE ITEMCODE ='" & strITEMCODE & "' HAVING ISNULL(SUM(AMT),0) <> 0  "
            Try
                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                ' ------ Array 데이터 조회 (True 일때 헤더정보 포함 조회(Sheet Data Binding 할 경우 사용), False 일때 데이터만 조회)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intTempRowCnt, intTempColCnt, , True)
                Return vntData
                ' ------ XML 데이터 조회
                'vntData = .mobjSCGLSql.SQLSelectOneScalar(strSQL) ', intRowCnt, intColCnt
                'Return vntData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_TempSumEstCopy")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    '============== 견적 헤더 실제저장
    Public Function ProcessRtn_REALHDR(ByVal xmlRoot As XmlElement, _
                                       ByVal strPREESTNO As String, _
                                       ByVal strAGREEYEARMON As String) As Integer
        Dim intRtn As Integer
        Dim strCUSTCODE As String
        Dim strJOBNO As String
        Dim intRtnUpdate As Integer
        Dim strSQL As String
        Dim strDIVAMTSQL As String
        Dim intCnt As Integer
        Dim intDIVAMTRtn As Integer
        Dim strEXESQL As String
        Dim intRtnNew As Integer

        With mobjSCGLConfig
            Try

                ''' 사용할 Entity 개체생성(Config 정보를 넘겨생성)
                mobjcePD_PREEST_HDR = New cePD_PREEST_HDR(mobjSCGLConfig)
                mobjcePD_PREEST_DTL = New cePD_PREEST_DTL(mobjSCGLConfig)

                intRtn = InsertRtn_HDR(xmlRoot, strPREESTNO, strAGREEYEARMON)
                strJOBNO = XMLGetElement(xmlRoot, "JOBNO")
                intRtnUpdate = mobjcePD_PREEST_HDR.UpdateENDFLAG(strJOBNO)

                'PD_JOBNO TB UPDATE
                strSQL = "UPDATE PD_PREEST_HDR "
                strSQL = strSQL & " SET CONFIRMFLAG = '' "
                strSQL = strSQL & " WHERE JOBNO = '" & strJOBNO & "'; "

                strSQL = strSQL & " UPDATE PD_JOBNO "
                strSQL = strSQL & " SET PREESTNO = '" & strPREESTNO & "',AGREEYEARMON =  '" & strAGREEYEARMON & "' "
                strSQL = strSQL & " WHERE JOBNO = '" & strJOBNO & "'; "

                strSQL = strSQL & " UPDATE PD_PREEST_HDR "
                strSQL = strSQL & " SET CONFIRMFLAG = '" & strAGREEYEARMON & "' "
                strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "' AND JOBNO = '" & strJOBNO & "' "

                intRtn = mobjcePD_PREEST_DTL.UpdateDo_Confirm(strSQL)

                'PD_DIVAMT TB INSERT
                intCnt = SelectRtn_DIVSEQ(strJOBNO)
                If intCnt = 0 Then
                    strDIVAMTSQL = " INSERT INTO PD_DIVAMT "
                    strDIVAMTSQL = strDIVAMTSQL & " (PREESTNO,SEQ,JOBNO,YEARMON,CREDAY,CLIENTCODE,CLIENTSUBCODE,DIVAMT,ADJAMT,JOBNAME,UUSER,UDATE,SUBSEQ) "

                    strDIVAMTSQL = strDIVAMTSQL & " SELECT PREESTNO,1 SEQ,JOBNO,SUBSTRING(CONFIRMFLAG,1,6) YEARMON,CONFIRMFLAG CREDAY, "
                    strDIVAMTSQL = strDIVAMTSQL & " CLIENTCODE,CLIENTSUBCODE,SUMAMT DIVAMT,0 ADJAMT,DBO.PD_JOBNAME_FUN(JOBNO) JOBNAME,UUSER,UDATE,SUBSEQ "
                    strDIVAMTSQL = strDIVAMTSQL & " FROM PD_PREEST_HDR "
                    strDIVAMTSQL = strDIVAMTSQL & " WHERE PREESTNO = '" & strPREESTNO & "' "

                    intDIVAMTRtn = mobjcePD_PREEST_DTL.Batch_Insert(strDIVAMTSQL)
                End If

                '확정견적일 경우 무조건 업데이트 한다.
                'NONCOMMITION,COMMITION,SUSURATE,SUSUAMT
                strEXESQL = " UPDATE PD_EXE_HDR "
                strEXESQL = strEXESQL & " SET NONCOMMITION = B.NONCOMMITION,COMMITION = B.COMMITION,SUSURATE = B.SUSURATE,SUSUAMT = B.SUSUAMT "
                strEXESQL = strEXESQL & " FROM PD_PREEST_HDR B "
                strEXESQL = strEXESQL & " WHERE PD_EXE_HDR.PREESTNO = B.PREESTNO "
                strEXESQL = strEXESQL & " AND PD_EXE_HDR.JOBNO = '" & strJOBNO & "' "

                intRtnNew = mobjcePD_PREEST_HDR.NewUpdate(strEXESQL)

                Return intRtn
            Catch err As Exception
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_REALHDR")
            Finally
                mobjcePD_PREEST_DTL.Dispose()
                mobjcePD_PREEST_HDR.Dispose()
            End Try
        End With
    End Function
    '============== 견적 헤더 실제저장
    Public Function ProcessRtn_FAKEHDR(ByVal xmlRoot As XmlElement, _
                                       ByVal strPREESTNO As String, _
                                       ByVal strAGREEYEARMON As String) As Integer
        Dim intRtn As Integer
        Dim strCUSTCODE As String
        Dim strJOBNO As String
        Dim intRtnUpdate As Integer
        Dim strSQL As String
        Dim strDIVAMTSQL As String
        Dim intCnt As Integer
        Dim intDIVAMTRtn As Integer
        Dim strFLAG As String


        With mobjSCGLConfig
            Try

                ''' 사용할 Entity 개체생성(Config 정보를 넘겨생성)
                mobjcePD_PREEST_HDR = New cePD_PREEST_HDR(mobjSCGLConfig)
                mobjcePD_PREEST_DTL = New cePD_PREEST_DTL(mobjSCGLConfig)

                '헤더를 실제 저장한다.
                intRtn = InsertRtn_ESTIMATE_HDR(xmlRoot, strPREESTNO, strAGREEYEARMON)

                'JOBNO 를 가져온다
                strJOBNO = XMLGetElement(xmlRoot, "JOBNO")

                '완료구분을 체크 하여 PF01 의뢰 상태인것이라면 PF02 로 업데이트 한다.
                strFLAG = SelectRtn_FLAG(strJOBNO)
                If strFLAG = "PF01" Then
                    intRtnUpdate = mobjcePD_PREEST_HDR.UpdateENDFLAG(strJOBNO)
                End If

                Return intRtn
            Catch err As Exception
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_FAKEHDR")
            Finally
                mobjcePD_PREEST_DTL.Dispose()
                mobjcePD_PREEST_HDR.Dispose()
            End Try
        End With
    End Function

    ''============== 견적번호생성(사용)
    Public Function SelectRtn_ESTSEQNO() As String
        '여기부터 단순조회
        Dim strSQL, strRtn As String
        'SetConfig(strInfoXML) '기본정보 Setting

        With mobjSCGLConfig '기본정보 Config 개체
            Try

                strSQL = " SELECT  "
                strSQL = strSQL & " substring(CAST(DATEPART(YEAR,GETDATE()) AS VARCHAR(4)),3,2)  "
                strSQL = strSQL & " + RIGHT('00' + CAST(DATEPART(MONTH,GETDATE()) AS VARCHAR(2)), 2)"
                strSQL = strSQL & " + RIGHT('00' + CAST(DATEPART(DAY,GETDATE()) AS VARCHAR(2)), 2)"
                strSQL = strSQL & " + DBO.LPAD(ISNULL(MAX(CAST(SUBSTRING(PREESTNO,7,4) AS NUMERIC(4,0))),0)+1,4,'0') "
                strSQL = strSQL & " FROM PD_PREEST_HDR "
                strSQL = strSQL & " WHERE SUBSTRING(PREESTNO,1,6) =  substring(CAST(DATEPART(YEAR,GETDATE()) AS VARCHAR(4)),3,2)  "
                strSQL = strSQL & " + RIGHT('00' + CAST(DATEPART(MONTH,GETDATE()) AS VARCHAR(2)), 2)"
                strSQL = strSQL & " + RIGHT('00' + CAST(DATEPART(DAY,GETDATE()) AS VARCHAR(2)), 2)"

                strRtn = .mobjSCGLSql.SQLSelectOneScalar(strSQL)
                Return strRtn
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_ESTSEQNO")
            Finally
            End Try
        End With
        '여기까지 단순조회
    End Function
    ''============== 완료구분 조회(사용)
    Public Function SelectRtn_FLAG(ByVal strJOBNO As String) As String
        '여기부터 단순조회
        Dim strSQL, strFormat, strRtn As String
        'SetConfig(strInfoXML) '기본정보 Setting

        With mobjSCGLConfig '기본정보 Config 개체
            Try
                strSQL = "SELECT ENDFLAG FROM PD_JOBNO WHERE JOBNO = '" & strJOBNO & "'"
                strRtn = .mobjSCGLSql.SQLSelectOneScalar(strSQL)
                Return strRtn
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_FLAG")
            Finally
            End Try
        End With
        '여기까지 단순조회
    End Function

    ''============== 본견적후 가견적 백업장소에 있는지 확인
    Public Function SelectRtn_ESTIMATE_CHECK(ByVal strPREESTNO As String) As String
        '여기부터 단순조회
        Dim strSQL, strFormat As String
        Dim strRtn As Integer

        'SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보 Config 개체
            Try
                strSQL = "SELECT COUNT(*) FROM PD_PREEST_ESTIMATE_HDR WHERE PREESTNO = '" & strPREESTNO & "'"
                strRtn = .mobjSCGLSql.SQLSelectOneScalar(strSQL)
                Return strRtn
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_ESTIMATE_CHECK")
            Finally
            End Try
        End With
        '여기까지 단순조회
    End Function


    ''============== DIVAMT 조회
    Public Function SelectRtn_DIVSEQ(ByVal strCODE As String) As String
        '여기부터 단순조회
        Dim strSQL, strFormat, strRtn As String
        'SetConfig(strInfoXML) '기본정보 Setting
        Dim strPRECODE As String
        With mobjSCGLConfig '기본정보 Config 개체
            Try

                strSQL = "SELECT COUNT(*) FROM PD_DIVAMT WHERE JOBNO = '" & strCODE & "'"
                strRtn = .mobjSCGLSql.SQLSelectOneScalar(strSQL)
                Return strRtn
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_DIVSEQ")
            Finally
            End Try
        End With
        '여기까지 단순조회
    End Function

    Public Function ProcessRtn_TempDelete(ByVal strInfoXML As String) As Integer
        Dim intRtn As Integer '결과값 변수
        Dim strUSER As String
        strUSER = mobjSCGLConfig.WRKUSR

        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보를 가지고 있는 Config 개체
            Try
                'DB접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                mobjcePD_PREEST_HDR = New cePD_PREEST_HDR(mobjSCGLConfig)

                intRtn = mobjcePD_PREEST_HDR.TempDeleteDo(strUSER)
                .mobjSCGLSql.SQLCommitTrans()

                Return intRtn
            Catch err As Exception
                '트랜잭션RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_TempDelete")
            Finally
                'Resource해제
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_PREEST_HDR.Dispose()
            End Try
        End With
    End Function

    Public Function ProcessRtn_Commi_TempDelete(ByVal strInfoXML As String) As Integer
        Dim intRtn As Integer '결과값 변수
        Dim strUSER As String
        strUSER = mobjSCGLConfig.WRKUSR
        Dim strSQL As String
        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보를 가지고 있는 Config 개체
            Try
                'DB접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()

                mobjcePD_PREEST_HDR = New cePD_PREEST_HDR(mobjSCGLConfig)

                strSQL = " DELETE FROM PD_PRODUCTIONCOMMI_INPUT; "
                strSQL = strSQL & " DELETE FROM PD_PRODUCTIONCOMMI_HDRINPUT; "

                intRtn = mobjcePD_PREEST_HDR.NewUpdate(strSQL)
                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_TempDelete")
            Finally
                'Resource해제
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_PREEST_HDR.Dispose()
            End Try
        End With
    End Function


    ' =============== 현재PD_PRODUCTIONCOMMI_HDR 의 합계금액을 가져온다. (사용)
    Public Function SelectRtn_CommiHDRSum(ByVal strInfoXML As String, _
                                          ByRef intTempRowCnt As Integer, _
                                          ByRef intTempColCnt As Integer, _
                                          ByVal strPREESTNO As String) As Object

        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)


        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보 Config 개체
            strSQL = "SELECT "
            strSQL = strSQL & " ISNULL(SUM(AMT),0) AMT, ISNULL(SUM(EXEAMT),0) EXEAMT "
            strSQL = strSQL & " FROM PD_PRODUCTIONCOMMI_HDR "
            strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "'"

            Try
                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                ' ------ Array 데이터 조회 (True 일때 헤더정보 포함 조회(Sheet Data Binding 할 경우 사용), False 일때 데이터만 조회)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intTempRowCnt, intTempColCnt, , True)
                Return vntData
                ' ------ XML 데이터 조회
                'vntData = .mobjSCGLSql.SQLSelectOneScalar(strSQL) ', intRowCnt, intColCnt
                'Return vntData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_CommiHDRSum")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function
    ' =============== 현재PD_PRODUCTIONCOMMI_HDRINPUT 의 합계금액을 가져온다. (사용)
    Public Function SelectRtn_CommiTempSum(ByVal strInfoXML As String, _
                                           ByRef intTempRowCnt As Integer, _
                                           ByRef intTempColCnt As Integer, _
                                           ByVal strPREESTNO As String) As Object

        Dim strCols As String         '컬럼변수
        Dim strWhere As String       'Where조건 변수
        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim strXMLData As String    'XML  Return 변수(XML  을 사용할 때 선언)
        Dim Con1



        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보 Config 개체
            strSQL = "SELECT ISNULL(AMT,0) AMT, ISNULL(EXEAMT,0) EXEAMT FROM PD_PRODUCTIONCOMMI_HDRINPUT WHERE PREESTNO = '" & strPREESTNO & "'"
            Try
                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                ' ------ Array 데이터 조회 (True 일때 헤더정보 포함 조회(Sheet Data Binding 할 경우 사용), False 일때 데이터만 조회)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intTempRowCnt, intTempColCnt, , True)
                Return vntData
                ' ------ XML 데이터 조회
                'vntData = .mobjSCGLSql.SQLSelectOneScalar(strSQL) ', intRowCnt, intColCnt
                'Return vntData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_CommiTempSum")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function
    '================ Est_Copy 도중 상세부분 내역을 복사 하여 Temp 에 넣는다.
    Public Function ProcessRtn_TempInsert(ByVal strInfoXML As String, _
                                          ByVal strPREESTNO As String, _
                                          ByVal strJOBNO As String) As Integer
        Dim intRtn As Integer '결과값 변수

        Dim strSQL As String
        Dim strUser As String

        Dim strNow As String

        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보를 가지고 있는 Config 개체
            Try
                'XML Element 변수 선언 (strMasterXML을 변환)
                strUser = .WRKUSR
                strNow = Now

                mobjcePD_PREEST_DTL = New cePD_PREEST_DTL(mobjSCGLConfig)
                'DB접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                'CF외주내역 삭제처리
                strSQL = " INSERT INTO PD_SUBITEM_INPUT "
                strSQL = strSQL & " (PREESTNO,SEQ,SUBITEMCODESEQ,ITEMCODESEQ,ITEMCODE,IMESEQ,SORTSEQ,PRICE,QTY,TERM,AMT,MEMO,CONFIRMGBN,SUBITEMNAME, "
                strSQL = strSQL & " ATTR01,CUSER,CDATE,UUSER,UDATE) "
                strSQL = strSQL & " SELECT  "
                strSQL = strSQL & " '9999999999' PREESTNO,SEQ,SUBITEMCODESEQ, ITEMCODESEQ, "
                strSQL = strSQL & " ITEMCODE,IMESEQ,SORTSEQ, "
                strSQL = strSQL & " CASE CONFIRMGBN WHEN 'T' THEN EXEPRICE ELSE PRICE END PRICE,"
                strSQL = strSQL & " CASE CONFIRMGBN WHEN 'T' THEN EXEQTY ELSE QTY END QTY,"
                strSQL = strSQL & " CASE CONFIRMGBN WHEN 'T' THEN EXETERM ELSE TERM END TERM,"
                strSQL = strSQL & " CASE CONFIRMGBN WHEN 'T' THEN EXEAMT ELSE AMT END AMT,"
                strSQL = strSQL & " MEMO,'F' CONFIRMGBN, SUBITEMNAME, '" & strJOBNO & "' ATTR01 ,"
                strSQL = strSQL & " '" & strUser & "' CUSER,'" & strNow & "' CDATE,'" & strUser & "' UUSER,'" & strNow & "' UDATE "
                strSQL = strSQL & " FROM PD_SUBITEM_DTL "
                strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "' "

                intRtn = mobjcePD_PREEST_DTL.SqlExe(strSQL)

                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_TempInsert")
            Finally
                'Resource해제
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_PREEST_DTL.Dispose()
            End Try
        End With
    End Function
    '본견적 확인팝업의 xml 바인딩 컬럼
    Public Function SelectRtn_confirmHDR(ByVal strInfoXML As String, _
                                         ByRef intRowCnt As Integer, _
                                         ByRef intColCnt As Integer, _
                                         ByVal strPREESTNO As String) As String
        Dim strCols As String         '컬럼변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim strXMLData As String    'XML  Return 변수(XML  을 사용할 때 선언)



        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보 Config 개체
            strSQL = " SELECT "
            strSQL = strSQL & " PREESTNO,PREESTNAME,SUBSTRING(CONFIRMFLAG,1,4)+'-'+SUBSTRING(CONFIRMFLAG,5,2)+'-'+SUBSTRING(CONFIRMFLAG,7,2) CONFIRMFLAG,"
            strSQL = strSQL & " SUMAMT,CHPREESTNAME,SUBSTRING(CHCONFIRMFLAG,1,4)+'-'+SUBSTRING(CHCONFIRMFLAG,5,2)+'-'+SUBSTRING(CHCONFIRMFLAG,7,2) CHCONFIRMFLAG,"
            strSQL = strSQL & " CHSUMAMT,CLIENTNAME,PRODUCT,PROJECT "
            strSQL = strSQL & " FROM "
            strSQL = strSQL & " ( "
            strSQL = strSQL & "     SELECT  "
            strSQL = strSQL & "     1 AS SELROW,PREESTNO,PREESTNAME,CONFIRMFLAG,SUMAMT, "
            strSQL = strSQL & "     DBO.MD_GET_HIGHCUSTNAME_FUN(CLIENTCODE) CLIENTNAME, "
            strSQL = strSQL & "     DBO.PD_JOBNAME_FUN(JOBNO) PRODUCT, "
            strSQL = strSQL & "     DBO.PD_PREESTNO_PROJECTNM_FUN(PREESTNO) PROJECT "
            strSQL = strSQL & "     FROM PD_PREEST_HDR "
            strSQL = strSQL & "     WHERE PREESTNO = '" & strPREESTNO & "' "
            strSQL = strSQL & " ) A, "
            strSQL = strSQL & " ( "
            strSQL = strSQL & "     SELECT  "
            strSQL = strSQL & "     1 AS SELROW,PREESTNAME CHPREESTNAME,CONFIRMFLAG CHCONFIRMFLAG,SUMAMT CHSUMAMT "
            strSQL = strSQL & "     FROM PD_PREEST_HDR "
            strSQL = strSQL & "     WHERE PREESTNO = DBO.PD_EXEPREESTNO_FUN('" & strPREESTNO & "') "
            strSQL = strSQL & " ) B "
            strSQL = strSQL & " WHERE A.SELROW = B.SELROW "

            Try
                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                ' ------ Array 데이터 조회 (True 일때 헤더정보 포함 조회(Sheet Data Binding 할 경우 사용), False 일때 데이터만 조회)
                'vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                'Return vntData
                ' ------ XML 데이터 조회
                strXMLData = .mobjSCGLSql.SQLSelectXml(strSQL, intRowCnt, intColCnt)
                Return strXMLData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_confirmHDR")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With

    End Function
    '본견적 확인팝업의 왼쪽 그리드
    Public Function SelectRtn_confirmLeftDTL(ByVal strInfoXML As String, _
                                             ByRef intRowCnt As Integer, _
                                             ByRef intColCnt As Integer, _
                                             ByVal strPREESTNO As String) As Object


        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim strXMLData As String    'XML  Return 변수(XML  을 사용할 때 선언)

        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보 Config 개체
            strSQL = " SELECT  "
            strSQL = strSQL & "DBO.PD_ITEMNAME_FUN(ITEMCODE) ITEMNAME,QTY,STD,PRICE,AMT,SUSUAMT "
            strSQL = strSQL & "FROM PD_PREEST_DTL "
            strSQL = strSQL & "WHERE PREESTNO = DBO.PD_EXEPREESTNO_FUN('" & strPREESTNO & "') "
            Try
                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                ' ------ Array 데이터 조회 (True 일때 헤더정보 포함 조회(Sheet Data Binding 할 경우 사용), False 일때 데이터만 조회)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return vntData

            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_confirmLeftDTL")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    '본견적 확인팝업의 오른쪽 그리드
    Public Function SelectRtn_confirmRightDTL(ByVal strInfoXML As String, _
                                              ByRef intRowCnt As Integer, _
                                              ByRef intColCnt As Integer, _
                                              ByVal strPREESTNO As String) As Object


        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim strXMLData As String    'XML  Return 변수(XML  을 사용할 때 선언)

        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보 Config 개체
            strSQL = " SELECT  "
            strSQL = strSQL & "DBO.PD_ITEMNAME_FUN(ITEMCODE) ITEMNAME,QTY,STD,PRICE,AMT,SUSUAMT "
            strSQL = strSQL & "FROM PD_PREEST_DTL "
            strSQL = strSQL & "WHERE PREESTNO = '" & strPREESTNO & "' "
            Try
                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                ' ------ Array 데이터 조회 (True 일때 헤더정보 포함 조회(Sheet Data Binding 할 경우 사용), False 일때 데이터만 조회)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return vntData

            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_confirmRightDTL")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function



    Public Function DeleteRtn_temp(ByVal strInfoXML As String) As Integer   '데이터 DELETE

        Dim intRtn As Integer      'Return변수( 처리건수 또는 0 )

        SetConfig(strInfoXML)    '기본정보 Setting
        With mobjSCGLConfig    '기본정보 Config 개체
            Try
                ' 사용할Entity 개체생성(Config 정보를 넘겨생성)
                mobjcePD_PREEST_TEMP = New cePD_PREEST_TEMP(mobjSCGLConfig)
                ' DB 접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                ' 엔티티 오브젝트의 Delete 메소드 호출
                intRtn = mobjcePD_PREEST_TEMP.DeleteDo(.WRKUSR)
                ' 트랜잭션 Commit
                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션 RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & "DeleteRtn_temp")
            Finally
                'DB접속 종료
                .mobjSCGLSql.SQLDisconnect()
                '사용한 Entity(개체Dispose)
                mobjcePD_PREEST_TEMP.Dispose()
            End Try
        End With
    End Function

    Public Function ProcessRtn_TEMP(ByVal strInfoXML As String, _
                                    ByVal strPREESTNO As String, _
                                    ByRef num As Integer, _
                                    ByRef strUSERID As String) As Integer

        Dim intRtn As Integer  '결과값 변수
        Dim i, intColCnt, intRows As Integer '루프, 컬럼Cnt, 로우Cnt 변수
        Dim intCnt

        SetConfig(strInfoXML) '기본정보 Setting

        With mobjSCGLConfig '기본정보를 가지고 있는 Config 개체
            Try
                'DB접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                'Master 데이터 처리
                mobjcePD_PREEST_TEMP = New cePD_PREEST_TEMP(mobjSCGLConfig)

                strUSERID = .WRKUSR 'USERID 를 받아야 출력시에 USERID에 따른 구분을 둘수있다.
                intRtn = InsertRtn_TRANS_TEMP(strPREESTNO, num)
                mobjcePD_PREEST_TEMP.Dispose()
                '트랜잭션Commit
                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_TEMP")
            Finally
                'Resource해제
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function
    ' =============== 견적유형 TYPE 적용 Select Proc
    Public Function SelectRtn_ProcEST(ByVal strInfoXML As String, _
                                      ByRef intRowCnt As Integer, _
                                      ByRef intColCnt As Integer, _
                                      ByVal dblHDRSEQ As Double, _
                                      ByVal strPREESTNO As String) As Object

        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim strProcSQL As String
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim strXMLData As String    'XML  Return 변수(XML  을 사용할 때 선언)
        Dim Con1
        Dim strUSER
        Dim intRtn


        SetConfig(strInfoXML)
        With mobjSCGLConfig '기본정보 Config 개체
            strUSER = .WRKUSR


            strFormat = " SELECT "
            strFormat = strFormat & " HDRSEQ,'" & strPREESTNO & "' PREESTNO,NULL ITEMCODESEQ, "
            strFormat = strFormat & " DBO.PD_ITEMDIVNAME_FUN(ITEMCODE) DIVNAME, "
            strFormat = strFormat & " DBO.PD_ITEMCLASSNAME_FUN(ITEMCODE) CLASSNAME, "
            strFormat = strFormat & " ITEMCODE, "
            strFormat = strFormat & " DBO.PD_ITEMCODENAME_FUN(ITEMCODE) ITEMCODENAME, "
            strFormat = strFormat & " STD, "
            strFormat = strFormat & " COMMIFLAG, "
            strFormat = strFormat & " QTY, "
            strFormat = strFormat & " PRICE, "
            strFormat = strFormat & " AMT, "
            strFormat = strFormat & " 'F' AS GBN, "
            strFormat = strFormat & " FAKENAME,SUSUAMT,SUBDETAIL, "
            strFormat = strFormat & " 'N' SAVEFLAG, "
            strFormat = strFormat & " DBO.PD_ITEMCODEDETAILYN_FUN(ITEMCODE) DETAILYNFLAG, "
            strFormat = strFormat & " IMESEQ, "
            strFormat = strFormat & " 'F' PRODUCTIONCOMMISSION  "
            strFormat = strFormat & " FROM PD_ESTTYPE_DTL  "
            strFormat = strFormat & " WHERE itemcode <> '242001' and  HDRSEQ =" & dblHDRSEQ
            strFormat = strFormat & " ORDER BY PRINT_SEQ"


            strSQL = String.Format(strFormat)

            Try
                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                ' ------ Array 데이터 조회 (True 일때 헤더정보 포함 조회(Sheet Data Binding 할 경우 사용), False 일때 데이터만 조회)

                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)

                ' ------ XML 데이터 조회
                'strXMLData = .mobjSCGLSql.SQLSelectXml(strSQL, intRowCnt, intColCnt)
                '트랜젝션 걸림(조회시, PD_SUBITEM_INPUT >> TEMP 값무조건 삭제)

                .mobjSCGLSql.SQLBeginTrans()
                mobjcePD_PREEST_HDR = New cePD_PREEST_HDR(mobjSCGLConfig)

                '템프테이블 삭제와 상세견적 저장 하단 그리드에 적용 화면 보여주기 위해서

                strProcSQL = " DELETE FROM PD_SUBITEM_INPUT WHERE CUSER = '" & strUSER & "' ; "
                strProcSQL = strProcSQL & " INSERT INTO PD_SUBITEM_INPUT"
                strProcSQL = strProcSQL & " (PREESTNO,SEQ,SUBITEMCODESEQ,ITEMCODESEQ,ITEMCODE,IMESEQ, "
                strProcSQL = strProcSQL & " SORTSEQ,PRICE,QTY,TERM,AMT,MEMO,EXEPRICE,EXEQTY,EXETERM, "
                strProcSQL = strProcSQL & " EXEAMT,EXEMEMO,CONFIRMGBN,NEWFLAG,SUBITEMNAME,CUSER) "

                strProcSQL = strProcSQL & " SELECT  "
                strProcSQL = strProcSQL & " '" & strPREESTNO & "' PREESTNO,SEQ,SUBITEMCODESEQ,ITEMCODESEQ,ITEMCODE,IMESEQ, "
                strProcSQL = strProcSQL & " SORTSEQ,PRICE,QTY,TERM,AMT,MEMO,EXEPRICE,EXEQTY,EXETERM, "
                strProcSQL = strProcSQL & " EXEAMT,EXEMEMO,CONFIRMGBN,NEWFLAG,SUBITEMNAME, '" & strUSER & "' CUSER "
                strProcSQL = strProcSQL & " FROM PD_ESTSUBTYPE "
                strProcSQL = strProcSQL & " WHERE HDRSEQ = " & dblHDRSEQ

                intRtn = mobjcePD_PREEST_HDR.InsertRtn_COPY(strProcSQL)
                .mobjSCGLSql.SQLCommitTrans()

                Return vntData
                'Return strXMLData
            Catch err As Exception
                ' 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()



                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_ProcEST")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_PREEST_HDR.Dispose()
            End Try
        End With
    End Function
    Private Function InsertRtn_TRANS_TEMP(ByVal strPREESTNO As String, _
                                          ByRef num As Integer) As Integer
        Dim intRtn As Integer
        intRtn = mobjcePD_PREEST_TEMP.InsertDo( _
                                       strPREESTNO, _
                                       num)
        Return intRtn

    End Function

    '김한규 플레너 요청으로인한 다른 잡의 견적 복사 20101215
    '견적 리스트에서 다른 JOB 을 가져왔을 경우.[선택한 JOBNO 의 견적을 PREESTNO 만 바꿔서 그대로 복사한다.]
    Public Function ProcessRtn_HDRLESS_COPY(ByVal strInfoXML As String, _
                                            ByVal strMasterXML As String, _
                                            ByVal strPREESTNO As String, _
                                            ByRef strNewPREESTNO As String, _
                                            ByRef strJOBNO As String, _
                                            ByVal strAGREEYEARMON As String) As Integer

        Dim intRtn As Integer '결과값 변수
        Dim strSQL As String
        Dim strUSER As String
        Dim strNow As String

        Dim strPREESTNAME
        Dim strTIMCODE
        Dim strESTSUSURATE As Double
        Dim strCLIENTCODE
        Dim intESTSUSUAMT As Double
        Dim intCOMMITION As Double
        Dim intNONCOMMITION As Double
        Dim intESTSUMAMT As Double
        Dim strSUBSEQ
        Dim strMEMO
        Dim strCONFIRMGBN
        Dim intESTAMT As Double



        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보를 가지고 있는 Config 개체
            Try
                'XML Element 변수 선언 (strMasterXML을 변환)
                Dim xmlRoot As XmlElement
                xmlRoot = XMLGetRoot(strMasterXML) 'XML 데이터

                mobjcePD_PREEST_HDR = New cePD_PREEST_HDR(mobjSCGLConfig)
                'DB접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                '견적 헤더 저장

                strUSER = .WRKUSR
                strNow = Now

                strNewPREESTNO = SelectRtn_ESTSEQNO()


                strPREESTNAME = XMLGetElement(xmlRoot, "PREESTNAME")
                strTIMCODE = XMLGetElement(xmlRoot, "TIMCODE")
                strESTSUSURATE = XMLGetElement(xmlRoot, "ESTSUSURATE", NULL_NUM, True)
                strCLIENTCODE = XMLGetElement(xmlRoot, "CLIENTCODE")
                intESTSUSUAMT = XMLGetElement(xmlRoot, "ESTSUSUAMT", NULL_NUM, True)
                intCOMMITION = XMLGetElement(xmlRoot, "COMMITION", NULL_NUM, True)
                intNONCOMMITION = XMLGetElement(xmlRoot, "NONCOMMITION", NULL_NUM, True)
                intESTSUMAMT = XMLGetElement(xmlRoot, "ESTSUMAMT", NULL_NUM, True)
                strSUBSEQ = XMLGetElement(xmlRoot, "SUBSEQ")
                strMEMO = XMLGetElement(xmlRoot, "MEMO")
                strCONFIRMGBN = "F"
                intESTAMT = XMLGetElement(xmlRoot, "ESTAMT", NULL_NUM, True)


                strSQL = " INSERT INTO PD_PREEST_HDR  "
                strSQL = strSQL & " (PREESTNO,PREESTNAME,JOBNO,AMT,MEMO,CREDAY,TIMCODE,CONFIRMFLAG,SUSUAMT,SUSURATE,COMMITION,NONCOMMITION, "
                strSQL = strSQL & " SUMAMT, CLIENTCODE, SUBSEQ, CONFIRMGBN, CUSER, CDATE, UUSER, UDATE) "
                strSQL = strSQL & " SELECT "
                strSQL = strSQL & " '" & strNewPREESTNO & "' PREESTNO,'" & strPREESTNAME & "' PREESTNAME,"
                strSQL = strSQL & " '" & strJOBNO & "' JOBNO, " & intESTAMT & " AMT, "
                strSQL = strSQL & " '" & strMEMO & "' MEMO, CREDAY, '" & strTIMCODE & "' TIMCODE,  "
                strSQL = strSQL & " '" & strAGREEYEARMON & "' CONFIRMFLAG, " & intESTSUSUAMT & "SUSUAMT, "
                strSQL = strSQL & " " & strESTSUSURATE & " SUSURATE, " & intCOMMITION & " COMMITION, "
                strSQL = strSQL & " " & intNONCOMMITION & "NONCOMMITION," & intESTSUMAMT & " SUMAMT, "
                strSQL = strSQL & " '" & strCLIENTCODE & "' CLIENTCODE, '" & strSUBSEQ & "' SUBSEQ, "
                strSQL = strSQL & " '" & strCONFIRMGBN & "' CONFIRMGBN,'" & strUSER & "' CUSER,'" & strNow & "' CDATE, "
                strSQL = strSQL & " '" & strUSER & "' UUSER,'" & strNow & "' UDATE "
                strSQL = strSQL & " FROM PD_PREEST_HDR "
                strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "'; "

                strSQL = strSQL & " INSERT INTO PD_PREEST_DTL "
                strSQL = strSQL & " (PREESTNO,ITEMCODESEQ,ITEMCODE,STD,COMMIFLAG,QTY,PRICE,AMT,FAKENAME, "
                strSQL = strSQL & " SUSUAMT,SUBDETAIL,IMESEQ, PRINT_SEQ,CUSER,CDATE,UUSER,UDATE) "
                strSQL = strSQL & " SELECT "
                strSQL = strSQL & " '" & strNewPREESTNO & "' PREESTNO,ITEMCODESEQ,ITEMCODE,STD, "
                strSQL = strSQL & " COMMIFLAG,QTY,PRICE,AMT,FAKENAME,SUSUAMT,SUBDETAIL,IMESEQ, "
                strSQL = strSQL & " CASE ISNULL(PRINT_SEQ,0) WHEN 0 THEN IMESEQ ELSE PRINT_SEQ END , "
                strSQL = strSQL & " '" & strUSER & "' CUSER,'" & strNow & "' CDATE,'" & strUSER & "' UUSER,'" & strNow & "' UDATE "
                strSQL = strSQL & " FROM PD_PREEST_DTL "
                strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "'; "

                strSQL = strSQL & " INSERT INTO PD_SUBITEM_DTL "
                strSQL = strSQL & " (PREESTNO,SEQ,SUBITEMCODESEQ,ITEMCODESEQ,ITEMCODE,IMESEQ, PRINT_SEQ, "
                strSQL = strSQL & " SORTSEQ,PRICE,QTY,TERM,AMT,MEMO,CONFIRMGBN,SUBITEMNAME,ATTR01,CUSER,CDATE,UUSER,UDATE) "
                strSQL = strSQL & " SELECT "
                strSQL = strSQL & " '" & strNewPREESTNO & "' PREESTNO,SEQ,SUBITEMCODESEQ,ITEMCODESEQ,ITEMCODE,IMESEQ, "
                strSQL = strSQL & " CASE ISNULL(PRINT_SEQ,0) WHEN 0 THEN SUBITEMCODESEQ ELSE PRINT_SEQ END AS PRINT_SEQ, "
                strSQL = strSQL & " SORTSEQ,"
                strSQL = strSQL & " CASE CONFIRMGBN WHEN 'T' THEN EXEPRICE ELSE PRICE END PRICE, "
                strSQL = strSQL & " CASE CONFIRMGBN WHEN 'T' THEN EXEQTY ELSE QTY END QTY,"
                strSQL = strSQL & " CASE CONFIRMGBN WHEN 'T' THEN EXETERM ELSE TERM END TERM, "
                strSQL = strSQL & " CASE CONFIRMGBN WHEN 'T' THEN EXEAMT ELSE AMT END AMT, "
                strSQL = strSQL & " MEMO, "
                strSQL = strSQL & " 'F' CONFIRMGBN,SUBITEMNAME,'" & strJOBNO & "' AS ATTR01, "
                strSQL = strSQL & " '" & strUSER & "' CUSER,'" & strNow & "' CDATE,'" & strUSER & "' UUSER,'" & strNow & "' UDATE "
                strSQL = strSQL & " FROM PD_SUBITEM_DTL "
                strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "';"

                strSQL = strSQL & " INSERT INTO PD_PRODUCTIONCOMMI_HDR "
                strSQL = strSQL & " (PREESTNO,AMT,COMMIRATE,MEMO,CUSER,CDATE,UUSER,UDATE) "
                strSQL = strSQL & " SELECT  "
                strSQL = strSQL & " '" & strNewPREESTNO & "' PREESTNO,AMT,COMMIRATE,MEMO,'" & strUSER & "' CUSER,"
                strSQL = strSQL & " '" & strNow & "' CDATE,'" & strUSER & "' UUSER,'" & strNow & "' UDATE "
                strSQL = strSQL & " FROM PD_PRODUCTIONCOMMI_HDR "
                strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "'; "

                strSQL = strSQL & " INSERT INTO PD_PRODUCTIONCOMMI_DTL "
                strSQL = strSQL & " (PREESTNO,SEQ,ITEMCODESEQ,ITEMCODE,AMT,CHK,ATTR06,CUSER,CDATE,UUSER,UDATE) "
                strSQL = strSQL & " SELECT "
                strSQL = strSQL & " '" & strNewPREESTNO & "' PREESTNO,SEQ,ITEMCODESEQ,ITEMCODE,AMT,CHK,ATTR06, "
                strSQL = strSQL & " '" & strUSER & "' CUSER,'" & strNow & "' CDATE,'" & strUSER & "' UUSER,'" & strNow & "' UDATE "
                strSQL = strSQL & " FROM PD_PRODUCTIONCOMMI_DTL  "
                strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "'; "

                strSQL = strSQL & " INSERT INTO PD_OUTLIST_MST "
                strSQL = strSQL & " (PREESTNO,JOBNO,PRODUCTIONNAME,DIRECTORNAME,EDIT,CG,TELECINE,RECORDING, "
                strSQL = strSQL & " CMSONG,STUDIO,MODELAGENCY,DATE,MEETINGDATE,SHOOTDATE,STAGESHOOTDAYS, "
                strSQL = strSQL & " DAYS,HOURS,TITLE,LENGTHS,COMMENTS,CUSER,CDATE,UUSER,UDATE) "
                strSQL = strSQL & " SELECT "
                strSQL = strSQL & " '" & strNewPREESTNO & "' PREESTNO,'" & strJOBNO & "' JOBNO,PRODUCTIONNAME,DIRECTORNAME, "
                strSQL = strSQL & " EDIT,CG,TELECINE,RECORDING,CMSONG,STUDIO, "
                strSQL = strSQL & " MODELAGENCY,DATE,MEETINGDATE,SHOOTDATE,STAGESHOOTDAYS, "
                strSQL = strSQL & " DAYS,HOURS,TITLE,LENGTHS,COMMENTS,'" & strUSER & "' CUSER, "
                strSQL = strSQL & " '" & strNow & "' CDATE,'" & strUSER & "' UUSER,'" & strNow & "' UDATE "
                strSQL = strSQL & " FROM PD_OUTLIST_MST  "
                strSQL = strSQL & " WHERE PREESTNO = '" & strPREESTNO & "'; "

                mobjcePD_PREEST_HDR.NewUpdate(strSQL)

                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_HDRLESS_COPY")
            Finally
                'Resource해제
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_PREEST_HDR.Dispose()
            End Try
        End With
    End Function

    '견적창은 나갈때 input값을 지운다.
    Public Function Delete_CloseInput(ByVal strInfoXML As String, _
                                      ByRef intRowCnt As Integer, _
                                      ByRef intColCnt As Integer) As String

        Dim strUSER
        Dim intRtn

        With mobjSCGLConfig '기본정보 Config 개체
            Try
                SetConfig(strInfoXML) '기본정보 Setting
                strUSER = mobjSCGLConfig.WRKUSR

                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)

                .mobjSCGLSql.SQLBeginTrans()
                mobjcePD_PREEST_HDR = New cePD_PREEST_HDR(mobjSCGLConfig)

                intRtn = mobjcePD_PREEST_HDR.TempDeleteDo(strUSER)
                .mobjSCGLSql.SQLCommitTrans()

                Return intRtn
            Catch err As Exception
                ' 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".Delete_CloseInput")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_PREEST_HDR.Dispose()
            End Try
        End With
    End Function

#End Region

#Region "GROUP BLOCK : Entity Function Section"
    '간접비 템프투입내역(사용)
    Private Function InsertRtn_Indirect(ByVal vntData As Object, _
                                        ByVal intColCnt As Integer, _
                                        ByVal intRow As Integer, _
                                        ByVal dblID As Double, _
                                        ByVal dblITEMCODESEQ As Double, _
                                        ByVal strCHK As String) As Integer
        Dim intRtn As Integer
        'PREESTNO,SEQ,ITEMCODESEQ,ITEMCODE,AMT
        intRtn = mobjcePD_PRODUCTIONCOMMI_INPUT.InsertDo( _
                                       GetElement(vntData, "PREESTNO", intColCnt, intRow), _
                                       dblID, _
                                       dblITEMCODESEQ, _
                                       GetElement(vntData, "ITEMCODE", intColCnt, intRow), _
                                       GetElement(vntData, "AMT", intColCnt, intRow, NULL_NUM, True), _
                                       strCHK, _
                                       GetElement(vntData, "EXEAMT", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "EXECHK", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR01", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR02", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR03", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR04", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR05", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR06", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR07", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR08", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR09", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR10", intColCnt, intRow, NULL_NUM, True))
        Return intRtn

    End Function
    'PREESTNO,PREESTNAME,JOBNO,JOBNAME,AMT,MEMO,CREDAY
    Private Function InsertRtn(ByVal vntData As Object, _
                               ByVal intColCnt As Integer, _
                               ByVal intRow As Integer, _
                               ByVal strCODE As String) As Integer
        Dim intRtn As Integer
        'PREESTNO,ITEMCODESEQ,ITEMCODE,STD,COMMIFLAG,QTY,PRICE,AMT
        intRtn = mobjcePD_PREEST_DTL.InsertDo( _
                                       GetElement(vntData, "PREESTNO", intColCnt, intRow), _
                                       strCODE, _
                                       GetElement(vntData, "ITEMCODE", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "STD", intColCnt, intRow), _
                                       GetElement(vntData, "COMMIFLAG", intColCnt, intRow), _
                                       GetElement(vntData, "QTY", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "PRICE", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "AMT", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "FAKENAME", intColCnt, intRow), _
                                       GetElement(vntData, "SUSUAMT", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "IMESEQ", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR01", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR02", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR03", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR04", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR05", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR06", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR07", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR08", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR09", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR10", intColCnt, intRow, NULL_NUM, True))
        Return intRtn

    End Function

    'Coyp 견적 상세내역 (사용)
    Private Function InsertRtn_LESS(ByVal vntData As Object, _
                                    ByVal intColCnt As Integer, _
                                    ByVal intRow As Integer, _
                                    ByVal strPREESTNO As String, _
                                    ByVal strCODE As String) As Integer
        Dim intRtn As Integer
        'PREESTNO,ITEMCODESEQ,ITEMCODE,STD,COMMIFLAG,QTY,PRICE,AMT
        intRtn = mobjcePD_PREEST_DTL.InsertDo( _
                                       strPREESTNO, _
                                       strCODE, _
                                       GetElement(vntData, "ITEMCODE", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "STD", intColCnt, intRow), _
                                       GetElement(vntData, "COMMIFLAG", intColCnt, intRow), _
                                       GetElement(vntData, "QTY", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "PRICE", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "AMT", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "FAKENAME", intColCnt, intRow), _
                                       GetElement(vntData, "SUSUAMT", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "IMESEQ", intColCnt, intRow, NULL_NUM, True), _
                                       intRow, _
                                       GetElement(vntData, "ATTR01", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR02", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR03", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR04", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR05", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR06", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR07", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR08", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR09", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR10", intColCnt, intRow, NULL_NUM, True))
        Return intRtn

    End Function


    'Coyp 견적 상세내역 (사용)
    Private Function InsertRtn_LESS_ESTIMATE(ByVal vntData As Object, _
                                             ByVal intColCnt As Integer, _
                                             ByVal intRow As Integer, _
                                             ByVal strPREESTNO As String, _
                                             ByVal strCODE As String) As Integer
        Dim intRtn As Integer
        'PREESTNO,ITEMCODESEQ,ITEMCODE,STD,COMMIFLAG,QTY,PRICE,AMT
        intRtn = mobjcePD_PREEST_ESTIMATE_DTL.InsertDo( _
                                       strPREESTNO, _
                                       strCODE, _
                                       GetElement(vntData, "ITEMCODE", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "STD", intColCnt, intRow), _
                                       GetElement(vntData, "COMMIFLAG", intColCnt, intRow), _
                                       GetElement(vntData, "QTY", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "PRICE", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "AMT", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "FAKENAME", intColCnt, intRow), _
                                       GetElement(vntData, "SUSUAMT", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "IMESEQ", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "IMESEQ", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR01", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR02", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR03", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR04", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR05", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR06", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR07", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR08", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR09", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR10", intColCnt, intRow, NULL_NUM, True))
        Return intRtn

    End Function


    Private Function UpdateRtn(ByVal vntData As Object, _
                               ByVal intColCnt As Integer, _
                               ByVal intRow As Integer) As Integer

        Dim intRtn As Integer
        'PREESTNO,ITEMCODESEQ,ITEMCODE,STD,COMMIFLAG,QTY,PRICE,AMT
        intRtn = mobjcePD_PREEST_DTL.UpdateDo( _
                                       GetElement(vntData, "PREESTNO", intColCnt, intRow), _
                                       GetElement(vntData, "ITEMCODESEQ", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ITEMCODE", intColCnt, intRow), _
                                       GetElement(vntData, "STD", intColCnt, intRow), _
                                       GetElement(vntData, "COMMIFLAG", intColCnt, intRow), _
                                       GetElement(vntData, "QTY", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "PRICE", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "AMT", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "FAKENAME", intColCnt, intRow), _
                                       GetElement(vntData, "SUSUAMT", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "IMESEQ", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "PRINT_SEQ", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR01", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR02", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR03", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR04", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR05", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR06", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR07", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR08", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR09", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR10", intColCnt, intRow, NULL_NUM, True))
        Return intRtn
    End Function

    ' ======== 가견적 헤더저장 (사용)
    Private Function UpdateRtn_HDR(ByVal xmlRoot As XmlElement, _
                                   ByVal strPREESTNO As String, _
                                   ByVal strAGREEYEARMON As String) As Integer
        Dim intRtn As Integer
        'SUSURATE,SUSUAMT,COMMITION,NONCOMMITION,SUMAMT
        intRtn = mobjcePD_PREEST_HDR.UpdateDo_CALCUL( _
                                       strPREESTNO, _
                                       strAGREEYEARMON, _
                                       XMLGetElement(xmlRoot, "SUSURATE", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "SUSUAMT", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "COMMITION", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "NONCOMMITION", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "SUMAMT", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "MEMO"), _
                                       XMLGetElement(xmlRoot, "PREESTNAME"), _
                                       XMLGetElement(xmlRoot, "AMT", NULL_NUM, True))
        Return intRtn
    End Function

    Private Function UpdateRtn_HDR2(ByVal xmlRoot As XmlElement, _
                                    ByVal strPREESTNO As String, _
                                    ByVal strAGREEYEARMON As String) As Integer
        Dim intRtn As Integer
        'SUSURATE,SUSUAMT,COMMITION,NONCOMMITION,SUMAMT
        intRtn = mobjcePD_PREEST_HDR.UpdateDo_CALCUL( _
                                       strPREESTNO, _
                                       strAGREEYEARMON, _
                                       XMLGetElement(xmlRoot, "ESTSUSURATE", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "ESTSUSUAMT", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "COMMITION", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "NONCOMMITION", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "ESTSUMAMT", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "MEMO"), _
                                       XMLGetElement(xmlRoot, "PREESTNAME"), _
                                       XMLGetElement(xmlRoot, "AMT", NULL_NUM, True))
        Return intRtn
    End Function

    ' ========= Copy 견적 헤더 (사용)
    Private Function InsertRtn_ESTIMATE_HDR(ByVal xmlRoot As XmlElement, _
                                   ByVal strPREESTNO As String, _
                                   ByVal strAGREEYEARMON As String) As Integer
        Dim intRtn As Integer
        intRtn = mobjcePD_PREEST_HDR.InsertDo_HDR( _
                                       strPREESTNO, _
                                       XMLGetElement(xmlRoot, "PREESTNAME"), _
                                       XMLGetElement(xmlRoot, "JOBNO"), _
                                       XMLGetElement(xmlRoot, "TIMCODE"), _
                                       XMLGetElement(xmlRoot, "ESTSUSURATE", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "CLIENTCODE"), _
                                       XMLGetElement(xmlRoot, "ESTSUSUAMT", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "COMMITION", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "NONCOMMITION", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "ESTSUMAMT", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "SUBSEQ"), _
                                       XMLGetElement(xmlRoot, "MEMO"), _
                                       strAGREEYEARMON, _
                                       "F", _
                                       XMLGetElement(xmlRoot, "ESTAMT", NULL_NUM, True))

        'strPREESTNO,PREESTNAME,JOBNO,CREDAY,CLIENTSUBCODE,SUSURATE,CLIENTCODE
        'SUSUAMT,COMMITION,NONCOMMITION,SUMAMT
        Return intRtn
    End Function


    ' ========= Copy 견적 헤더 (사용)
    Private Function InsertRtn_HDR(ByVal xmlRoot As XmlElement, _
                                   ByVal strPREESTNO As String, _
                                   ByVal strAGREEYEARMON As String) As Integer
        Dim intRtn As Integer
        intRtn = mobjcePD_PREEST_HDR.InsertDo_HDR( _
                                       strPREESTNO, _
                                       XMLGetElement(xmlRoot, "PREESTNAME"), _
                                       XMLGetElement(xmlRoot, "JOBNO"), _
                                       XMLGetElement(xmlRoot, "TIMCODE"), _
                                       XMLGetElement(xmlRoot, "SUSURATE", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "CLIENTCODE"), _
                                       XMLGetElement(xmlRoot, "SUSUAMT", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "COMMITION", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "NONCOMMITION", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "SUMAMT", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "SUBSEQ"), _
                                       XMLGetElement(xmlRoot, "MEMO"), _
                                       strAGREEYEARMON, _
                                       "F", _
                                       XMLGetElement(xmlRoot, "AMT", NULL_NUM, True))

        'strPREESTNO,PREESTNAME,JOBNO,CREDAY,CLIENTSUBCODE,SUSURATE,CLIENTCODE
        'SUSUAMT,COMMITION,NONCOMMITION,SUMAMT
        Return intRtn
    End Function

    ' ========= Copy 견적 헤더 카피후 본견적으로 자동저장 (사용)
    Private Function InsertRtn2_HDR(ByVal xmlRoot As XmlElement, _
                                    ByVal strPREESTNO As String, _
                                    ByVal strAGREEYEARMON As String) As Integer
        Dim intRtn As Integer
        intRtn = mobjcePD_PREEST_HDR.InsertDo_HDR( _
                                       strPREESTNO, _
                                       XMLGetElement(xmlRoot, "PREESTNAME"), _
                                       XMLGetElement(xmlRoot, "JOBNO"), _
                                       XMLGetElement(xmlRoot, "TIMCODE"), _
                                       XMLGetElement(xmlRoot, "SUSURATE", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "CLIENTCODE"), _
                                       XMLGetElement(xmlRoot, "SUSUAMT", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "COMMITION", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "NONCOMMITION", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "SUMAMT", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "SUBSEQ"), _
                                       XMLGetElement(xmlRoot, "MEMO"), _
                                       strAGREEYEARMON, _
                                       "T", _
                                       XMLGetElement(xmlRoot, "AMT", NULL_NUM, True))

        'strPREESTNO,PREESTNAME,JOBNO,CREDAY,CLIENTSUBCODE,SUSURATE,CLIENTCODE
        'SUSUAMT,COMMITION,NONCOMMITION,SUMAMT
        Return intRtn
    End Function

    Private Function InsertRtn3_HDR(ByVal xmlRoot As XmlElement, _
                                    ByVal strPREESTNO As String, _
                                    ByVal strAGREEYEARMON As String) As Integer
        Dim intRtn As Integer
        intRtn = mobjcePD_PREEST_ESTIMATE_HDR.InsertDo_HDR( _
                                       strPREESTNO, _
                                       XMLGetElement(xmlRoot, "PREESTNAME"), _
                                       XMLGetElement(xmlRoot, "JOBNO"), _
                                       XMLGetElement(xmlRoot, "TIMCODE"), _
                                       XMLGetElement(xmlRoot, "ESTSUSURATE", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "CLIENTCODE"), _
                                       XMLGetElement(xmlRoot, "ESTSUSUAMT", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "COMMITION", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "NONCOMMITION", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "ESTSUMAMT", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "SUBSEQ"), _
                                       XMLGetElement(xmlRoot, "MEMO"), _
                                       strAGREEYEARMON, _
                                       "T", _
                                       XMLGetElement(xmlRoot, "ESTAMT", NULL_NUM, True))

        'strPREESTNO,PREESTNAME,JOBNO,CREDAY,CLIENTSUBCODE,SUSURATE,CLIENTCODE
        'SUSUAMT,COMMITION,NONCOMMITION,SUMAMT
        Return intRtn
    End Function

    Private Function UpdateRtn_HDR_BASIC(ByVal xmlRoot As XmlElement, _
                                         ByVal strPREESTNO As String, _
                                         ByVal strAGREEYEARMON As String) As Integer
        Dim intRtn As Integer
        'SUSURATE,SUSUAMT,COMMITION,NONCOMMITION,SUMAMT
        intRtn = mobjcePD_PREEST_HDR.UpdateDo_BASIC( _
                                       strPREESTNO, _
                                       strAGREEYEARMON, _
                                       XMLGetElement(xmlRoot, "SUSURATE", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "SUSUAMT", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "MEMO"), _
                                       XMLGetElement(xmlRoot, "PREESTNAME"))
        Return intRtn
    End Function

    Private Function UpdateRtn_HDR_BASIC2(ByVal xmlRoot As XmlElement, _
                                          ByVal strPREESTNO As String, _
                                          ByVal strAGREEYEARMON As String) As Integer
        Dim intRtn As Integer
        intRtn = mobjcePD_PREEST_HDR.UpdateDo_BASIC( _
                                       strPREESTNO, _
                                       strAGREEYEARMON, _
                                       XMLGetElement(xmlRoot, "ESTSUSURATE", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "ESTSUSUAMT", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "MEMO"), _
                                       XMLGetElement(xmlRoot, "PREESTNAME"))
        Return intRtn
    End Function

#End Region
End Class



