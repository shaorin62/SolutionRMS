'****************************************************************************************
'Generated By  : Kim Tae Ho 
'시스템구분    : RMS/PD/Server Control Class
'실행   환경   : COM+ Service Server Package
'프로그램명    : ccPDCMPONO.vb
'기         능 : - Project Number 생성
'특이  사항    : - 
'                -
'----------------------------------------------------------------------------------------
'HISTORY    :1) 2008.11.07 Kim Tae Ho
'            2) 
'****************************************************************************************

Imports System.Xml                  ' XML처리
Imports SCGLControl                 ' ControlClass의 Base Class
Imports SCGLUtil.cbSCGLConfig       ' ConfigurationClass
Imports SCGLUtil.cbSCGLErr          '오류처리 클래스
Imports SCGLUtil.cbSCGLXml          'XML처리 클래스
Imports SCGLUtil.cbSCGLUtil         '기타유틸리티 클래스
Imports ePDCO                       '엔터티 추가

' 엔티티 클래스 사용시 해당 엔티티 클래스의 프로젝트를 참조한 후 Imports 하십시요. 
' Imports 엔티티프로젝트
Public Class ccPDCOCODETR
    Inherits ccControl
#Region "GROUP BLOCK : 전역 또는 모듈레벨의 변수/상수 선언"
    Private CLASS_NAME = "ccPDCOCODETR"                  '자신의 클래스명
    Private mobjcePD_ITEMCODE As ePDCO.cePD_ITEMCODE           '사용할 Entity 변수 선언'cePD_ITEMCODE
    Private mobjcePD_ITEMCLASSCODE As ePDCO.cePD_ITEMCLASSCODE           '사용할 Entity 변수 선언'cePD_ITEMCODE
    ''Private Const .DBConnStr = "Provider=SQLOLEDB;Data Source=10.110.10.86;Initial Catalog=MCDEV;DSN=MCDEV;UID=devadmin;Pwd=password"
#End Region

#Region "GROUP BLOCK : Function Section"
    ' =============== 제작항목 코드 조회
    Public Function SelectRtn(ByVal strInfoXML As String, _
                              ByRef intRowCnt As Integer, _
                              ByRef intColCnt As Integer, _
                              ByVal strCODE As String, _
                              ByVal strCODENAME As String, _
                              ByVal strDIV As String, _
                              ByVal strCLASSCD As String, _
                              ByVal strCLASSNM As String) As Object
        '.cmbDIV.value,.txtCLASSCD.value,.txtCLASSNM.value 
        Dim strSQL As String
        Dim strFormet, strSelFields, strWhere As String
        Dim strChkDate As String = ""
        Dim Con1, Con2, Con3, Con4, Con5 As String
        Dim vntData As Object

        With mobjSCGLConfig
            Try
                SetConfig(strInfoXML)   '기본정보 설정

                Con1 = ""
                Con2 = ""
                Con3 = ""
                Con4 = ""
                Con5 = ""
                If strCODE <> "" Then Con1 = String.Format(" AND (ITEMCODE = '{0}')", strCODE)
                If strCODENAME <> "" Then Con2 = String.Format(" AND (ITEMNAME LIKE '%{0}%')", strCODENAME)
                If strDIV <> "" Then Con3 = String.Format(" AND (DIV = '{0}')", strDIV)
                If strCLASSCD <> "" Then Con4 = String.Format(" AND (CLASS = '{0}')", strCLASSCD)
                If strCLASSNM <> "" Then Con5 = String.Format(" AND (CLASSNAME LIKE '%{0}%')", strCLASSNM)
                strWhere = BuildFields(" ", Con1, Con2, Con3, Con4, Con5)

                strSelFields = "ITEMCODE,DIV,CLASS,ITEM,DIVNAME,CLASSNAME,ITEMNAME,DETAIL_YN"

                strFormet = "select {0} FROM PD_ITEMCODE WHERE 1=1 {1} ORDER BY 1"


                strSQL = String.Format(strFormet, strSelFields, strWhere)

                .mobjSCGLSql.SQLConnect(.DBConnStr)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return vntData
            Catch err As Exception
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn")
            Finally
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function
    ' =============== 제작항목분류코드 조회
    Public Function SelectRtn_DTL(ByVal strInfoXML As String, _
                                  ByRef intRowCnt As Integer, _
                                  ByRef intColCnt As Integer, _
                                  ByVal strDIV As String, _
                                  ByVal strCLASSCD As String, _
                                  ByVal strCLASSNM As String) As Object
        '.cmbDIV.value,.txtCLASSCD.value,.txtCLASSNM.value 
        Dim strSQL As String
        Dim strFormet, strSelFields, strWhere As String
        Dim strChkDate As String = ""
        Dim Con1, Con2, Con3 As String
        Dim vntData As Object
        'DIVCD,CLASSCD,DIVNM,CLASSNM
        With mobjSCGLConfig
            Try
                SetConfig(strInfoXML)   '기본정보 설정

                Con1 = ""
                Con2 = ""
                Con3 = ""

                If strDIV <> "" Then Con1 = String.Format(" AND (DIVCD = '{0}')", strDIV)
                If strCLASSCD <> "" Then Con2 = String.Format(" AND (CLASSCD = '{0}')", strCLASSCD)
                If strCLASSNM <> "" Then Con3 = String.Format(" AND (CLASSNM LIKE '%{0}%')", strCLASSNM)
                strWhere = BuildFields(" ", Con1, Con2, Con3)

                strSelFields = "DIVCD,CLASSCD,DIVNM,CLASSNM"

                strFormet = "select {0} FROM PD_ITEMCLASSCODE WHERE 1=1 {1} ORDER BY 1"


                strSQL = String.Format(strFormet, strSelFields, strWhere)

                .mobjSCGLSql.SQLConnect(.DBConnStr)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return vntData
            Catch err As Exception
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_DTL")
            Finally
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function
    ''============== ProcessRtn ITEMCODE (외주항목코드) 신규 투입 및 외주항목명 변경 업데이트
    Public Function ProcessRtn(ByVal strInfoXML As String, _
                               ByVal vntData As Object) As Object '데이터 INSERT/UPDATE
        Dim intRtn As Integer
        Dim i, intColCnt, intRows As Integer
        Dim strACCDAY As String
        Dim dblSEQ As Integer
        Dim dblSUMAMT As Double
        Dim intHDR As Integer
        Dim strDIV As String
        Dim strCLASS As String
        Dim strITEM As String
        Dim strITEMCODE As String
        Dim strDETAIL_YN As String

        SetConfig(strInfoXML)

        With mobjSCGLConfig
            Try
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                If IsArray(vntData) Then
                    '''사용할 Entity 개체생성(Config 정보를 넘겨생성)
                    mobjcePD_ITEMCODE = New cePD_ITEMCODE(mobjSCGLConfig)
                    '''vntData의 컬럼수, 로우수를 변수입력
                    intColCnt = UBound(vntData, 1) : intRows = UBound(vntData, 2)
                    For i = 1 To intRows
                        strACCDAY = ""
                        If GetElement(vntData, "DETAIL_YN", intColCnt, i, OPTIONAL_STR) = "1" Then
                            strDETAIL_YN = "Y"
                        Else
                            strDETAIL_YN = "N"
                        End If


                        If GetElement(vntData, "ITEMCODE", intColCnt, i, OPTIONAL_STR) = "" Then

                            strDIV = GetElement(vntData, "DIV", intColCnt, i, OPTIONAL_STR)
                            strCLASS = GetElement(vntData, "CLASS", intColCnt, i, OPTIONAL_STR)
                            strITEM = SelectRtn_ITEMSEQNO(strDIV, strCLASS)
                            strITEMCODE = strDIV & strCLASS & strITEM
                            intRtn = InsertRtn(vntData, intColCnt, i, strITEM, strITEMCODE, strDETAIL_YN)
                        Else
                            intRtn = UpdateRtn(vntData, intColCnt, i, strDETAIL_YN)
                        End If
                    Next
                End If
                .mobjSCGLSql.SQLCommitTrans()
                Return intRows
            Catch err As Exception
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn")
            Finally
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_ITEMCODE.Dispose()
            End Try
        End With
    End Function

    '============== 외주항목코드 생성 
    Public Function SelectRtn_ITEMSEQNO(ByVal strDIV As String, _
                                        ByVal strCLASS As String) As String
        '여기부터 단순조회
        Dim strSQL, strFormat, strRtn As String
        'SetConfig(strInfoXML) '기본정보 Setting
        Dim strPRECODE As String
        With mobjSCGLConfig '기본정보 Config 개체

            Try
                strSQL = "SELECT DBO.LPAD(ISNULL(MAX(CAST(ITEM AS NUMERIC)),0)+1,3,'0') FROM PD_ITEMCODE WHERE DIV = '" & strDIV & "' AND CLASS = '" & strCLASS & "'"
                strRtn = .mobjSCGLSql.SQLSelectOneScalar(strSQL)
                Return strRtn
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_ITEMSEQNO")
            Finally
            End Try
        End With
        '여기까지 단순조회
    End Function
    '================외주항목코드 삭제
    Public Function DeleteRtn(ByVal strInfoXML As String, _
                              ByVal strITEMCODE As String, _
                              ByRef strERRORMSG As String) As Integer
        'PREESTNO,ITEMCODESEQ
        Dim intRtn As Integer      'Return변수( 처리건수 또는 0 )
        Dim intVal As Integer       '삭제판단 결정

        SetConfig(strInfoXML)    '기본정보 Setting
        With mobjSCGLConfig    '기본정보 Config 개체
            Try
                ' 사용할Entity 개체생성(Config 정보를 넘겨생성)
                mobjcePD_ITEMCODE = New cePD_ITEMCODE(mobjSCGLConfig)
                ' DB 접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                ' 엔티티 오브젝트의 Delete 메소드 호출

                intVal = SelectRtn_Val(strITEMCODE)

                If intVal = 0 Then
                    intRtn = mobjcePD_ITEMCODE.DeleteDo(strITEMCODE)
                Else
                    intRtn = 0
                    strERRORMSG = "견적및 외주정산 내역에 포함되어있는건은 삭제될수 없습니다."
                End If
                ' 트랜잭션 Commit
                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션 RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & "DeleteRtn")
            Finally
                'DB접속 종료
                .mobjSCGLSql.SQLDisconnect()
                '사용한 Entity(개체Dispose)
                mobjcePD_ITEMCODE.Dispose()
            End Try
        End With
    End Function
    '============== 외주항목코드 삭제전 사용여부 판별
    Public Function SelectRtn_Val(ByVal strITEMCODE As String) As Integer
        '여기부터 단순조회
        Dim strSQL, strFormat, strRtn As String
        'SetConfig(strInfoXML) '기본정보 Setting
        Dim strPRECODE As String
        With mobjSCGLConfig '기본정보 Config 개체

            Try
                strSQL = " SELECT"
                strSQL = strSQL & " SUM(CNT) CNT"
                strSQL = strSQL & " FROM"
                strSQL = strSQL & " ("
                strSQL = strSQL & " SELECT COUNT(ITEMCODE) CNT FROM PD_EXE_DTL WHERE ITEMCODE = '" & strITEMCODE & "'"
                strSQL = strSQL & " UNION ALL"
                strSQL = strSQL & " SELECT COUNT(ITEMCODE) CNT FROM PD_PREEST_DTL WHERE ITEMCODE = '" & strITEMCODE & "'"
                strSQL = strSQL & " ) DATA"

                strRtn = .mobjSCGLSql.SQLSelectOneScalar(strSQL)
                Return strRtn
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_Val")
            Finally
            End Try
        End With
        '여기까지 단순조회
    End Function


    ''============== ProcessRtn ITEMCODE (외주항목코드) 분류항목 신규 투입 및 분류항목명 변경 업데이트
    Public Function ProcessRtn_DTL(ByVal strInfoXML As String, _
                                   ByVal vntData As Object) As Object '데이터 INSERT/UPDATE
        Dim intRtn As Integer
        Dim i, intColCnt, intRows As Integer
        Dim strACCDAY As String
        Dim dblSEQ As Integer
        Dim dblSUMAMT As Double
        Dim intHDR As Integer
        Dim strDIV As String
        Dim strCLASS As String
        Dim strITEM As String
        Dim strCLASSNM As String
        Dim strCODE As String
        Dim strITEMCODE As String
        Dim intRtn2 As Integer
        SetConfig(strInfoXML)

        With mobjSCGLConfig
            Try
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                If IsArray(vntData) Then
                    '''사용할 Entity 개체생성(Config 정보를 넘겨생성)
                    mobjcePD_ITEMCLASSCODE = New cePD_ITEMCLASSCODE(mobjSCGLConfig)
                    '''vntData의 컬럼수, 로우수를 변수입력
                    intColCnt = UBound(vntData, 1) : intRows = UBound(vntData, 2)
                    For i = 1 To intRows
                        strACCDAY = ""
                        If GetElement(vntData, "DIVCD", intColCnt, i, OPTIONAL_STR) = "" Or GetElement(vntData, "CLASSCD", intColCnt, i, OPTIONAL_STR) = "" Then

                            'class코드를딸때 div로 따기때문에 div가 "" 이면 div의 MAX값을 구한다음 class 코드를 생성
                            If GetElement(vntData, "DIVCD", intColCnt, i, OPTIONAL_STR) = "" Then
                                strDIV = SelectRtn_DIVSEQNO()
                                strCLASS = SelectRtn_CLASSSEQNO(strDIV)

                                'div코드가 있다면 class코드는 있는div코드로 생성
                            Else
                                strDIV = GetElement(vntData, "DIVCD", intColCnt, i, OPTIONAL_STR)
                                strCLASS = SelectRtn_CLASSSEQNO(strDIV)
                            End If

                            intRtn = InsertRtn_CLASS(vntData, intColCnt, i, strDIV, strCLASS)
                        Else
                            strDIV = GetElement(vntData, "DIVCD", intColCnt, i, OPTIONAL_STR)
                            strCLASSNM = GetElement(vntData, "CLASSNM", intColCnt, i, OPTIONAL_STR)
                            strCODE = GetElement(vntData, "CLASSCD", intColCnt, i, OPTIONAL_STR)
                            intRtn = UpdateRtn_CLASS(vntData, intColCnt, i)
                            'intRtn2 = mobjcePD_ITEMCLASSCODE.Update_Batch(strDIV, strCODE, strCLASSNM)
                        End If
                    Next

                End If
                .mobjSCGLSql.SQLCommitTrans()
                Return intRows
            Catch err As Exception
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_DTL")
            Finally
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_ITEMCLASSCODE.Dispose()
            End Try
        End With
    End Function


    '============== 대분류항목코드 생성 
    Public Function SelectRtn_DIVSEQNO() As String
        '여기부터 단순조회
        Dim strSQL, strFormat, strRtn As String
        'SetConfig(strInfoXML) '기본정보 Setting
        Dim strPRECODE As String
        With mobjSCGLConfig '기본정보 Config 개체

            Try
                strSQL = "SELECT MAX(CAST(case DIVCD when '' then 0 else divcd end AS NUMERIC))+1 FROM PD_ITEMCLASSCODE"
                strRtn = .mobjSCGLSql.SQLSelectOneScalar(strSQL)
                Return strRtn
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_DIVSEQNO")
            Finally
            End Try
        End With
        '여기까지 단순조회
    End Function


    '============== 분류항목코드 생성 
    Public Function SelectRtn_CLASSSEQNO(ByVal strDIV As String) As String
        '여기부터 단순조회
        Dim strSQL, strFormat, strRtn As String
        'SetConfig(strInfoXML) '기본정보 Setting
        Dim strPRECODE As String
        With mobjSCGLConfig '기본정보 Config 개체

            Try
                strSQL = "SELECT DBO.LPAD(isnull(MAX(CAST(case classcd when '' then 0 else classcd end AS NUMERIC)),0)+1,2,'0') FROM PD_ITEMCLASSCODE WHERE DIVCD = '" & strDIV & "'"
                strRtn = .mobjSCGLSql.SQLSelectOneScalar(strSQL)
                Return strRtn
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_CLASSSEQNO")
            Finally
            End Try
        End With
        '여기까지 단순조회
    End Function
    '================외주항목코드 삭제
    Public Function DeleteRtn_DTL(ByVal strInfoXML As String, _
                                  ByVal strDIVCD As String, _
                                  ByVal strITEMCODE As String, _
                                  ByRef strERRORMSG As String) As Integer
        'PREESTNO,ITEMCODESEQ
        Dim intRtn As Integer      'Return변수( 처리건수 또는 0 )
        Dim intVal As Integer       '삭제판단 결정

        SetConfig(strInfoXML)    '기본정보 Setting
        With mobjSCGLConfig    '기본정보 Config 개체
            Try
                ' 사용할Entity 개체생성(Config 정보를 넘겨생성)
                mobjcePD_ITEMCLASSCODE = New cePD_ITEMCLASSCODE(mobjSCGLConfig)
                ' DB 접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                ' 엔티티 오브젝트의 Delete 메소드 호출

                intVal = SelectRtn_Val_DTL(strDIVCD, strITEMCODE)

                If intVal = 0 Then
                    intRtn = mobjcePD_ITEMCLASSCODE.DeleteDo(strDIVCD, strITEMCODE)
                Else
                    intRtn = 0
                    strERRORMSG = "외주항목코드에 존재하는 내역은 삭제가 될수 없습니다."
                End If
                ' 트랜잭션 Commit
                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션 RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & "DeleteRtn_DTL")
            Finally
                'DB접속 종료
                .mobjSCGLSql.SQLDisconnect()
                '사용한 Entity(개체Dispose)
                mobjcePD_ITEMCLASSCODE.Dispose()
            End Try
        End With
    End Function
    '============== 외주항목코드 삭제전 사용여부 판별
    Public Function SelectRtn_Val_DTL(ByVal strDIVCD As String, _
                                      ByVal strITEMCODE As String) As Integer
        '여기부터 단순조회
        Dim strSQL, strFormat, strRtn As String
        'SetConfig(strInfoXML) '기본정보 Setting
        Dim strPRECODE As String
        With mobjSCGLConfig '기본정보 Config 개체

            Try
                strSQL = " SELECT COUNT(*) CNT FROM PD_ITEMCODE WHERE DIV = '" & strDIVCD & "' AND CLASS = '" & strITEMCODE & "'"


                strRtn = .mobjSCGLSql.SQLSelectOneScalar(strSQL)
                Return strRtn
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_Val_DTL")
            Finally
            End Try
        End With
        '여기까지 단순조회
    End Function
#End Region
    'ITEMCODE,DIV,CLASS,ITEM,DIVNAME,CLASSNAME,ITEMNAME,DETAIL_YN
#Region "GROUP BLOCK : Entity Function Section"
    Private Function InsertRtn(ByVal vntData As Object, _
                               ByVal intColCnt As Integer, _
                               ByVal intRow As Integer, _
                               ByVal strITEM As String, _
                               ByVal strITEMCODE As String, _
                               ByVal strDETAIL_YN As String) As Integer
        Dim intRtn As Integer
        intRtn = mobjcePD_ITEMCODE.InsertDo( _
                                       strITEMCODE, _
                                       GetElement(vntData, "DIV", intColCnt, intRow), _
                                       GetElement(vntData, "CLASS", intColCnt, intRow), _
                                       strITEM, _
                                       GetElement(vntData, "DIVNAME", intColCnt, intRow), _
                                       GetElement(vntData, "CLASSNAME", intColCnt, intRow), _
                                       GetElement(vntData, "ITEMNAME", intColCnt, intRow), _
                                       strDETAIL_YN)
    End Function
    Private Function UpdateRtn(ByVal vntData As Object, _
                               ByVal intColCnt As Integer, _
                               ByVal intRow As Integer, _
                               ByVal strDETAIL_YN As String) As Integer
        Dim intRtn As Integer
        intRtn = mobjcePD_ITEMCODE.UpdateDo( _
                                       GetElement(vntData, "ITEMCODE", intColCnt, intRow), _
                                       GetElement(vntData, "DIV", intColCnt, intRow), _
                                       GetElement(vntData, "CLASS", intColCnt, intRow), _
                                       GetElement(vntData, "ITEM", intColCnt, intRow), _
                                       GetElement(vntData, "DIVNAME", intColCnt, intRow), _
                                       GetElement(vntData, "CLASSNAME", intColCnt, intRow), _
                                       GetElement(vntData, "ITEMNAME", intColCnt, intRow), _
                                       strDETAIL_YN)
        'Return intRtn
    End Function
    'DIVCD,CLASSCD,DIVNM,CLASSNM
    Private Function InsertRtn_CLASS(ByVal vntData As Object, _
                                     ByVal intColCnt As Integer, _
                                     ByVal intRow As Integer, _
                                     ByVal strDIVCD As String, _
                                     ByVal strCLASSCD As String) As Integer
        Dim intRtn As Integer
        intRtn = mobjcePD_ITEMCLASSCODE.InsertDo( _
                                       strDIVCD, _
                                       strCLASSCD, _
                                       GetElement(vntData, "DIVNM", intColCnt, intRow), _
                                       GetElement(vntData, "CLASSNM", intColCnt, intRow))
    End Function
    'DIVCD,CLASSCD,DIVNM,CLASSNM
    Private Function UpdateRtn_CLASS(ByVal vntData As Object, _
                                     ByVal intColCnt As Integer, _
                                     ByVal intRow As Integer) As Integer
        Dim intRtn As Integer
        intRtn = mobjcePD_ITEMCLASSCODE.UpdateDo( _
                                       GetElement(vntData, "DIVCD", intColCnt, intRow), _
                                       GetElement(vntData, "CLASSCD", intColCnt, intRow), _
                                       GetElement(vntData, "DIVNM", intColCnt, intRow), _
                                       GetElement(vntData, "CLASSNM", intColCnt, intRow))
        'Return intRtn
    End Function
#End Region
End Class

