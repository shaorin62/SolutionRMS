'****************************************************************************************
'Generated By  : Kim Tae Ho 
'시스템구분    : RMS/PD/Server Control Class
'실행   환경   : COM+ Service Server Package
'프로그램명    : ccPDCOPREESTSUB.vb
'기         능 : - 상세견적관리
'특이  사항    : - CE 단 Query 복사 기능
'                -
'----------------------------------------------------------------------------------------
'HISTORY    :1) 2009.10.19 Kim Tae Ho
'            2) 
'****************************************************************************************
Imports System.Xml                  ' XML처리
Imports SCGLControl                 ' ControlClass의 Base Class
Imports SCGLUtil.cbSCGLConfig       ' ConfigurationClass
Imports SCGLUtil.cbSCGLErr          '오류처리 클래스
Imports SCGLUtil.cbSCGLXml          'XML처리 클래스
Imports SCGLUtil.cbSCGLUtil         '기타유틸리티 클래스
Imports ePDCO
Public Class ccPDCOCFINPUT
    Inherits ccControl

#Region "GROUP BLOCK : 전역 또는 모듈레벨의 변수/상수 선언"
    Private CLASS_NAME = "ccPDCOCFINPUT"                  '자신의 클래스명
    Private mobjcePD_OUTLIST_MST As ePDCO.cePD_OUTLIST_MST            '견적헤더
#End Region

#Region "GROUP BLOCK : Function Section"
    ' =============== 견적 헤더 조회 ==>> 확정분이 있을경우(사용)
    Public Function SelectRtn(ByVal strInfoXML As String, _
                              ByRef intRowCnt As Integer, _
                              ByRef intColCnt As Integer, _
                              ByVal strPREESTNO As String) As String

        Dim strCols As String         '컬럼변수
        Dim strWhere As String       'Where조건 변수
        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim strXMLData As String    'XML  Return 변수(XML  을 사용할 때 선언)


        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보 Config 개체
            strSQL = " SELECT  "
            strSQL = strSQL & "A.PREESTNO PREESTNO, "
            strSQL = strSQL & "A.JOBNO JOBNO, "
            strSQL = strSQL & "DBO.MD_GET_HIGHCUSTNAME_FUN(A.CLIENTCODE) CLIENTNAME, "
            strSQL = strSQL & "CASE ISNULL(B.PRODUCT,'') WHEN '' THEN DBO.PD_JOBNAME_FUN(A.JOBNO) ELSE B.PRODUCT END AS PRODUCT, "
            strSQL = strSQL & "CASE ISNULL(B.PROJECT,'') WHEN '' THEN DBO.PD_PREESTNO_PROJECTNM_FUN(A.PREESTNO) ELSE B.PROJECT END AS PROJECT, "
            strSQL = strSQL & "B.PRODUCTIONNAME, "
            strSQL = strSQL & "B.DIRECTORNAME, "
            strSQL = strSQL & "B.EDIT, "
            strSQL = strSQL & "B.CG, "
            strSQL = strSQL & "B.TELECINE, "
            strSQL = strSQL & "B.RECORDING, "
            strSQL = strSQL & "B.CMSONG, "
            strSQL = strSQL & "B.STUDIO, "
            strSQL = strSQL & "B.MODELAGENCY, "
            strSQL = strSQL & "B.DATE, "
            strSQL = strSQL & "B.MEETINGDATE, "
            strSQL = strSQL & "B.SHOOTDATE, "
            strSQL = strSQL & "B.DAYS, "
            strSQL = strSQL & "B.HOURS, "
            strSQL = strSQL & "B.TITLE, "
            strSQL = strSQL & "B.LENGTHS, "
            strSQL = strSQL & "B.COMMENTS,CASE ISNULL(B.PREESTNO,'') WHEN '' THEN 'N' ELSE 'Y' END AS SAVEFLAG "
            strSQL = strSQL & "FROM PD_PREEST_HDR A LEFT JOIN PD_OUTLIST_MST B ON A.PREESTNO = B.PREESTNO WHERE A.PREESTNO = '" & strPREESTNO & "' "
            Try

                .mobjSCGLSql.SQLConnect(.DBConnStr)
                strXMLData = .mobjSCGLSql.SQLSelectXml(strSQL, intRowCnt, intColCnt)


                Return strXMLData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function
    'CF외주입력 저장처리
    Public Function ProcessRtn(ByVal strInfoXML As String, _
                               ByVal strMasterXML As String, _
                               ByVal strPREESTNO As String, _
                               ByVal strDATE As String, _
                               ByVal strMEETINGDATE As String, _
                               ByVal strSHOOTDATE As String) As Integer
        Dim intRtn As Integer '결과값 변수
        Dim strSAVEFLAG As String


        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보를 가지고 있는 Config 개체
            Try
                'XML Element 변수 선언 (strMasterXML을 변환)
                Dim xmlRoot As XmlElement
                xmlRoot = XMLGetRoot(strMasterXML) 'XML 데이터
                mobjcePD_OUTLIST_MST = New cePD_OUTLIST_MST(mobjSCGLConfig)
                'DB접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                '견적 헤더 저장
                strSAVEFLAG = XMLGetElement(xmlRoot, "SAVEFLAG")

                If strSAVEFLAG = "N" Then
                    '투입
                    intRtn = InsertRtn(xmlRoot, strPREESTNO, strDATE, strMEETINGDATE, strSHOOTDATE)
                Else
                    '데이터수정
                    intRtn = UpdateRtn(xmlRoot, strPREESTNO, strDATE, strMEETINGDATE, strSHOOTDATE)
                End If


                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn")
            Finally
                'Resource해제
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_OUTLIST_MST.Dispose()
            End Try
        End With
    End Function
    'CFinput 삭제 단순처리 
    Public Function DeleteRtn(ByVal strInfoXML As String, _
                              ByVal strPREESTNO As String) As Integer
        Dim intRtn As Integer '결과값 변수
        Dim strSAVEFLAG As String


        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보를 가지고 있는 Config 개체
            Try
                'XML Element 변수 선언 (strMasterXML을 변환)
               
                mobjcePD_OUTLIST_MST = New cePD_OUTLIST_MST(mobjSCGLConfig)
                'DB접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                'CF외주내역 삭제처리
                intRtn = mobjcePD_OUTLIST_MST.DeleteDo(strPREESTNO)
                


                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".DeleteRtn")
            Finally
                'Resource해제
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_OUTLIST_MST.Dispose()
            End Try
        End With
    End Function
#End Region

#Region "GROUP BLOCK : Entity Function Section"
    'strDATE,strMEETINGDATE,strSHOOTDATE 
    Private Function InsertRtn(ByVal xmlRoot As XmlElement, _
                               ByVal strPREESTNO As String, _
                               ByVal strDATE As String, _
                               ByVal strMEETINGDATE As String, _
                               ByVal strSHOOTDATE As String) As Integer
        Dim intRtn As Integer
      
        intRtn = mobjcePD_OUTLIST_MST.InsertDo( _
                                       XMLGetElement(xmlRoot, "PREESTNO"), _
                                       XMLGetElement(xmlRoot, "JOBNO"), _
                                       XMLGetElement(xmlRoot, "PRODUCTIONNAME"), _
                                       XMLGetElement(xmlRoot, "DIRECTORNAME"), _
                                       XMLGetElement(xmlRoot, "EDIT"), _
                                       XMLGetElement(xmlRoot, "CG"), _
                                       XMLGetElement(xmlRoot, "TELECINE"), _
                                       XMLGetElement(xmlRoot, "RECORDING"), _
                                       XMLGetElement(xmlRoot, "CMSONG"), _
                                       XMLGetElement(xmlRoot, "STUDIO"), _
                                       XMLGetElement(xmlRoot, "MODELAGENCY"), _
                                       strDATE, _
                                       strMEETINGDATE, _
                                       strSHOOTDATE, _
                                       XMLGetElement(xmlRoot, "DAYS"), _
                                       XMLGetElement(xmlRoot, "HOURS"), _
                                       XMLGetElement(xmlRoot, "TITLE"), _
                                       XMLGetElement(xmlRoot, "LENGTHS"), _
                                       XMLGetElement(xmlRoot, "COMMENTS"), _
                                       XMLGetElement(xmlRoot, "PRODUCT"), _
                                       XMLGetElement(xmlRoot, "PROJECT"), _
                                       XMLGetElement(xmlRoot, "ATTR01"), _
                                       XMLGetElement(xmlRoot, "ATTR02"), _
                                       XMLGetElement(xmlRoot, "ATTR03"), _
                                       XMLGetElement(xmlRoot, "ATTR04"), _
                                       XMLGetElement(xmlRoot, "ATTR05"), _
                                       XMLGetElement(xmlRoot, "ATTR06", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "ATTR07", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "ATTR08", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "ATTR09", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "ATTR10", NULL_NUM, True))
    End Function

    Private Function UpdateRtn(ByVal xmlRoot As XmlElement, _
                               ByVal strPREESTNO As String, _
                               ByVal strDATE As String, _
                               ByVal strMEETINGDATE As String, _
                               ByVal strSHOOTDATE As String) As Integer
        Dim intRtn As Integer
        intRtn = mobjcePD_OUTLIST_MST.UpdateDo( _
                                       XMLGetElement(xmlRoot, "PREESTNO"), _
                                       XMLGetElement(xmlRoot, "JOBNO"), _
                                       XMLGetElement(xmlRoot, "PRODUCTIONNAME"), _
                                       XMLGetElement(xmlRoot, "DIRECTORNAME"), _
                                       XMLGetElement(xmlRoot, "EDIT"), _
                                       XMLGetElement(xmlRoot, "CG"), _
                                       XMLGetElement(xmlRoot, "TELECINE"), _
                                       XMLGetElement(xmlRoot, "RECORDING"), _
                                       XMLGetElement(xmlRoot, "CMSONG"), _
                                       XMLGetElement(xmlRoot, "STUDIO"), _
                                       XMLGetElement(xmlRoot, "MODELAGENCY"), _
                                       strDATE, _
                                       strMEETINGDATE, _
                                       strSHOOTDATE, _
                                       XMLGetElement(xmlRoot, "DAYS"), _
                                       XMLGetElement(xmlRoot, "HOURS"), _
                                       XMLGetElement(xmlRoot, "TITLE"), _
                                       XMLGetElement(xmlRoot, "LENGTHS"), _
                                       XMLGetElement(xmlRoot, "COMMENTS"), _
                                       XMLGetElement(xmlRoot, "PRODUCT"), _
                                       XMLGetElement(xmlRoot, "PROJECT"), _
                                       XMLGetElement(xmlRoot, "ATTR01"), _
                                       XMLGetElement(xmlRoot, "ATTR02"), _
                                       XMLGetElement(xmlRoot, "ATTR03"), _
                                       XMLGetElement(xmlRoot, "ATTR04"), _
                                       XMLGetElement(xmlRoot, "ATTR05"), _
                                       XMLGetElement(xmlRoot, "ATTR06", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "ATTR07", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "ATTR08", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "ATTR09", NULL_NUM, True), _
                                       XMLGetElement(xmlRoot, "ATTR10", NULL_NUM, True))
    End Function

#End Region
End Class
