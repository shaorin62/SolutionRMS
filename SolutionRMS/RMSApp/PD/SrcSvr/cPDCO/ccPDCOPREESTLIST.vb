'****************************************************************************************
'Generated By  : Kim Tae Ho 
'시스템구분    : RMS/PD/Server Control Class
'실행   환경   : COM+ Service Server Package
'프로그램명    : ccPDCMPREESTLIST.vb
'기         능 : - 가견적관리
'특이  사항    : - CE 단 Query 복사 기능
'                -
'----------------------------------------------------------------------------------------
'HISTORY    :1) 2008.11.12 Kim Tae Ho
'            2) 
'****************************************************************************************

Imports System.Xml                  ' XML처리
Imports SCGLControl                 ' ControlClass의 Base Class
Imports SCGLUtil.cbSCGLConfig       ' ConfigurationClass
Imports SCGLUtil.cbSCGLErr          '오류처리 클래스
Imports SCGLUtil.cbSCGLXml          'XML처리 클래스
Imports SCGLUtil.cbSCGLUtil         '기타유틸리티 클래스
Imports ePDCO                       '엔터티 추가

' 엔티티 클래스 사용시 해당 엔티티 클래스의 프로젝트를 참조한 후 Imports 하십시요. 
' Imports 엔티티프로젝트
Public Class ccPDCOPREESTLIST
    Inherits ccControl
#Region "GROUP BLOCK : 전역 또는 모듈레벨의 변수/상수 선언"
    Private CLASS_NAME = "ccPDCOPREESTLIST"                  '자신의 클래스명
    Private mobjcePD_PREEST_HDR As ePDCO.cePD_PREEST_HDR            '사용할 Entity 변수 선언
    Private mobjcePD_CHARGE_TEMP As ePDCO.cePD_CHARGE_TEMP
    'Private Const .DBConnStr = "Provider=SQLOLEDB;Data Source=10.110.10.86;Initial Catalog=MCDEV;DSN=MCDEV;UID=devadmin;Pwd=password"
#End Region

#Region "GROUP BLOCK : Function Section"
    Public Function GetDataType(ByVal strInfoXML As String, _
                                ByRef intRowCnt As Integer, _
                                ByRef intColCnt As Integer) As Object



        Dim strSQL As String
        Dim vntData As Object

        SetConfig(strInfoXML)   '기본정보 설정

        'SQL문 생성
        strSQL = strSQL & " SELECT CODE, CODE_NAME"
        strSQL = strSQL & " FROM ("
        strSQL = strSQL & " 	SELECT '' CODE, '전체' CODE_NAME, 0 SORT_SEQ   "
        strSQL = strSQL & " 	UNION ALL"
        strSQL = strSQL & " 	SELECT CODE, CODE_NAME, SORT_SEQ"
        strSQL = strSQL & " 	FROM SC_CODE"
        strSQL = strSQL & " 	WHERE CLASS_CODE = 'PD_JOBKIND'"
        strSQL = strSQL & " ) A"
        strSQL = strSQL & " ORDER BY SORT_SEQ"

        With mobjSCGLConfig
            ''데이터 조회
            Try
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt)
                Return vntData
            Catch err As Exception
                Throw RaiseSysErr(err, CLASS_NAME & ".GetDataType")
            Finally
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    ' =============== 견적리스트 조회
    Public Function SelectRtn_List(ByVal strInfoXML As String, _
                                   ByRef intRowCnt As Integer, _
                                   ByRef intColCnt As Integer, _
                                   ByVal strFROM As String, _
                                   ByVal strTO As String, _
                                   ByVal strJOBNAME As String, _
                                   ByVal strJOBNO As String, _
                                   ByVal strJOBTYPE As String, _
                                   ByVal strCLIENTCODE As String, _
                                   ByVal strCLIENTNAME As String) As Object

        Dim strCols As String         '컬럼변수
        Dim strWhere As String       'Where조건 변수
        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim Con1, Con2, Con3, Con4, Con5, Con6

        With mobjSCGLConfig '기본정보 Config 개체
            Try
                SetConfig(strInfoXML) '기본정보 Setting

                Con1 = "" : Con2 = "" : Con3 = "" : Con4 = "" : Con5 = "" : Con6 = ""

                If strFROM <> "" And strTO <> "" Then
                    Con1 = String.Format(" AND (CONFIRMFLAG BETWEEN '{0}' AND  '{1}')", strFROM, strTO)
                End If
                If strFROM <> "" And strTO = "" Then
                    Con1 = String.Format(" AND (CONFIRMFLAG >= '{0}')", strFROM)
                End If
                If strFROM = "" And strTO <> "" Then
                    Con1 = String.Format(" AND (CONFIRMFLAG <= '{0}')", strTO)
                End If

                strJOBNAME = Replace(strJOBNAME, "'", "''")



                If strJOBNAME <> "" Then Con2 = String.Format(" AND (B.JOBNAME LIKE '%{0}%')", strJOBNAME)
                If strJOBNO <> "" Then Con3 = String.Format(" AND (A.JOBNO = '{0}')", strJOBNO)

                If strJOBTYPE <> "" Then Con4 = String.Format(" AND (B.JOBGUBN = '{0}')", strJOBTYPE)
                If strCLIENTCODE <> "" Then Con5 = String.Format(" AND (A.CLIENTCODE = '{0}')", strCLIENTCODE)
                If strCLIENTNAME <> "" Then Con6 = String.Format(" AND (DBO.SC_GET_HIGHCUSTNAME_FUN(A.CLIENTCODE) like '%{0}%')", strCLIENTNAME)

                strWhere = BuildFields(" ", Con1, Con2, Con3, Con4, Con5, Con6)

                strFormat = " SELECT 0 CHK,"
                strFormat = strFormat & " CASE A.CONFIRMGBN WHEN 'T' THEN '본견적' ELSE '가견적' END AS CONFIRMGBN, "
                strFormat = strFormat & " A.CONFIRMFLAG, "
                strFormat = strFormat & " A.JOBNO, "
                strFormat = strFormat & " B.JOBNAME, "
                strFormat = strFormat & " A.PREESTNAME, "
                strFormat = strFormat & " A.SUMAMT, "
                strFormat = strFormat & " A.MEMO,"
                strFormat = strFormat & " CASE WHEN ISNULL(A.CONFIRMFLAG,'') <> '' THEN '1' "
                strFormat = strFormat & " ELSE '2' "
                strFormat = strFormat & " END AS SORT_GBN ,"
                strFormat = strFormat & " A.PREESTNO,"
                strFormat = strFormat & " DBO.PD_ENDFLAGPREESTNO_FUN(A.PREESTNO) ENDFLAG"
                strFormat = strFormat & " FROM PD_PREEST_HDR A"
                strFormat = strFormat & " LEFT JOIN PD_JOBNO B ON A.JOBNO = B.JOBNO"
                strFormat = strFormat & " WHERE 1=1 {0} "
                strFormat = strFormat & " ORDER BY A.JOBNO, SORT_GBN, A.PREESTNO"

                strSQL = String.Format(strFormat, strWhere)

                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)

                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return vntData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_List")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    ' =============== 가견적시 해당 JOB 조회
    Public Function SelectRtn(ByVal strInfoXML As String, _
                              ByRef intRowCnt As Integer, _
                              ByRef intColCnt As Integer, _
                              ByVal strFROM As String, _
                              ByVal strTO As String, _
                              ByVal strJOBNAME As String, _
                              ByVal strJOBNO As String, _
                              ByVal strCLIENTSUBNAME As String, _
                              ByVal strCLIENTSUBCODE As String, _
                              ByVal strCLIENTCODE As String, _
                              ByVal strCLIENTNAME As String, _
                              ByVal strJOBGUBN As String, _
                              ByVal strENDFLAG As String) As Object

        Dim strWhere As String       'Where조건 변수
        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim Con1, Con2, Con3, Con4, Con5, Con6, Con7, Con8, Con9


        With mobjSCGLConfig '기본정보 Config 개체
            Try
                SetConfig(strInfoXML) '기본정보 Setting

                If strFROM <> "" And strTO <> "" Then
                    Con1 = String.Format(" AND (A.REQDAY BETWEEN '{0}' AND  '{1}')", strFROM, strTO)
                End If
                If strFROM <> "" And strTO = "" Then
                    Con1 = String.Format(" AND (A.REQDAY > '{0}')", strFROM)
                End If
                If strFROM = "" And strTO <> "" Then
                    Con1 = String.Format(" AND (A.REQDAY < '{0}')", strTO)
                End If

                strJOBNAME = Replace(strJOBNAME, "'", "''")

                If strJOBNAME <> "" Then Con2 = String.Format(" AND (A.JOBNAME like '%{0}%')", strJOBNAME)
                If strJOBNO <> "" Then Con3 = String.Format(" AND (A.JOBNO = '{0}')", strJOBNO)
                If strCLIENTSUBNAME <> "" Then Con4 = String.Format(" AND (LTRIM(DBO.MD_GET_CUSTNAME_FUN(A.CLIENTSUBCODE)) like '%{0}%')", strCLIENTSUBNAME)
                If strCLIENTSUBCODE <> "" Then Con5 = String.Format(" AND (A.CLIENTSUBCODE = '{0}')", strCLIENTSUBCODE)
                If strCLIENTCODE <> "" Then Con6 = String.Format(" AND (A.CLIENTCODE = '{0}')", strCLIENTCODE)
                If strCLIENTNAME <> "" Then Con7 = String.Format(" AND (LTRIM(DBO.MD_GET_CUSTNAME_FUN(A.CLIENTCODE)) like '%{0}%')", strCLIENTNAME)
                If strJOBGUBN <> "" Then Con8 = String.Format(" AND (A.JOBGUBN = '{0}')", strJOBGUBN)
                If strENDFLAG <> "" Then Con9 = String.Format(" AND (A.ENDFLAG = '{0}')", strENDFLAG)

                strWhere = BuildFields(" ", Con1, Con2, Con3, Con4, Con5, Con6, Con7, Con8, Con9)

                strFormat = " SELECT "
                strFormat = strFormat & " A.PROJECTNO, "
                strFormat = strFormat & " A.JOBNO,"
                strFormat = strFormat & " A.JOBNAME,"
                strFormat = strFormat & " DBO.MD_GET_CUSTNAME_FUN(A.CLIENTCODE) CLIENTNAME,"
                strFormat = strFormat & " A.CLIENTSUBCODE,"
                strFormat = strFormat & " DBO.MD_GET_CUSTNAME_FUN(A.CLIENTSUBCODE) CLIENTSUBNAME,"
                strFormat = strFormat & " A.SUBSEQ,"
                strFormat = strFormat & " DBO.PD_JOBCUST_NAME_FUN(A.SUBSEQ) SUBSEQNAME,"
                strFormat = strFormat & " DBO.MD_GETPUBNAME_FUN(A.ENDFLAG) ENDFLAG,"
                strFormat = strFormat & " DBO.MD_GETPUBNAME_FUN(A.JOBGUBN) JOBGUBN,"
                strFormat = strFormat & " DBO.MD_GETPUBNAME_FUN(A.CREPART) CREPART,"
                strFormat = strFormat & " DBO.MD_GETPUBNAME_FUN(A.CREGUBN) CREGUBN,"
                strFormat = strFormat & " REQDAY,DBO.PD_COMMITION_FUN(A.CLIENTCODE) COMMITION,A.CLIENTCODE,A.PREESTNO,ISNULL(B.SUMAMT,0) AMT, DEMANDYEARMON"
                strFormat = strFormat & " FROM V_JOBNO A LEFT JOIN PD_PREEST_HDR B ON A.PREESTNO = B.PREESTNO "
                strFormat = strFormat & " WHERE 1=1 {0} "
                strFormat = strFormat & " ORDER BY A.REQDAY "

                strSQL = String.Format(strFormat, strWhere)

                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                ' ------ Array 데이터 조회 (True 일때 헤더정보 포함 조회(Sheet Data Binding 할 경우 사용), False 일때 데이터만 조회)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return vntData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    ' =============== 가견적 LIST 조회
    Public Function SelectRtn_HDR(ByVal strInfoXML As String, _
                                  ByRef intRowCnt As Integer, _
                                  ByRef intColCnt As Integer, _
                                  ByVal strFROM As String, _
                                  ByVal strTO As String, _
                                  ByVal strJOBNAME As String, _
                                  ByVal strJOBNO As String, _
                                  ByVal strCLIENTSUBNAME As String, _
                                  ByVal strCLIENTSUBCODE As String, _
                                  ByVal strCLIENTCODE As String, _
                                  ByVal strCLIENTNAME As String, _
                                  ByVal strJOBGUBN As String, _
                                  ByVal strENDFLAG As String) As Object

        Dim strWhere As String       'Where조건 변수
        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim Con1, Con2, Con3, Con4, Con5, Con6, Con7, Con8, Con9


        With mobjSCGLConfig '기본정보 Config 개체
            Try
                SetConfig(strInfoXML) '기본정보 Setting

                If strFROM <> "" And strTO <> "" Then
                    Con1 = String.Format(" AND (CREDAY BETWEEN '{0}' AND  '{1}')", strFROM, strTO)
                End If
                If strFROM <> "" And strTO = "" Then
                    Con1 = String.Format(" AND (CREDAY > '{0}')", strFROM)
                End If
                If strFROM = "" And strTO <> "" Then
                    Con1 = String.Format(" AND (CREDAY < '{0}')", strTO)
                End If

                strJOBNAME = Replace(strJOBNAME, "'", "''")
                If strJOBNAME <> "" Then Con2 = String.Format(" AND (DBO.PD_JOBNAME_FUN(JOBNO) like '%{0}%')", strJOBNAME)
                If strJOBNO <> "" Then Con3 = String.Format(" AND (JOBNO = '{0}')", strJOBNO)
                If strCLIENTSUBNAME <> "" Then Con4 = String.Format(" AND (LTRIM(DBO.MD_GET_CUSTNAME_FUN(CLIENTSUBCODE)) like '%{0}%')", strCLIENTSUBNAME)
                If strCLIENTSUBCODE <> "" Then Con5 = String.Format(" AND (CLIENTSUBCODE = '{0}')", strCLIENTSUBCODE)
                If strCLIENTCODE <> "" Then Con6 = String.Format(" AND (CLIENTCODE = '{0}')", strCLIENTCODE)
                If strCLIENTNAME <> "" Then Con7 = String.Format(" AND (LTRIM(DBO.MD_GET_CUSTNAME_FUN(CLIENTCODE)) like '%{0}%')", strCLIENTNAME)
                If strJOBGUBN <> "" Then Con8 = String.Format(" AND (DBO.PD_JOBGUBN_FUN(JOBNO) = '{0}')", strJOBGUBN)
                If strENDFLAG <> "" Then Con9 = String.Format(" AND (DBO.PD_ENDFLAG_FUN(JOBNO) = '{0}')", strENDFLAG)

                strWhere = BuildFields(" ", Con1, Con2, Con3, Con4, Con5, Con6, Con7, Con8, Con9)

                strFormat = " SELECT "
                strFormat = strFormat & " JOBNO,DBO.PD_JOBNAME_FUN(JOBNO) JOBNAME, "
                strFormat = strFormat & " PREESTNO,PREESTNAME, "
                strFormat = strFormat & " SUMAMT AMT,MEMO,CREDAY, "
                strFormat = strFormat & " CLIENTSUBCODE, "
                strFormat = strFormat & " DBO.PD_JOBCONFIRM_FUN(JOBNO,PREESTNO) CONF "
                strFormat = strFormat & " FROM PD_PREEST_HDR "
                strFormat = strFormat & " WHERE 1=1 {0} "
                strFormat = strFormat & " ORDER BY PREESTNO DESC "

                strSQL = String.Format(strFormat, strWhere)

                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return vntData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_HDR")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function
    ' =============== 가견적 LIST 조회
    Public Function SelectRtn_HDR2(ByVal strInfoXML As String, _
                                  ByRef intRowCnt As Integer, _
                                  ByRef intColCnt As Integer, _
                                  ByVal strFROM As String, _
                                  ByVal strTO As String, _
                                  ByVal strJOBNAME As String, _
                                  ByVal strJOBNO As String, _
                                  ByVal strCLIENTCODE As String, _
                                  ByVal strCLIENTNAME As String) As Object

        Dim strWhere As String       'Where조건 변수
        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim Con1, Con2, Con3, Con6, Con7



        With mobjSCGLConfig '기본정보 Config 개체
            Try
                SetConfig(strInfoXML) '기본정보 Setting

                If strFROM <> "" And strTO <> "" Then
                    Con1 = String.Format(" AND (CREDAY BETWEEN '{0}' AND  '{1}')", strFROM, strTO)
                End If
                If strFROM <> "" And strTO = "" Then
                    Con1 = String.Format(" AND (CREDAY > '{0}')", strFROM)
                End If
                If strFROM = "" And strTO <> "" Then
                    Con1 = String.Format(" AND (CREDAY < '{0}')", strTO)
                End If

                strJOBNAME = Replace(strJOBNAME, "'", "''")
                If strJOBNAME <> "" Then Con2 = String.Format(" AND (DBO.PD_JOBNAME_FUN(JOBNO) like '%{0}%')", strJOBNAME)
                If strJOBNO <> "" Then Con3 = String.Format(" AND (JOBNO = '{0}')", strJOBNO)

                If strCLIENTCODE <> "" Then Con6 = String.Format(" AND (CLIENTCODE = '{0}')", strCLIENTCODE)
                If strCLIENTNAME <> "" Then Con7 = String.Format(" AND (LTRIM(DBO.MD_GET_CUSTNAME_FUN(CLIENTCODE)) like '%{0}%')", strCLIENTNAME)

                strWhere = BuildFields(" ", Con1, Con2, Con3, Con6, Con7)

                strFormat = " SELECT "
                strFormat = strFormat & " JOBNO,DBO.PD_JOBNAME_FUN(JOBNO) JOBNAME, "
                strFormat = strFormat & " PREESTNO,PREESTNAME, "
                strFormat = strFormat & " SUMAMT AMT,MEMO,CREDAY, "
                strFormat = strFormat & " CLIENTSUBCODE, "
                strFormat = strFormat & " DBO.PD_JOBCONFIRM_FUN(JOBNO,PREESTNO) CONF "
                strFormat = strFormat & " FROM PD_PREEST_HDR "
                strFormat = strFormat & " WHERE 1=1 {0} "
                strFormat = strFormat & " ORDER BY PREESTNO DESC "

                strSQL = String.Format(strFormat, strWhere)

                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return vntData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_HDR2")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function




    '============== ProcessRtn PROJECT 코드 수정
    Public Function ProcessRtn(ByVal strInfoXML As String, _
                               ByVal vntData As Object) As Integer '데이터 INSERT/UPDATE
        Dim intRtn As Integer
        Dim i, intColCnt, intRows As Integer
        Dim strCODE As String
        Dim strPRECODE As String
        Dim strGROUPGBN
        Dim strJOBNO As String
        Dim intRtnUpdate As Integer
        SetConfig(strInfoXML)
        With mobjSCGLConfig
            Try

                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                If IsArray(vntData) Then
                    '''사용할 Entity 개체생성(Config 정보를 넘겨생성)
                    mobjcePD_PREEST_HDR = New cePD_PREEST_HDR(mobjSCGLConfig)
                    '''vntData의 컬럼수, 로우수를 변수입력
                    intColCnt = UBound(vntData, 1) : intRows = UBound(vntData, 2)
                    For i = 1 To intRows
                        strCODE = SelectRtn_SEQNO()
                        Select Case GetFlagMode(vntData(0, i))
                            Case meINS_TRANS
                                intRtn = InsertRtn(vntData, intColCnt, i, strCODE)
                                strJOBNO = GetElement(vntData, "JOBNO", intColCnt, i)
                                intRtnUpdate = mobjcePD_PREEST_HDR.UpdateENDFLAG(strJOBNO)
                            Case meUPD_TRANS
                                intRtn = UpdateRtn(vntData, intColCnt, i)
                        End Select
                    Next
                End If
                .mobjSCGLSql.SQLCommitTrans()
                Return intRows
            Catch err As Exception
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn")
            Finally
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_PREEST_HDR.Dispose()
            End Try
        End With
    End Function
    Public Function ProcessRtn_COPY(ByVal strInfoXML As String, _
                                    ByVal strOLDCODE As String, _
                                    ByVal strJOBNO As String, _
                                    ByVal strCREDAY As String, _
                                    ByVal strCLIENTSUBCODE As String, _
                                    ByVal strCOMMITION As Double, _
                                    ByVal strCLIENTCODE As String, _
                                    ByVal strSUBSEQ As String) As Integer '데이터 INSERT/UPDATE

        'strCREDAY,strCLIENTSUBCODE,strCOMMITION,strCLIENTCODE   ''" &  & "'
        Dim intRtn As Integer
        Dim i, intColCnt, intRows As Integer
        Dim strCODE As String

        Dim strSQL As String
        SetConfig(strInfoXML)
        With mobjSCGLConfig
            Try

                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()

                mobjcePD_PREEST_HDR = New cePD_PREEST_HDR(mobjSCGLConfig)

                strCODE = SelectRtn_SEQNO()

                strSQL = " INSERT INTO PD_PREEST_HDR"
                strSQL = strSQL & " (PREESTNO,PREESTNAME,JOBNO,AMT,MEMO,CREDAY,CLIENTSUBCODE,CONFIRMFLAG,SUSUAMT,SUSURATE,COMMITION,NONCOMMITION,SUMAMT,CLIENTCODE,SUBSEQ)"
                strSQL = strSQL & " SELECT"
                strSQL = strSQL & " '" & strCODE & "' PREESTNO,PREESTNAME,'" & strJOBNO & "' JOBNO,AMT,'" & strOLDCODE & "'+' 에서내역복사 되었습니다' MEMO,'" & strCREDAY & "' CREDAY,'" & strCLIENTSUBCODE & "' CLIENTSUBCODE,'' CONFIRMFLAG,SUSUAMT," & strCOMMITION & " SUSURATE,COMMITION,NONCOMMITION,SUMAMT,'" & strCLIENTCODE & "' CLIENTCODE,'" & strSUBSEQ & "' SUBSEQ"
                strSQL = strSQL & " FROM PD_PREEST_HDR"
                strSQL = strSQL & " WHERE PREESTNO = '" & strOLDCODE & "';"
                strSQL = strSQL & " INSERT INTO PD_PREEST_DTL"
                strSQL = strSQL & " (PREESTNO,ITEMCODESEQ,ITEMCODE,PRINT_SEQ,STD,COMMIFLAG,QTY,PRICE,AMT,FAKENAME)"
                strSQL = strSQL & " SELECT"
                strSQL = strSQL & " '" & strCODE & "' PREESTNO,ITEMCODESEQ,ITEMCODE,PRINT_SEQ,STD,COMMIFLAG,QTY,PRICE,AMT,FAKENAME"
                strSQL = strSQL & " FROM PD_PREEST_DTL"
                strSQL = strSQL & " WHERE PREESTNO = '" & strOLDCODE & "';UPDATE PD_JOBNO SET ENDFLAG = 'PF02' WHERE JOBNO = '" & strJOBNO & "'"


                intRtn = mobjcePD_PREEST_HDR.InsertRtn_COPY(strSQL)



                .mobjSCGLSql.SQLCommitTrans()
                Return intRows
            Catch err As Exception
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_COPY")
            Finally
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_PREEST_HDR.Dispose()
            End Try
        End With
    End Function

    ''============== ProcessRtn PROJECT CODE 생성
    Public Function SelectRtn_SEQNO() As String
        '여기부터 단순조회
        Dim strSQL, strFormat, strRtn As String
        'SetConfig(strInfoXML) '기본정보 Setting
        Dim strPRECODE As String
        With mobjSCGLConfig '기본정보 Config 개체

            Try
                strPRECODE = "substring(CAST(DATEPART(YEAR,GETDATE()) AS VARCHAR(4)),3,2)  + RIGHT('00' + CAST(DATEPART(MONTH,GETDATE()) AS VARCHAR(2)), 2)+ RIGHT('00' + CAST(DATEPART(DAY,GETDATE()) AS VARCHAR(2)), 2)"
                strSQL = "SELECT " & strPRECODE & "+DBO.LPAD(ISNULL(MAX(CAST(SUBSTRING(PREESTNO,7,4) AS NUMERIC(4,0))),0)+1,4,'0') FROM PD_PREEST_HDR WHERE SUBSTRING(PREESTNO,1,6) = " & strPRECODE
                strRtn = .mobjSCGLSql.SQLSelectOneScalar(strSQL)
                Return strRtn
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_SEQNO")
            Finally
            End Try
        End With
        '여기까지 단순조회
    End Function

    '================견적 삭제(사용)
    Public Function DeleteRtn(ByVal strInfoXML As String, _
                              ByVal strPREESTNO As String) As Integer
        Dim intRtn As Integer      'Return변수( 처리건수 또는 0 )
        Dim strSQL As String


        SetConfig(strInfoXML)    '기본정보 Setting
        With mobjSCGLConfig    '기본정보 Config 개체
            Try
                ' 사용할Entity 개체생성(Config 정보를 넘겨생성)
                mobjcePD_PREEST_HDR = New cePD_PREEST_HDR(mobjSCGLConfig)
                ' DB 접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()

                'strSQL = "select 1"
                strSQL = "UPDATE PD_JOBNO SET PREESTNO = ''  "
                strSQL = strSQL & "FROM PD_PREEST_HDR B  "
                strSQL = strSQL & "WHERE PD_JOBNO.PREESTNO = B.PREESTNO AND B.PREESTNO = '" & strPREESTNO & "'; "
                strSQL = strSQL & "DELETE FROM PD_PREEST_HDR WHERE PREESTNO = '" & strPREESTNO & "'; "
                strSQL = strSQL & "DELETE FROM PD_PREEST_DTL WHERE PREESTNO = '" & strPREESTNO & "'; "
                strSQL = strSQL & "DELETE FROM PD_SUBITEM_DTL WHERE PREESTNO = '" & strPREESTNO & "'; "
                strSQL = strSQL & "DELETE FROM PD_PRODUCTIONCOMMI_DTL WHERE PREESTNO = '" & strPREESTNO & "'; "
                strSQL = strSQL & "DELETE FROM PD_PRODUCTIONCOMMI_HDR WHERE PREESTNO = '" & strPREESTNO & "'; "
                strSQL = strSQL & "DELETE FROM PD_OUTLIST_MST WHERE PREESTNO = '" & strPREESTNO & "'; "
                strSQL = strSQL & "DELETE FROM PD_DIVAMT WHERE PREESTNO = '" & strPREESTNO & "' AND isnull(ENDFLAG,'PF01') IN ('PF01','PF02') AND isnull(ADJAMT,0) = 0; "
                strSQL = strSQL & "DELETE FROM PD_DEMAND_DTL WHERE PREESTNO = '" & strPREESTNO & "'; "
                strSQL = strSQL & "DELETE FROM PD_DEMAND_MST WHERE PREESTNO = '" & strPREESTNO & "'; "

                strSQL = strSQL & "DELETE FROM PD_PREEST_ESTIMATE_HDR WHERE PREESTNO = '" & strPREESTNO & "'; "
                strSQL = strSQL & "DELETE FROM PD_PREEST_ESTIMATE_DTL WHERE PREESTNO = '" & strPREESTNO & "'; "


                intRtn = mobjcePD_PREEST_HDR.NewDelete(strSQL)
                '간접비 항목 삭제 일경우

                ' 트랜잭션 Commit
                .mobjSCGLSql.SQLCommitTrans()

                Return intRtn
            Catch err As Exception
                '트랜잭션 RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & "DeleteRtn")
            Finally
                'DB접속 종료
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_PREEST_HDR.Dispose()
            End Try
        End With
    End Function


    Public Function DeleteRtn_Check(ByVal strInfoXML As String, _
                                    ByRef intRowCnt As Integer, _
                                    ByRef intColCnt As Integer, _
                                    ByVal strJOBNO As String, _
                                    ByVal strPREESTNO As String) As Object     'XML  데이터 조회시

        Dim strSQL As String
        Dim strFormat, strSelFields, strWhere As String
        Dim Con1, Con2 As String
        Dim vntData As Object
        Dim strField

        With mobjSCGLConfig
            Try
                SetConfig(strInfoXML)   '기본정보 설정

                Con1 = ""
                Con2 = ""

                If strJOBNO <> "" Then Con1 = String.Format(" AND (JOBNO = '{0}')", strJOBNO)
                If strPREESTNO <> "" Then Con2 = String.Format(" AND (PREESTNO = {0})", strPREESTNO)

                strWhere = BuildFields(" ", Con1, Con2)

                strFormat = strFormat & "  SELECT "
                strFormat = strFormat & "  TRANSYEARMON,"
                strFormat = strFormat & "  TRANSNO"
                strFormat = strFormat & "  FROM PD_DIVAMT"
                strFormat = strFormat & "  WHERE 1=1 {0} "
                strFormat = strFormat & "  AND (ISNULL(CONFIRMFLAG, '0') >= '3' or (isnull(ENDFLAG,'PF01') IN ('PF01','PF02') AND isnull(ADJAMT,0) <> 0))"

                '거래명세서 생성시 청구지만 매니저승인 CONFIRMFLAG >= 3  인것이 지워지면 안됨.

                'strFormat = strFormat & "  AND ISNULL(TRANSYEARMON, '') <> ''"
                'strFormat = strFormat & "  AND ISNULL(CAST(TRANSNO AS VARCHAR(10)), '') <> ''"

                strSQL = String.Format(strFormat, strWhere)

                .mobjSCGLSql.SQLConnect(.DBConnStr)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt)
                Return vntData
            Catch err As Exception
                Throw RaiseSysErr(err, CLASS_NAME & ".DeleteRtn_Check")
            Finally
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    '================모든 견적 삭제시 플레그변경(사용)
    Public Function FlagUpdateRtn(ByVal strInfoXML As String, _
                                  ByVal strJOBNO As String) As Integer

        Dim intRtn As Integer
        Dim strSQL As String

        SetConfig(strInfoXML)    '기본정보 Setting
        With mobjSCGLConfig    '기본정보 Config 개체
            Try
                ' 사용할Entity 개체생성(Config 정보를 넘겨생성)
                mobjcePD_PREEST_HDR = New cePD_PREEST_HDR(mobjSCGLConfig)
                ' DB 접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()


                strSQL = "UPDATE PD_JOBNO SET ENDFLAG = 'PF01' WHERE JOBNO = '" & strJOBNO & "' "

                intRtn = mobjcePD_PREEST_HDR.NewDelete(strSQL)
                '전체 항목이 삭제되었을때 견적에서 의뢰로 변경 된다.

                ' 트랜잭션 Commit
                .mobjSCGLSql.SQLCommitTrans()

                Return intRtn
            Catch err As Exception
                '트랜잭션 RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & "FlagUpdateRtn")
            Finally
                'DB접속 종료
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_PREEST_HDR.Dispose()
            End Try
        End With
    End Function

    Public Function Get_PREEST_CNT(ByVal strInfoXML As String, _
                                   ByRef intRowCnt As Integer, _
                                   ByRef intColCnt As Integer, _
                                   ByVal strPREESTNO As String) As Object

        Dim strSQL As String            'SQL문
        Dim strFormet As String         '임시 SQL문
        Dim strSelFields As String      '조회필드
        Dim strWhere As String
        Dim vntData As Object
        Dim Con1 As String

        SetConfig(strInfoXML)   '기본정보 설정
        With mobjSCGLConfig

            Con1 = ""

            If strPREESTNO <> "" Then Con1 = String.Format(" AND (preestno = '{0}')", strPREESTNO)

            strWhere = BuildFields(" ", Con1)

            strFormet = strFormet & " select itemcodename, sortgbn"
            strFormet = strFormet & " from("
            strFormet = strFormet & " 	select '(1)정가항목' itemcodename, 1 sortgbn"
            strFormet = strFormet & " 	from pd_preest_dtl"
            strFormet = strFormet & " 	where substring(itemcode,1,1) = 1"
            strFormet = strFormet & " 	{0} "
            strFormet = strFormet & " 	group by preestno"
            strFormet = strFormet & " 	union all"
            strFormet = strFormet & " 	select dbo.pd_itemcodename_fun(itemcode) itemcodename, 1 sortgbn"
            strFormet = strFormet & " 	from pd_preest_dtl"
            strFormet = strFormet & " 	where substring(itemcode,1,1) = 1"
            strFormet = strFormet & " 	{0} "
            strFormet = strFormet & " 	union all"
            strFormet = strFormet & " 	select '' itemcodename, 1 sortgbn"
            strFormet = strFormet & " 	from pd_preest_dtl"
            strFormet = strFormet & " 	where substring(itemcode,1,1) = 1"
            strFormet = strFormet & " 	{0} "
            strFormet = strFormet & " 	group by preestno"
            strFormet = strFormet & " 	union all"
            strFormet = strFormet & " 	select itemcodename, sortgbn"
            strFormet = strFormet & " 	from ("
            strFormet = strFormet & " 		select '(소계)' itemcodename, 1 sortgbn, preestno"
            strFormet = strFormet & " 		from pd_preest_dtl"
            strFormet = strFormet & " 		where substring(itemcode,1,1) = 1"
            strFormet = strFormet & " 		{0} "
            strFormet = strFormet & " 		group by preestno"
            strFormet = strFormet & " 	) sss"
            strFormet = strFormet & " 	where 1=1 {0} "
            strFormet = strFormet & " 	union"
            strFormet = strFormet & " 	select '(2)외주항목' itemcodename, 2 sortgbn"
            strFormet = strFormet & " 	from pd_preest_dtl"
            strFormet = strFormet & " 	where substring(itemcode,1,1) = 2"
            strFormet = strFormet & " 	{0} "
            strFormet = strFormet & " 	group by preestno"
            strFormet = strFormet & " 	union all"
            strFormet = strFormet & " 	select dbo.pd_itemcodename_fun(itemcode) itemcodename, 2 sortgbn"
            strFormet = strFormet & " 	from pd_preest_dtl"
            strFormet = strFormet & " 	where substring(itemcode,1,1) = 2"
            strFormet = strFormet & " 	{0}	"
            strFormet = strFormet & " ) aaa"

            strSQL = String.Format(strFormet, strWhere)
            '데이터 조회
            Try
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return vntData
            Catch err As Exception
                Throw RaiseSysErr(err, CLASS_NAME & ".Get_ELETRANS_CNT")
            Finally
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    ' ============== ProcessRtn_TEMP (Master & Detail) Sample Code 
    Public Function ProcessRtn_TEMP(ByVal strInfoXML As String, _
                                    ByVal strPREESTNO As String, _
                                    ByVal dblDATACNT As Double, _
                                    ByRef strUSERID As String) As Integer

        Dim intRtn As Integer  '결과값 변수
        Dim i, intColCnt, intRows As Integer '루프, 컬럼Cnt, 로우Cnt 변수
        Dim intCnt

        SetConfig(strInfoXML) '기본정보 Setting

        With mobjSCGLConfig '기본정보를 가지고 있는 Config 개체
            Try
                'DB접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                'Master 데이터 처리
                mobjcePD_CHARGE_TEMP = New cePD_CHARGE_TEMP(mobjSCGLConfig)
                strUSERID = .WRKUSR 'USERID 를 받아야 출력시에 USERID에 따른 구분을 둘수있다.
                intRtn = InsertRtn_CHARGE_TEMP(strPREESTNO, dblDATACNT)
                mobjcePD_CHARGE_TEMP.Dispose()
                '트랜잭션Commit
                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_TEMP")
            Finally
                'Resource해제
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_CHARGE_TEMP.Dispose()
            End Try
        End With
    End Function

    '거래명서표출력을 위해 기존 TEMP테이블의 내용을 삭제한다.
    Public Function DeleteRtn_temp(ByVal strInfoXML As String) As Integer   '데이터 DELETE

        Dim intRtn As Integer      'Return변수( 처리건수 또는 0 )

        SetConfig(strInfoXML)    '기본정보 Setting
        With mobjSCGLConfig    '기본정보 Config 개체
            Try
                ' 사용할Entity 개체생성(Config 정보를 넘겨생성)
                mobjcePD_CHARGE_TEMP = New cePD_CHARGE_TEMP(mobjSCGLConfig)
                ' DB 접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                ' 엔티티 오브젝트의 Delete 메소드 호출
                intRtn = mobjcePD_CHARGE_TEMP.DeleteDo(.WRKUSR)
                ' 트랜잭션 Commit
                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션 RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & "DeleteRtn_temp")
            Finally
                'DB접속 종료
                .mobjSCGLSql.SQLDisconnect()
                '사용한 Entity(개체Dispose)
                mobjcePD_CHARGE_TEMP.Dispose()
            End Try
        End With
    End Function

    '견적 리스트의 내역을 내역복사한다.
    Public Function ProcessRtn_DataCopy(ByVal strInfoXML As String, _
                                        ByVal strPREESTNO As String, _
                                        ByRef strNewPREESTNO As String, _
                                        ByRef strJOBNO As String) As Integer

        Dim intRtn As Integer '결과값 변수
        Dim strSQL As String
        Dim strUSER As String
        Dim strNow As String


        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보를 가지고 있는 Config 개체
            Try
                'XML Element 변수 선언 (strMasterXML을 변환)

                mobjcePD_PREEST_HDR = New cePD_PREEST_HDR(mobjSCGLConfig)
                'DB접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                '견적 헤더 저장

                strUSER = .WRKUSR
                strNow = Now

                strNewPREESTNO = SelectRtn_ESTSEQNO()

                strSQL = " INSERT INTO PD_PREEST_HDR  "
                strSQL = strSQL & "(PREESTNO,PREESTNAME,JOBNO,AMT,MEMO,CREDAY,TIMCODE,CONFIRMFLAG,SUSUAMT,SUSURATE,COMMITION,NONCOMMITION, "
                strSQL = strSQL & "SUMAMT,CLIENTCODE,SUBSEQ,CONFIRMGBN,CUSER,CDATE,UUSER,UDATE) "

                strSQL = strSQL & "SELECT "
                strSQL = strSQL & "'" & strNewPREESTNO & "' PREESTNO,PREESTNAME+' 복사' PREESTNAME, '" & strJOBNO & "' JOBNO, AMT, MEMO, CREDAY, DBO.PD_JOBTIMCODE_FUN('" & strJOBNO & "') TIMCODE, CONFIRMFLAG, SUSUAMT, SUSURATE, COMMITION, NONCOMMITION, "
                strSQL = strSQL & "SUMAMT,dbo.PD_JOBCLIENTCODE_FUN('" & strJOBNO & "') clientcode,DBO.PD_JOBNO_SUBSEQCODE_FUN('" & strJOBNO & "') SUBSEQ,'F' CONFIRMGBN,'" & strUSER & "' CUSER,'" & strNow & "' CDATE,'" & strUSER & "' UUSER,'" & strNow & "' UDATE "
                strSQL = strSQL & "FROM PD_PREEST_HDR WHERE PREESTNO = '" & strPREESTNO & "'; "

                strSQL = strSQL & "INSERT INTO PD_PREEST_DTL "
                strSQL = strSQL & "(PREESTNO,ITEMCODESEQ,ITEMCODE,STD,COMMIFLAG,QTY,PRICE,AMT,FAKENAME,SUSUAMT,SUBDETAIL,IMESEQ, PRINT_SEQ,CUSER,CDATE,UUSER,UDATE) "
                strSQL = strSQL & "SELECT "
                strSQL = strSQL & "'" & strNewPREESTNO & "' PREESTNO,ITEMCODESEQ,ITEMCODE,STD,COMMIFLAG,QTY,PRICE,AMT,FAKENAME,SUSUAMT,SUBDETAIL,IMESEQ, CASE ISNULL(PRINT_SEQ,0) WHEN 0 THEN IMESEQ ELSE PRINT_SEQ END ,'" & strUSER & "' CUSER,'" & strNow & "' CDATE,'" & strUSER & "' UUSER,'" & strNow & "' UDATE "
                strSQL = strSQL & "FROM PD_PREEST_DTL WHERE PREESTNO = '" & strPREESTNO & "'; "

                strSQL = strSQL & "INSERT INTO PD_SUBITEM_DTL "
                strSQL = strSQL & "(PREESTNO,SEQ,SUBITEMCODESEQ,ITEMCODESEQ,ITEMCODE,IMESEQ, PRINT_SEQ, SORTSEQ,PRICE,QTY,TERM,AMT,MEMO,CONFIRMGBN,SUBITEMNAME,ATTR01,CUSER,CDATE,UUSER,UDATE) "
                strSQL = strSQL & "SELECT "
                strSQL = strSQL & "'" & strNewPREESTNO & "' PREESTNO,SEQ,SUBITEMCODESEQ,ITEMCODESEQ,ITEMCODE,IMESEQ,CASE ISNULL(PRINT_SEQ,0) WHEN 0 THEN SUBITEMCODESEQ ELSE PRINT_SEQ END, SORTSEQ,"
                strSQL = strSQL & "CASE CONFIRMGBN WHEN 'T' THEN EXEPRICE ELSE PRICE END PRICE,"
                strSQL = strSQL & "CASE CONFIRMGBN WHEN 'T' THEN EXEQTY ELSE QTY END QTY,"
                strSQL = strSQL & "CASE CONFIRMGBN WHEN 'T' THEN EXETERM ELSE TERM END TERM,"
                strSQL = strSQL & "CASE CONFIRMGBN WHEN 'T' THEN EXEAMT ELSE AMT END AMT,"
                strSQL = strSQL & "CASE CONFIRMGBN WHEN 'T' THEN EXEMEMO ELSE MEMO END MEMO,"
                strSQL = strSQL & "'F' CONFIRMGBN,SUBITEMNAME,'" & strJOBNO & "','" & strUSER & "' CUSER,'" & strNow & "' CDATE,'" & strUSER & "' UUSER,'" & strNow & "' UDATE "
                strSQL = strSQL & "FROM PD_SUBITEM_DTL WHERE PREESTNO = '" & strPREESTNO & "'; "

                'strSQL = strSQL & "INSERT INTO PD_PRODUCTIONCOMMI_HDR "
                'strSQL = strSQL & "(PREESTNO, AMT, COMMIRATE, MEMO, CUSER, CDATE, UUSER, UDATE) "
                'strSQL = strSQL & "SELECT  "
                'strSQL = strSQL & "'" & strNewPREESTNO & "' PREESTNO,AMT,COMMIRATE,MEMO,'" & strUSER & "' CUSER,'" & strNow & "' CDATE,'" & strUSER & "' UUSER,'" & strNow & "' UDATE "
                'strSQL = strSQL & "FROM PD_PRODUCTIONCOMMI_HDR WHERE PREESTNO = '" & strPREESTNO & "'; "

                'strSQL = strSQL & "INSERT INTO PD_PRODUCTIONCOMMI_DTL "
                'strSQL = strSQL & "(PREESTNO, SEQ, ITEMCODESEQ, ITEMCODE, AMT, CHK, CUSER, CDATE, UUSER, UDATE) "
                'strSQL = strSQL & "SELECT "
                'strSQL = strSQL & "'" & strNewPREESTNO & "' PREESTNO,SEQ,ITEMCODESEQ,ITEMCODE,AMT,CHK,'" & strUSER & "' CUSER,'" & strNow & "' CDATE,'" & strUSER & "' UUSER,'" & strNow & "' UDATE "
                'strSQL = strSQL & "FROM PD_PRODUCTIONCOMMI_DTL WHERE PREESTNO = '" & strPREESTNO & "'; "

                strSQL = strSQL & "INSERT INTO PD_PRODUCTIONCOMMI_HDR "
                strSQL = strSQL & "(PREESTNO, AMT, COMMIRATE, MEMO, CUSER, CDATE, UUSER, UDATE) "
                strSQL = strSQL & "SELECT  "
                strSQL = strSQL & "'" & strNewPREESTNO & "' PREESTNO,"
                strSQL = strSQL & " case DBO.PD_PREESTCONFIRMFLAG_FUN(PREESTNO) when 'T' then isnull(EXEAMT,0) ELSE isnull(AMT,0)end as AMT,"
                strSQL = strSQL & " case DBO.PD_PREESTCONFIRMFLAG_FUN(PREESTNO) when 'T' then isnull(EXECOMMIRATE,0) ELSE isnull(COMMIRATE,0)end as COMMIRATE,"
                strSQL = strSQL & " MEMO,'" & strUSER & "' CUSER,'" & strNow & "' CDATE,'" & strUSER & "' UUSER,'" & strNow & "' UDATE "
                strSQL = strSQL & "FROM PD_PRODUCTIONCOMMI_HDR WHERE PREESTNO = '" & strPREESTNO & "'; "

                strSQL = strSQL & "INSERT INTO PD_PRODUCTIONCOMMI_DTL "
                strSQL = strSQL & "(PREESTNO, SEQ, ITEMCODESEQ, ITEMCODE, AMT, CHK, CUSER, CDATE, UUSER, UDATE) "
                strSQL = strSQL & "SELECT "
                strSQL = strSQL & "'" & strNewPREESTNO & "' PREESTNO,SEQ,ITEMCODESEQ,ITEMCODE,"
                strSQL = strSQL & " CASE DBO.PD_PREESTCONFIRMFLAG_FUN(PREESTNO) WHEN 'T' THEN ISNULL(EXEAMT,0) ELSE ISNULL(AMT,0)END AS AMT,"
                strSQL = strSQL & " CASE DBO.PD_PREESTCONFIRMFLAG_FUN(PREESTNO) WHEN 'T' THEN ISNULL(EXECHK,0) ELSE ISNULL(CHK,0)END AS CHK,"
                strSQL = strSQL & " '" & strUSER & "' CUSER,'" & strNow & "' CDATE,'" & strUSER & "' UUSER,'" & strNow & "' UDATE "
                strSQL = strSQL & "FROM PD_PRODUCTIONCOMMI_DTL WHERE PREESTNO = '" & strPREESTNO & "'; "

                strSQL = strSQL & "INSERT INTO PD_OUTLIST_MST "
                strSQL = strSQL & "(PREESTNO,JOBNO,PRODUCTIONNAME,DIRECTORNAME,EDIT,CG,TELECINE,RECORDING, "
                strSQL = strSQL & "CMSONG,STUDIO,MODELAGENCY,DATE,MEETINGDATE,SHOOTDATE,STAGESHOOTDAYS, "
                strSQL = strSQL & "DAYS,HOURS,TITLE,LENGTHS,COMMENTS,CUSER,CDATE,UUSER,UDATE) "
                strSQL = strSQL & "SELECT "
                strSQL = strSQL & "'" & strNewPREESTNO & "' PREESTNO, '" & strJOBNO & "' JOBNO, PRODUCTIONNAME, DIRECTORNAME, EDIT, CG, TELECINE, RECORDING, "
                strSQL = strSQL & "CMSONG, STUDIO, MODELAGENCY, DATE, MEETINGDATE, SHOOTDATE, STAGESHOOTDAYS, "
                strSQL = strSQL & "DAYS, HOURS, TITLE, LENGTHS, COMMENTS, '" & strUSER & "' CUSER, '" & strNow & "' CDATE, '" & strUSER & "' UUSER,'" & strNow & "' UDATE "
                strSQL = strSQL & "FROM PD_OUTLIST_MST WHERE PREESTNO = '" & strPREESTNO & "'; "

                mobjcePD_PREEST_HDR.NewUpdate(strSQL)

                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_DataCopy")
            Finally
                'Resource해제
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_PREEST_HDR.Dispose()
            End Try
        End With
    End Function

    ''============== 견적번호생성(사용)
    Public Function SelectRtn_ESTSEQNO() As String
        '여기부터 단순조회
        Dim strSQL, strFormat, strRtn As String
        'SetConfig(strInfoXML) '기본정보 Setting
        Dim strPRECODE As String
        With mobjSCGLConfig '기본정보 Config 개체
            Try
                strPRECODE = "substring(CAST(DATEPART(YEAR,GETDATE()) AS VARCHAR(4)),3,2)  + RIGHT('00' + CAST(DATEPART(MONTH,GETDATE()) AS VARCHAR(2)), 2)+ RIGHT('00' + CAST(DATEPART(DAY,GETDATE()) AS VARCHAR(2)), 2)"

                strSQL = "SELECT " & strPRECODE & " + DBO.LPAD(ISNULL(MAX(CAST(SUBSTRING(PREESTNO,7,4) AS NUMERIC(4,0))),0)+1,4,'0') "
                strSQL = strSQL & " FROM PD_PREEST_HDR "
                strSQL = strSQL & " WHERE SUBSTRING(PREESTNO,1,6) = " & strPRECODE

                strRtn = .mobjSCGLSql.SQLSelectOneScalar(strSQL)
                Return strRtn
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_ESTSEQNO")
            Finally
            End Try
        End With
        '여기까지 단순조회
    End Function


#End Region

#Region "GROUP BLOCK : Entity Function Section"
    'PREESTNO,PREESTNAME,JOBNO,JOBNAME,AMT,MEMO,CREDAY
    Private Function InsertRtn(ByVal vntData As Object, _
                                    ByVal intColCnt As Integer, _
                                    ByVal intRow As Integer, _
                                    ByVal strCODE As String) As Integer
        Dim intRtn As Integer
        intRtn = mobjcePD_PREEST_HDR.InsertDo( _
                                       strCODE, _
                                       GetElement(vntData, "PREESTNAME", intColCnt, intRow), _
                                       GetElement(vntData, "JOBNO", intColCnt, intRow), _
                                       GetElement(vntData, "MEMO", intColCnt, intRow), _
                                       GetElement(vntData, "CREDAY", intColCnt, intRow), _
                                       GetElement(vntData, "CLIENTSUBCODE", intColCnt, intRow), _
                                       GetElement(vntData, "SUSURATE", intColCnt, intRow), _
                                       GetElement(vntData, "CLIENTCODE", intColCnt, intRow), _
                                       GetElement(vntData, "SUBSEQ", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR01", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR02", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR03", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR04", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR05", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR06", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR07", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR08", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR09", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR10", intColCnt, intRow, NULL_NUM, True))
        Return intRtn

    End Function
    Private Function UpdateRtn(ByVal vntData As Object, _
                                    ByVal intColCnt As Integer, _
                                    ByVal intRow As Integer) As Integer

        Dim intRtn As Integer
        'PREESTNO,PREESTNAME,JOBNO,JOBNAME,AMT,MEMO,CREDAY
        intRtn = mobjcePD_PREEST_HDR.UpdateDo( _
                                       GetElement(vntData, "PREESTNO", intColCnt, intRow), _
                                       GetElement(vntData, "PREESTNAME", intColCnt, intRow), _
                                       GetElement(vntData, "JOBNO", intColCnt, intRow), _
                                       GetElement(vntData, "MEMO", intColCnt, intRow), _
                                       GetElement(vntData, "CREDAY", intColCnt, intRow), _
                                       GetElement(vntData, "CLIENTSUBCODE", intColCnt, intRow), _
                                       GetElement(vntData, "SUSURATE", intColCnt, intRow), _
                                       GetElement(vntData, "CLIENTCODE", intColCnt, intRow), _
                                       GetElement(vntData, "SUBSEQ", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR01", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR02", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR03", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR04", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR05", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR06", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR07", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR08", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR09", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR10", intColCnt, intRow, NULL_NUM, True))
        Return intRtn
    End Function
    Private Function InsertRtn_CHARGE_TEMP(ByVal strPREESTNO As String, _
                                           ByRef dblDATACNT As Double) As Integer
        Dim intRtn As Integer
        intRtn = mobjcePD_CHARGE_TEMP.InsertDo( _
                                       strPREESTNO, _
                                       dblDATACNT, _
                                       "", _
                                       "")
        Return intRtn

    End Function
#End Region
End Class

