'****************************************************************************************
'Generated By  : Kim Tae Ho 
'시스템구분    : RMS/PD/Server Control Class
'실행   환경   : COM+ Service Server Package
'프로그램명    : ccPDCMSEARCH.vb
'기         능 : - 조회모듈
'특이  사항    : - 
'                -
'----------------------------------------------------------------------------------------
'HISTORY    :1) 2008.12.11 Kim Tae Ho
'            2) 
'****************************************************************************************

Imports System.Xml                  ' XML처리
Imports SCGLControl                 ' ControlClass의 Base Class
Imports SCGLUtil.cbSCGLConfig       ' ConfigurationClass
Imports SCGLUtil.cbSCGLErr          '오류처리 클래스
Imports SCGLUtil.cbSCGLXml          'XML처리 클래스
Imports SCGLUtil.cbSCGLUtil         '기타유틸리티 클래스
Imports ePDCO                       '엔터티 추가

' 엔티티 클래스 사용시 해당 엔티티 클래스의 프로젝트를 참조한 후 Imports 하십시요. 
' Imports 엔티티프로젝트
Public Class ccPDCOFINISHLIST
    Inherits ccControl
#Region "GROUP BLOCK : 전역 또는 모듈레벨의 변수/상수 선언"
    Private CLASS_NAME = "ccPDCOFINISHLIST"                  '자신의 클래스명
    Private mobjcePD_EXE_HDR As ePDCO.cePD_EXE_HDR            '외주정산 기본내역
    'Private Const .DBConnStr = "Provider=SQLOLEDB;Data Source=10.110.10.86;Initial Catalog=MCDEV;DSN=MCDEV;UID=devadmin;Pwd=password"
#End Region

#Region "GROUP BLOCK : Function Section"
    '===================================== 마감 전 조회
    Function SelectRtn(ByVal strInfoXML As String, _
                                          ByRef intRowCnt As Integer, _
                                          ByRef intColCnt As Integer, _
                                          ByVal strYEARMON As String) As Object

        Dim strWhere As String       'Where조건 변수
        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim strXMLData As String    'XML  Return 변수(XML  을 사용할 때 선언)
        Dim Con1 As String

        Dim strNOW As String '데이트형의 처리는 변수를 받아 텍스트로 처리 한다.. 



        strWhere = BuildFields(" ", Con1)
        strFormat = " SELECT '' YEARMON, A.JOBNO,DBO.PD_JOBNAME_FUN(A.JOBNO) JOBNAME, A.SEQ,C.ENDDAY,A.ADJDAY,A.PURCHASENO,A.STD,A.ADJAMT,B.DIVAMT,B.AMT DEMANDAMT,"
        strFormat = strFormat & " ISNULL(B.DIVAMT,0) - ISNULL(B.AMT,0) BALANCE,"
        strFormat = strFormat & " CASE WHEN ISNULL(A.PURCHASENO,'') <> '' AND ISNULL(B.DIVAMT,0) - ISNULL(B.AMT,0) <> 0 AND ISNULL(C.ENDDAY,'') = '' THEN 'PREPAYMENT'"
        strFormat = strFormat & " WHEN ISNULL(A.PURCHASENO,'') = '' AND ISNULL(B.DIVAMT,0) - ISNULL(B.AMT,0) = 0 AND ISNULL(C.ENDDAY,'') = '' THEN 'PREDEMANDAMT'"
        strFormat = strFormat & " WHEN ISNULL(A.PURCHASENO,'') = '' AND ISNULL(B.DIVAMT,0) - ISNULL(B.AMT,0) = 0 AND ISNULL(C.ENDDAY,'') <> '' THEN 'ACCRUED'"
        strFormat = strFormat & " END AS DIVFLAG,"
        strFormat = strFormat & " CASE WHEN ISNULL(A.PURCHASENO,'') <> '' AND ISNULL(B.DIVAMT,0) - ISNULL(B.AMT,0) <> 0 AND ISNULL(C.ENDDAY,'')= '' THEN '선급금'"
        strFormat = strFormat & " WHEN  ISNULL(A.PURCHASENO,'') = '' AND ISNULL(B.DIVAMT,0) - ISNULL(B.AMT,0) = 0 AND ISNULL(C.ENDDAY,'') = '' THEN '선청구'"
        strFormat = strFormat & " WHEN ISNULL(A.PURCHASENO,'') = '' AND ISNULL(B.DIVAMT,0) - ISNULL(B.AMT,0) = 0 AND ISNULL(C.ENDDAY,'') <> '' THEN '미지급금'"
        strFormat = strFormat & " END AS DIVFLAGNAME,"
        strFormat = strFormat & " A.OUTSCODE,DBO.MD_GET_CUSTNAME_FUN(A.OUTSCODE) OUTSNAME,'' CUSER,'' CDATE,DENSE_RANK() OVER (ORDER BY A.JOBNO) AS RANKTRANS"
        strFormat = strFormat & " FROM PD_EXE_DTL A LEFT JOIN "
        strFormat = strFormat & " ("
        strFormat = strFormat & " 	SELECT X.JOBNO,ISNULL(X.DIVAMT,0) DIVAMT,ISNULL(Y.AMT,0) AMT"
        strFormat = strFormat & " 	FROM"
        strFormat = strFormat & " 	(SELECT JOBNO,SUM(DIVAMT) DIVAMT FROM PD_DIVAMT GROUP BY JOBNO) X"
        strFormat = strFormat & " 	LEFT JOIN (SELECT JOBNO,SUM(AMT) AMT FROM PD_TAX_MST GROUP BY JOBNO) Y ON X.JOBNO = Y.JOBNO"
        strFormat = strFormat & " ) B ON A.JOBNO = B.JOBNO"
        strFormat = strFormat & " LEFT JOIN PD_EXE_HDR C ON A.JOBNO = C.JOBNO "
        strFormat = strFormat & " WHERE A.JOBNO = B.JOBNO "
        strFormat = strFormat & " AND SUBSTRING(C.ENDDAY,1,6) = '" & strYEARMON & "' OR ISNULL(C.ENDDAY,'') = ''"


        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보 Config 개체
            strSQL = String.Format(strFormat, strWhere)
            Try
                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                ' ------ Array 데이터 조회 (True 일때 헤더정보 포함 조회(Sheet Data Binding 할 경우 사용), False 일때 데이터만 조회)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return vntData
                ' ------ XML 데이터 조회
                'strXMLData = .mobjSCGLSql.SQLSelectXml(strSQL, intRowCnt, intColCnt)
                'Return strXMLData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function
    '===================================== 마감 완료후 조회
    Function SelectRtn_End(ByVal strInfoXML As String, _
                       ByRef intRowCnt As Integer, _
                       ByRef intColCnt As Integer, _
                       ByVal strYEARMON As String) As Object

        Dim strWhere As String       'Where조건 변수
        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim strXMLData As String    'XML  Return 변수(XML  을 사용할 때 선언)



        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보 Config 개체
            strSQL = " select "
            strSQL = strSQL & " JOBNO,DBO.PD_JOBNAME_FUN(JOBNO) JOBNAME,"
            strSQL = strSQL & " SEQ,ENDDAY,ADJDAY,PURCHASENO,STD,ADJAMT,DIVAMT,DEMANDAMT,BALANCE,"
            strSQL = strSQL & " DIVFLAG,"
            strSQL = strSQL & " CASE DIVFLAG WHEN 'PREPAYMENT' THEN '선급금' "
            strSQL = strSQL & " WHEN 'PREDEMANDAMT' THEN '선청구'"
            strSQL = strSQL & " WHEN 'ACCRUED' THEN '미지급금' END AS DIVFLAGNAME,"
            strSQL = strSQL & " OUTSCODE,DBO.MD_GET_CUSTNAME_FUN(OUTSCODE) OUTSNAME,DENSE_RANK() OVER (ORDER BY JOBNO) AS RANKTRANS"
            strSQL = strSQL & " from pd_closing_mst where substring(YEARMON,1,6) = '" & strYEARMON & "'"
            Try
                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                ' ------ Array 데이터 조회 (True 일때 헤더정보 포함 조회(Sheet Data Binding 할 경우 사용), False 일때 데이터만 조회)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return vntData
                ' ------ XML 데이터 조회
                'strXMLData = .mobjSCGLSql.SQLSelectXml(strSQL, intRowCnt, intColCnt)
                'Return strXMLData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_End")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function
    Function SelectRtn_PreCount(ByVal strInfoXML As String, _
                                ByRef intRowCnt As Integer, _
                                ByRef intColCnt As Integer, _
                                ByVal strYEARMON As String) As Object

        Dim strWhere As String       'Where조건 변수
        Dim strFormat As String      'SQL Format 변수
        Dim strSQL As String          'SQL 변수
        Dim vntData As Object        'Array Return 변수(Array 를사용할 때 선언)
        Dim strXMLData As String    'XML  Return 변수(XML  을 사용할 때 선언)



        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보 Config 개체
            strSQL = "SELECT JOBNO FROM PD_CLOSING_MST WHERE YEARMON ='" & strYEARMON & "'"
            Try
                ' DB 접속
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                ' ------ Array 데이터 조회 (True 일때 헤더정보 포함 조회(Sheet Data Binding 할 경우 사용), False 일때 데이터만 조회)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return vntData
                ' ------ XML 데이터 조회
                'strXMLData = .mobjSCGLSql.SQLSelectXml(strSQL, intRowCnt, intColCnt)
                'Return strXMLData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn")
            Finally
                ' DB 접속 종료
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function
    '정산마감 최초저장처리
    Public Function ProcessRtn(ByVal strInfoXML As String, _
                               ByVal strYEARMON As String) As Integer '데이터 INSERT/UPDATE
        Dim intRtn As Integer '결과값 변수
        Dim i, intColCnt, intRows As Integer '루프, 컬럼Cnt, 로우Cnt 변수
        Dim strSQL As String

        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보를 가지고 있는 Config 개체
            Try
                'XML Element 변수 선언 (strMasterXML을 변환)
                mobjcePD_EXE_HDR = New cePD_EXE_HDR(mobjSCGLConfig)


                'DB접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                'Master 데이터 처리


                intRtn = mobjcePD_EXE_HDR.InsertPREPAYMENT(strYEARMON)
                intRtn = mobjcePD_EXE_HDR.InsertPREPAYMENT_AFTER(strYEARMON)

                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_Cancel")
            Finally
                'Resource해제
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_EXE_HDR.Dispose()
            End Try
        End With
    End Function
    '정산마감취소 최초저장처리
    Public Function ProcessRtn_Cancel(ByVal strInfoXML As String, _
                                      ByVal strYEARMON As String) As Integer '데이터 INSERT/UPDATE
        Dim intRtn As Integer '결과값 변수
        Dim i, intColCnt, intRows As Integer '루프, 컬럼Cnt, 로우Cnt 변수
        Dim strSQL As String

        SetConfig(strInfoXML) '기본정보 Setting
        With mobjSCGLConfig '기본정보를 가지고 있는 Config 개체
            Try
                'XML Element 변수 선언 (strMasterXML을 변환)
                mobjcePD_EXE_HDR = New cePD_EXE_HDR(mobjSCGLConfig)


                'DB접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                'Master 데이터 처리

                intRtn = mobjcePD_EXE_HDR.DeletePREPAYMENT_BEFORE(strYEARMON)
                intRtn = mobjcePD_EXE_HDR.DeletePREPAYMENT(strYEARMON)


                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_Cancel")
            Finally
                'Resource해제
                .mobjSCGLSql.SQLDisconnect()
                mobjcePD_EXE_HDR.Dispose()
            End Try
        End With
    End Function

#End Region

#Region "GROUP BLOCK : Entity Function Section"

#End Region
End Class
