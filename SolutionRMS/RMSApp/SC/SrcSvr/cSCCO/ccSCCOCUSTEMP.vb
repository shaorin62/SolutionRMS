'****************************************************************************************
'Generated By: MakeSFAR V.2.0.0 - 컨트롤 클래스 메이커 - 한화 S&C
'시스템구분    : 솔루션명 /시스템명/Server Control Class
'실행   환경    : COM+ Service Server Package
'프로그램명    : ccPDCMCODETR.vb
'기         능    : - 기능을 명시 합니다.
'특이  사항     : - 특이사항에 대해 표현
'                     -
'----------------------------------------------------------------------------------------
'HISTORY    :1) 2004-03-30 오전 10:32:13 By MakeSFARV.2.0.0
'                  2) 2004-03-30 오전 10:32:13 By 작성자명을 씁니다.
'****************************************************************************************

Imports System.Xml                        ' XML처리
Imports SCGLControl                       ' ControlClass의 Base Class
Imports SCGLUtil.cbSCGLConfig       ' ConfigurationClass
Imports SCGLUtil.cbSCGLErr            '오류처리 클래스
Imports SCGLUtil.cbSCGLXml           'XML처리 클래스
Imports SCGLUtil.cbSCGLUtil            '기타유틸리티 클래스
Imports eSCCO
' 엔티티 클래스 사용시 해당 엔티티 클래스의 프로젝트를 참조한 후 Imports 하십시요. 
' Imports 엔티티프로젝트

Public Class ccSCCOCUSTEMP
    Inherits ccControl

#Region "GROUP BLOCK : 전역 또는 모듈레벨의 변수/상수 선언"
    Private CLASS_NAME = "ccSCCOCUSTEMP"                  '자신의 클래스명
    Private mobjceSC_CODE As eSCCO.ceSC_CODE
    Private mobjceSC_CUST_EMP As eSCCO.ceSC_CUST_EMP

#End Region


#Region "GROUP BLOCK : Property 선언"
#End Region

#Region "GROUP BLOCK : Event 선언"
#End Region

#Region "GROUP BLOCK : 외부에 공개 Method"
    ' =============== SelectRtn_CUSTHDR 광고주 헤더
    Public Function SelectRtn_CUSTHDR(ByVal strInfoXML As String, _
                                      ByRef intRowCnt As Integer, _
                                      ByRef intColCnt As Integer, _
                                      ByVal strCUST_NAME As String, _
                                      ByVal strREG_NUM As String, _
                                      ByVal strMEDFLAG As String) As Object     'XML  데이터 조회시

        Dim strSQL As String
        Dim strFormat, strWhere As String
        Dim strChkDate As String = ""
        Dim Con1, Con2, Con3 As String
        Dim vntData As Object

        With mobjSCGLConfig
            Try
                SetConfig(strInfoXML)   '기본정보 설정

                Con1 = ""
                Con2 = ""
                Con3 = ""

                If strCUST_NAME <> "" Then Con1 = String.Format(" AND (COMPANYNAME LIKE '%{0}%')", strCUST_NAME)
                If strREG_NUM <> "" Then Con2 = String.Format(" AND (replace(BUSINO,'-','') LIKE '%{0}%')", strREG_NUM)
                If strMEDFLAG <> "" Then Con3 = String.Format(" AND (MEDFLAG = '{0}')", strMEDFLAG)

                strWhere = BuildFields(" ", Con1, Con2, Con3)

                strFormat = " select "
                strFormat = strFormat & " BUSINO,"
                strFormat = strFormat & " CASE MEDFLAG WHEN 'A' THEN '광고주' WHEN 'B' THEN '매체사' END AS GUBUN, "
                strFormat = strFormat & " COMPANYNAME, "
                strFormat = strFormat & " HIGHCUSTCODE,"
                strFormat = strFormat & " CUSTOWNER , "
                strFormat = strFormat & " BUSISTAT,"
                strFormat = strFormat & " BUSITYPE, "
                strFormat = strFormat & " case len(isnull(ZIPCODE,'')) when 6 then substring(isnull(ZIPCODE,''),1,3) + '-' + substring(isnull(ZIPCODE,''),4,3) else isnull(ZIPCODE,'') end as ZIPCODE,  "
                strFormat = strFormat & " ADDRESS1, "
                strFormat = strFormat & " ADDRESS2, "
                strFormat = strFormat & " TEL, FAX,"
                strFormat = strFormat & " MEMO "
                strFormat = strFormat & " from SC_CUST_HDR"
                strFormat = strFormat & " where 1=1 {0} AND ISNULL(USE_FLAG,0) = 1 "
                strFormat = strFormat & " AND MEDFLAG IN('A','B') "
                strFormat = strFormat & " ORDER BY MEDFLAG, BUSINO "

                strSQL = String.Format(strFormat, strWhere)

                .mobjSCGLSql.SQLConnect(.DBConnStr)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)

                Return vntData
            Catch err As Exception
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_CUSTHDR")
            Finally
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    ' =============== SelectRtn_CUSTDTL 광고주디테일
    Public Function SelectRtn_CUSTDTL(ByVal strInfoXML As String, _
                                      ByRef intRowCnt As Integer, _
                                      ByRef intColCnt As Integer, _
                                      ByRef strHIGHCUSTCODE As String) As Object     'XML  데이터 조회시

        Dim strSQL As String
        Dim strFormat, strSelFields, strWhere As String
        Dim strChkDate As String = ""
        Dim Con1, Con2 As String
        Dim vntData As Object

        With mobjSCGLConfig
            Try
                SetConfig(strInfoXML)   '기본정보 설정

                Con1 = ""
                Con2 = ""

                If strHIGHCUSTCODE <> "" Then Con1 = String.Format(" AND (HIGHCUSTCODE = '{0}')", strHIGHCUSTCODE)

                strWhere = BuildFields(" ", Con1)

                strFormat = strFormat & " select "
                strFormat = strFormat & " CUSTCODE, CUSTNAME "
                strFormat = strFormat & " from SC_CUST_DTL "
                strFormat = strFormat & " where 1=1 AND MEDFLAG IN('A','B') {0} AND ISNULL(GBNFLAG,0) <> 1 AND ISNULL(USE_FLAG,0) = 1"
                strFormat = strFormat & " ORDER BY CUSTNAME"

                strSQL = String.Format(strFormat, strWhere)

                .mobjSCGLSql.SQLConnect(.DBConnStr)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)

                Return vntData
            Catch err As Exception
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_CUSTDTL")
            Finally
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    ' =============== SelectRtn_CUSTDTL 광고주디테일
    Public Function SelectRtn_EMPDTL(ByVal strInfoXML As String, _
                                     ByRef intRowCnt As Integer, _
                                     ByRef intColCnt As Integer, _
                                     ByRef strCUSTCODE As String) As Object     'XML  데이터 조회시

        Dim strSQL As String
        Dim strFormat, strSelFields, strWhere As String
        Dim strChkDate As String = ""
        Dim Con1, Con2 As String
        Dim vntData As Object

        With mobjSCGLConfig
            Try
                SetConfig(strInfoXML)   '기본정보 설정

                Con1 = ""
                Con2 = ""

                If strCUSTCODE <> "" Then Con1 = String.Format(" AND (CUSTCODE = '{0}')", strCUSTCODE)

                strWhere = BuildFields(" ", Con1)

                strFormat = strFormat & " select "
                strFormat = strFormat & " CUSTCODE, SEQ, "
                strFormat = strFormat & " EMP_NAME, "
                strFormat = strFormat & " EMP_EMAIL, "
                strFormat = strFormat & " EMP_HP, "
                strFormat = strFormat & " EMP_TEL, "
                strFormat = strFormat & " DEPT_NAME, "
                strFormat = strFormat & " USE_YN, "
                strFormat = strFormat & " DEF_GBN,"
                strFormat = strFormat & " MEMO"
                strFormat = strFormat & " from SC_CUST_EMP "
                strFormat = strFormat & " where 1=1 {0} "
                strFormat = strFormat & " ORDER BY def_gbn desc, EMP_NAME "

                strSQL = String.Format(strFormat, strWhere)

                .mobjSCGLSql.SQLConnect(.DBConnStr)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)

                Return vntData
            Catch err As Exception
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_CUSTDTL")
            Finally
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    ' =============== ProcessRtn_CUSTDTL    거래처 디테일 저장 
    Public Function ProcessRtn_CUSTDTL(ByVal strInfoXML As String, _
                                       ByVal vntData As Object, _
                                       ByVal strHIGHCUSTCODE As String) As Object

        Dim intRtn As Integer
        Dim i, intColCnt, intRows As Integer
        Dim strCUSTCODE
        Dim strVOCH_TYPE
        Dim strSEQ

        SetConfig(strInfoXML)
        With mobjSCGLConfig
            Try
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                If IsArray(vntData) Then
                    '''사용할 Entity 개체생성(Config 정보를 넘겨생성)
                    mobjceSC_CUST_EMP = New ceSC_CUST_EMP(mobjSCGLConfig)
                    '''vntData의 컬럼수, 로우수를 변수입력
                    intColCnt = UBound(vntData, 1) : intRows = UBound(vntData, 2)
                    For i = 1 To intRows
                        strCUSTCODE = ""

                        If GetElement(vntData, "SEQ", intColCnt, i, NULL_NUM, True) = -999999 Then
                            strCUSTCODE = GetElement(vntData, "CUSTCODE", intColCnt, i, OPTIONAL_STR)
                            strSEQ = SelectRtn_SEQ(strCUSTCODE)
                            intRtn = InsertRtn_SC_CUST_EMP(vntData, intColCnt, i, strCUSTCODE, strSEQ, strHIGHCUSTCODE)
                        Else
                            strCUSTCODE = GetElement(vntData, "CUSTCODE", intColCnt, i, OPTIONAL_STR)
                            strSEQ = GetElement(vntData, "SEQ", intColCnt, i, NULL_NUM, True)
                            intRtn = UpdateRtn_SC_CUST_EMP(vntData, intColCnt, i, strCUSTCODE, strSEQ, strHIGHCUSTCODE)
                        End If
                    Next
                End If
                .mobjSCGLSql.SQLCommitTrans()
                Return intRows
            Catch err As Exception
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn_CUSTDTL")
            Finally
                .mobjSCGLSql.SQLDisconnect()
                mobjceSC_CUST_EMP.Dispose()
            End Try
        End With
    End Function

    Public Function SelectRtn_SEQ(ByRef strCUSTCODE As String) As String
        '여기부터 단순조회
        Dim strSQL, strFormat, strRtn As String

        With mobjSCGLConfig '기본정보 Config 개체
            Try
                strSQL = "select isnull(Max(SEQ),0) +1 From SC_CUST_EMP WHERE CUSTCODE = '" & strCUSTCODE & "'"
                strRtn = .mobjSCGLSql.SQLSelectOneScalar(strSQL)

                Return strRtn

            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn")
            Finally
            End Try
        End With
        '여기까지 단순조회
    End Function
#End Region

#Region "GROUP BLOCK : 외부에 비공개 Method"
    Private Function InsertRtn_SC_CUST_EMP(ByVal vntData As Object, _
                                           ByVal intColCnt As Integer, _
                                           ByVal intRow As Integer, _
                                           ByRef strCUSTCODE As String, _
                                           ByRef strSEQ As Integer, _
                                           ByRef strHIGHCUSTCODE As String) As Integer

        Dim intRtn As Integer
        intRtn = mobjceSC_CUST_EMP.InsertDo( _
                                       strCUSTCODE, _
                                       strSEQ, _
                                       strHIGHCUSTCODE, _
                                       GetElement(vntData, "EMP_NAME", intColCnt, intRow), _
                                       GetElement(vntData, "EMP_HP", intColCnt, intRow), _
                                       GetElement(vntData, "EMP_EMAIL", intColCnt, intRow), _
                                       GetElement(vntData, "EMP_TEL", intColCnt, intRow), _
                                       GetElement(vntData, "JONGNO", intColCnt, intRow), _
                                       GetElement(vntData, "DEPT_NAME", intColCnt, intRow), _
                                       GetElement(vntData, "DEF_GBN", intColCnt, intRow), _
                                       GetElement(vntData, "VOCH_TYPE", intColCnt, intRow), _
                                       GetElement(vntData, "URL", intColCnt, intRow), _
                                       GetElement(vntData, "USE_YN", intColCnt, intRow), _
                                       GetElement(vntData, "MEMO", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR01", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR02", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR03", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR04", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR05", intColCnt, intRow))
        Return intRtn
    End Function

    Private Function UpdateRtn_SC_CUST_EMP(ByVal vntData As Object, _
                                           ByVal intColCnt As Integer, _
                                           ByVal intRow As Integer, _
                                           ByVal strCUSTCODE As String, _
                                           ByRef strSEQ As Integer, _
                                           ByRef strHIGHCUSTCODE As String) As Integer

        Dim intRtn As Integer
        intRtn = mobjceSC_CUST_EMP.UpdateDo( _
                                       strCUSTCODE, _
                                       strSEQ, _
                                       strHIGHCUSTCODE, _
                                       GetElement(vntData, "EMP_NAME", intColCnt, intRow), _
                                       GetElement(vntData, "EMP_HP", intColCnt, intRow), _
                                       GetElement(vntData, "EMP_EMAIL", intColCnt, intRow), _
                                       GetElement(vntData, "EMP_TEL", intColCnt, intRow), _
                                       GetElement(vntData, "JONGNO", intColCnt, intRow), _
                                       GetElement(vntData, "DEPT_NAME", intColCnt, intRow), _
                                       GetElement(vntData, "DEF_GBN", intColCnt, intRow), _
                                       GetElement(vntData, "VOCH_TYPE", intColCnt, intRow), _
                                       GetElement(vntData, "URL", intColCnt, intRow), _
                                       GetElement(vntData, "USE_YN", intColCnt, intRow), _
                                       GetElement(vntData, "MEMO", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR01", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR02", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR03", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR04", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR05", intColCnt, intRow))
        Return intRtn
    End Function
#End Region
End Class