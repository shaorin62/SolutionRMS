'****************************************************************************************
'Generated By: MakeSFAR V.2.0.0 - 컨트롤 클래스 메이커 - 한화 S&C
'시스템구분    : 솔루션명 /시스템명/Server Control Class
'실행   환경    : COM+ Service Server Package
'프로그램명    : ccMDCMEXECUTE.vb
'기         능    : - 기능을 명시 합니다.
'특이  사항     : - 특이사항에 대해 표현
'                     -
'----------------------------------------------------------------------------------------
'HISTORY    :1) 2004-03-30 오전 10:32:13 By MakeSFARV.2.0.0
'                  2) 2004-03-30 오전 10:32:13 By 작성자명을 씁니다.
'****************************************************************************************

Imports System.Xml                        ' XML처리 
Imports SCGLControl                       ' ControlClass의 Base Class 
Imports SCGLUtil.cbSCGLConfig       ' ConfigurationClass
Imports SCGLUtil.cbSCGLErr            '오류처리 클래스
Imports SCGLUtil.cbSCGLXml           'XML처리 클래스
Imports SCGLUtil.cbSCGLUtil            '기타유틸리티 클래스


Public Class ccMDSCPRINTYEARLIST
    Inherits ccControl

#Region "GROUP BLOCK : 전역 또는 모듈레벨의 변수/상수 선언"
    Private CLASS_NAME = "ccMDSCPRINTYEARLIST"                  '자신의 클래스명
    'Private Const .DBConnStr = "Provider=SQLOLEDB;Data Source=10.110.10.86;Initial Catalog=MCDEV;DSN=MCDEV;UID=devadmin;Pwd=password"  '커넥션Setting
#End Region

#Region "GROUP BLOCK : Property 선언"
#End Region

#Region "GROUP BLOCK : Event 선언"
#End Region

#Region "GROUP BLOCK : 외부에 공개 Method"
    '===================팝업에서 광고주 복수건 선택한 후 광고주별 월별 집행금액 조회
    ' ===============광고주별 집행 조회 ==================================
    Public Function GetCLIENTCNT(ByVal strInfoXML As String, _
                                ByRef intRowCnt As Integer, _
                                ByRef intColCnt As Integer, _
                                ByRef strYEAR As String, _
                                ByRef strCLIENTLIST As String, _
                                ByRef strREAL_MEDLIST As String) As Object

        Dim strSQL, strFormat, strRtn As String
        Dim mvntData As Object
        Dim strMAXYEARMON
        Dim Con1, Con2 As String
        Dim objCLIENT, objREAL_MED
        Dim intCol, intRows
        Dim strCLIENTCODE, strREAL_MED_CODE
        Dim intCUSTRows, intREALRows
        Dim i
        With mobjSCGLConfig '기본정보 Config 개체 
            Try
                SetConfig(strInfoXML)
                .mobjSCGLSql.SQLConnect(.DBConnStr)

                objCLIENT = Split(strCLIENTLIST, "|")

                intCUSTRows = UBound(objCLIENT, 1)
                strCLIENTCODE = ""
                For i = 0 To intCUSTRows
                    If i = 0 Then
                        strCLIENTCODE = "'" & objCLIENT(i) & "'"
                    Else
                        strCLIENTCODE = strCLIENTCODE & ",'" & objCLIENT(i) & "'"
                    End If
                Next

                objREAL_MED = Split(strREAL_MEDLIST, "|")

                intREALRows = UBound(objREAL_MED, 1)
                strREAL_MED_CODE = ""
                For i = 0 To intREALRows
                    If i = 0 Then
                        strREAL_MED_CODE = "'" & objREAL_MED(i) & "'"
                    Else
                        strREAL_MED_CODE = strREAL_MED_CODE & ",'" & objREAL_MED(i) & "'"
                    End If
                Next
                Con1 = ""
                Con2 = ""

                If strCLIENTCODE <> "" Then Con1 = String.Format(" AND (CLIENTCODE IN({0}))", strCLIENTCODE) '년월
                If strREAL_MED_CODE <> "" Then Con2 = String.Format(" AND (REAL_MED_CODE IN({0}))", strREAL_MED_CODE) '년월

                strSQL = " SELECT substring(YEARMON,5,2) || '월' MON , substring(YEARMON,5,2) MON2 From MD_BOOKING_MEDIUM "
                strSQL = strSQL & "  WHERE 1=1 AND GFLAG IN ('J','S')  AND substring(YEARMON,1,4) =  '" & strYEAR & "'" & Con1 & Con2
                strSQL = strSQL & "  GROUP BY substring(YEARMON,5,2)"
                strSQL = strSQL & "  ORDER BY substring(YEARMON,5,2)"

                .mobjSCGLSql.SQLConnect(.DBConnStr)
                mvntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return mvntData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".GetCLIENTCNT")
            Finally
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function


    Public Function GetMEDCNT(ByVal strInfoXML As String, _
                              ByRef intRowCnt As Integer, _
                              ByRef intColCnt As Integer, _
                              ByRef strYEAR As String, _
                              ByRef strCLIENTLIST As String, _
                              ByRef strREAL_MEDLIST As String) As Object

        Dim strSQL, strFormat, strRtn As String
        Dim mvntData As Object
        Dim strMAXYEARMON
        Dim Con1, Con2 As String
        Dim objCLIENT, objREAL_MED
        Dim intCUSTRows, intREALRows
        Dim strCLIENTCODE, strREAL_MED_CODE
        Dim i

        With mobjSCGLConfig '기본정보 Config 개체 
            Try
                SetConfig(strInfoXML)
                .mobjSCGLSql.SQLConnect(.DBConnStr)

                objCLIENT = Split(strCLIENTLIST, "|")

                intCUSTRows = UBound(objCLIENT, 1)
                strCLIENTCODE = ""
                For i = 0 To intCUSTRows
                    If i = 0 Then
                        strCLIENTCODE = "'" & objCLIENT(i) & "'"
                    Else
                        strCLIENTCODE = strCLIENTCODE & ",'" & objCLIENT(i) & "'"
                    End If
                Next

                objREAL_MED = Split(strREAL_MEDLIST, "|")

                intREALRows = UBound(objREAL_MED, 1)
                strREAL_MED_CODE = ""
                For i = 0 To intREALRows
                    If i = 0 Then
                        strREAL_MED_CODE = "'" & objREAL_MED(i) & "'"
                    Else
                        strREAL_MED_CODE = strREAL_MED_CODE & ",'" & objREAL_MED(i) & "'"
                    End If
                Next

                Con1 = ""
                Con2 = ""

                If strCLIENTCODE <> "" Then Con1 = String.Format(" AND (CLIENTCODE IN({0}))", strCLIENTCODE) '년월
                If strREAL_MED_CODE <> "" Then Con2 = String.Format(" AND (REAL_MED_CODE IN({0}))", strREAL_MED_CODE) '년월

                strSQL = " SELECT DBO.SC_GET_HIGHCOMPANYNAME_FUN(REAL_MED_CODE) REAL_MED_NAME, REAL_MED_CODE From MD_BOOKING_MEDIUM "
                strSQL = strSQL & "   WHERE 1=1  AND substring(YEARMON,1,4) =  '" & strYEAR & "'" & Con1 & Con2
                strSQL = strSQL & "   GROUP BY REAL_MED_CODE"

                .mobjSCGLSql.SQLConnect(.DBConnStr)
                mvntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return mvntData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".GetMEDCNT")
            Finally
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function


    Public Function GetCUSTCNT(ByVal strInfoXML As String, _
                             ByRef intRowCnt As Integer, _
                             ByRef intColCnt As Integer, _
                             ByRef strYEAR As String, _
                             ByRef strCLIENTLIST As String, _
                             ByRef strREAL_MEDLIST As String) As Object

        Dim strSQL, strFormat, strRtn As String
        Dim mvntData As Object
        Dim strMAXYEARMON
        Dim Con1, Con2 As String
        Dim objCLIENT, objREAL_MED
        Dim intCUSTRows, intREALRows
        Dim strCLIENTCODE, strREAL_MED_CODE
        Dim i

        With mobjSCGLConfig '기본정보 Config 개체 
            Try
                SetConfig(strInfoXML)
                .mobjSCGLSql.SQLConnect(.DBConnStr)

                objCLIENT = Split(strCLIENTLIST, "|")

                intCUSTRows = UBound(objCLIENT, 1)
                strCLIENTCODE = ""
                For i = 0 To intCUSTRows
                    If i = 0 Then
                        strCLIENTCODE = "'" & objCLIENT(i) & "'"
                    Else
                        strCLIENTCODE = strCLIENTCODE & ",'" & objCLIENT(i) & "'"
                    End If
                Next

                objREAL_MED = Split(strREAL_MEDLIST, "|")

                intREALRows = UBound(objREAL_MED, 1)
                strREAL_MED_CODE = ""
                For i = 0 To intREALRows
                    If i = 0 Then
                        strREAL_MED_CODE = "'" & objREAL_MED(i) & "'"
                    Else
                        strREAL_MED_CODE = strREAL_MED_CODE & ",'" & objREAL_MED(i) & "'"
                    End If
                Next

                Con1 = ""
                Con2 = ""

                If strCLIENTCODE <> "" Then Con1 = String.Format(" AND (CLIENTCODE IN({0}))", strCLIENTCODE) '년월
                If strREAL_MED_CODE <> "" Then Con2 = String.Format(" AND (REAL_MED_CODE IN({0}))", strREAL_MED_CODE) '년월

                strSQL = " SELECT DBO.SC_GET_HIGHCUSTNAME_FUN(CLIENTCODE) CLIENTNAME, CLIENTCODE From MD_BOOKING_MEDIUM "
                strSQL = strSQL & "   WHERE 1=1  AND substring(YEARMON,1,4) =  '" & strYEAR & "'" & Con2 & Con1
                strSQL = strSQL & "   GROUP BY CLIENTCODE"

                .mobjSCGLSql.SQLConnect(.DBConnStr)
                mvntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return mvntData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".GetCUSTCNT")
            Finally
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    Public Function SelectRtn_YEAR(ByVal strInfoXML As String, _
                                   ByRef intRowCnt As Integer, _
                                   ByRef intColCnt As Integer, _
                                   ByVal strYEAR As String) As Object

        Dim strSQL, strFormat, strRtn As String
        Dim Con1, Con2, Con3 As String
        Dim i, j
        Dim mvntData
        Dim strjCNT

        With mobjSCGLConfig '기본정보 Config 개체
            SetConfig(strInfoXML)

            strSQL = ""
            strSQL = strSQL & " SELECT"
            strSQL = strSQL & "  dbo.SC_GET_HIGHCUSTNAME_FUN('A00018') YEAR, "
            strSQL = strSQL & "  '신문' CUST, "
            For j = 1 To 12
                strjCNT = ""
                If Len(Trim(Str(j))) = 1 Then
                    strjCNT = "0" & Trim(Str(j))
                Else
                    strjCNT = Trim(Str(j))
                End If
                strSQL = strSQL & "  SUM(CASE substring(yearmon , 5,2) WHEN'" & strjCNT & "' THEN AMOUNT ELSE 0 END) A" & j & ","
            Next
            strSQL = strSQL & "  SUM(AMOUNT) SUMAMT"
            strSQL = strSQL & " from md_booking_medium"
            strSQL = strSQL & " where substring(yearmon , 1,4)='" & strYEAR & "' AND MED_FLAG = 'MP01'"
            strSQL = strSQL & " GROUP BY substring(yearmon , 1,4)"

            strSQL = strSQL & " UNION ALL"

            strSQL = strSQL & " SELECT"
            strSQL = strSQL & "  dbo.SC_GET_HIGHCUSTNAME_FUN('A00000') YEAR, "
            strSQL = strSQL & "  '잡지' CUST, "
            For j = 1 To 12
                strjCNT = ""
                If Len(Trim(Str(j))) = 1 Then
                    strjCNT = "0" & Trim(Str(j))
                Else
                    strjCNT = Trim(Str(j))
                End If
                strSQL = strSQL & "  SUM(CASE substring(yearmon , 5,2) WHEN'" & strjCNT & "' THEN AMOUNT ELSE 0 END) A" & j & ","
            Next
            strSQL = strSQL & "  SUM(AMOUNT) SUMAMT"
            strSQL = strSQL & " from md_booking_medium"
            strSQL = strSQL & " where substring(yearmon , 1,4)='" & strYEAR & "' AND MED_FLAG = 'MP02'"
            strSQL = strSQL & " GROUP BY substring(yearmon , 1,4)"

            strSQL = strSQL & " UNION ALL"

            strSQL = strSQL & " SELECT"
            strSQL = strSQL & "  dbo.SC_GET_HIGHCUSTNAME_FUN('A00018') YEAR, "
            strSQL = strSQL & "  '인터넷' CUST, "
            For j = 1 To 12
                strjCNT = ""
                If Len(Trim(Str(j))) = 1 Then
                    strjCNT = "0" & Trim(Str(j))
                Else
                    strjCNT = Trim(Str(j))
                End If
                strSQL = strSQL & "  SUM(CASE substring(yearmon , 5,2) WHEN'" & strjCNT & "' THEN AMT ELSE 0 END) A" & j & ","
            Next
            strSQL = strSQL & "  SUM(AMT) SUMAMT"
            strSQL = strSQL & " from md_internet_medium"
            strSQL = strSQL & " where substring(yearmon , 1,4)='" & strYEAR & "'"
            strSQL = strSQL & " GROUP BY substring(yearmon , 1,4)"

            strSQL = strSQL & " UNION ALL"
            strSQL = strSQL & " SELECT"
            strSQL = strSQL & "  dbo.SC_GET_HIGHCUSTNAME_FUN('A00018') YEAR, "
            strSQL = strSQL & "  '계' CUST, "

            For j = 1 To 12
                strSQL = strSQL & "  isnull(A.A" & j & ",0) + isnull(B.A" & j & ",0) A" & j & ","
            Next
            strSQL = strSQL & "  A.SUMAMT + B.SUMAMT SUMAMT"

            strSQL = strSQL & "  FROM ("
            strSQL = strSQL & " 		 SELECT "
            strSQL = strSQL & " 		 substring(yearmon , 1,4) YEAR,"

            For j = 1 To 12
                strjCNT = ""
                If Len(Trim(Str(j))) = 1 Then
                    strjCNT = "0" & Trim(Str(j))
                Else
                    strjCNT = Trim(Str(j))
                End If
                strSQL = strSQL & "  SUM(CASE substring(yearmon , 5,2) WHEN'" & strjCNT & "' THEN AMOUNT ELSE 0 END) A" & j & ","
            Next
            strSQL = strSQL & "   SUM(AMOUNT) SUMAMT"
            strSQL = strSQL & " 		 FROM MD_BOOKING_MEDIUM"
            strSQL = strSQL & " where  substring(yearmon , 1,4)='" & strYEAR & "'"
            strSQL = strSQL & " GROUP BY substring(yearmon , 1,4)"
            strSQL = strSQL & " 	 ) "
            strSQL = strSQL & " 	  A LEFT JOIN "
            strSQL = strSQL & " 	 ("
            strSQL = strSQL & " 		 SELECT"
            strSQL = strSQL & " 		 substring(yearmon , 1,4) YEAR,"
            For j = 1 To 12
                strjCNT = ""
                If Len(Trim(Str(j))) = 1 Then
                    strjCNT = "0" & Trim(Str(j))
                Else
                    strjCNT = Trim(Str(j))
                End If
                strSQL = strSQL & "  SUM(CASE substring(yearmon , 5,2) WHEN'" & strjCNT & "' THEN AMT ELSE 0 END) A" & j & ","
            Next
            strSQL = strSQL & " 		 SUM(AMT) SUMAMT"
            strSQL = strSQL & " 		 FROM MD_INTERNET_MEDIUM"
            strSQL = strSQL & " where  substring(yearmon , 1,4)='" & strYEAR & "'"
            strSQL = strSQL & " GROUP BY substring(yearmon , 1,4)"
            strSQL = strSQL & " 	 ) B ON A.YEAR = B.YEAR"

            Try
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                mvntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return mvntData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn")
            Finally
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    Public Function SelectRtn_REALAndCUST(ByVal strInfoXML As String, _
                                          ByRef intRowCnt As Integer, _
                                          ByRef intColCnt As Integer, _
                                          ByVal mintCnt2 As Object, _
                                          ByVal mvntDataCust As Object, _
                                          ByVal mvntDataCustCNT As Object, _
                                          ByVal strYEAR As String, _
                                          ByVal strCLIENTLIST As String, _
                                          ByVal strREAL_MEDLIST As String) As Object

        Dim strSQL, strFormat, strRtn As String
        Dim Con1, Con2, Con3 As String
        Dim i, j
        Dim objCLIENT
        Dim objREAL_MED
        Dim intCUSTRows
        Dim intREALRows
        Dim strCLIENTCODE
        Dim strREAL_MED_CODE
        Dim mvntData

        With mobjSCGLConfig '기본정보 Config 개체
            Try

                SetConfig(strInfoXML)
                .mobjSCGLSql.SQLConnect(.DBConnStr)

                objCLIENT = Split(strCLIENTLIST, "|")

                intCUSTRows = UBound(objCLIENT, 1)
                strCLIENTCODE = ""
                For i = 0 To intCUSTRows
                    If i = 0 Then
                        strCLIENTCODE = "'" & objCLIENT(i) & "'"
                    Else
                        strCLIENTCODE = strCLIENTCODE & ",'" & objCLIENT(i) & "'"
                    End If
                Next

                objREAL_MED = Split(strREAL_MEDLIST, "|")

                intREALRows = UBound(objREAL_MED, 1)
                strREAL_MED_CODE = ""
                For i = 0 To intREALRows
                    If i = 0 Then
                        strREAL_MED_CODE = "'" & objREAL_MED(i) & "'"
                    Else
                        strREAL_MED_CODE = strREAL_MED_CODE & ",'" & objREAL_MED(i) & "'"
                    End If
                Next

                Con1 = ""
                Con2 = ""

                If strCLIENTCODE <> "" Then Con1 = String.Format(" AND (CLIENTCODE IN({0}))", strCLIENTCODE) '년월
                If strREAL_MED_CODE <> "" Then Con2 = String.Format(" AND (REAL_MED_CODE IN({0}))", strREAL_MED_CODE) '년월

                strSQL = ""
                strSQL = strSQL & " SELECT"
                strSQL = strSQL & "  DBO.SC_GET_HIGHCOMPANYNAME_FUN(REAL_MED_CODE) YEAR, "
                strSQL = strSQL & "  DBO.SC_GET_HIGHCUSTNAME_FUN(CLIENTCODE) CUST, "
                For j = 1 To mvntDataCustCNT
                    strSQL = strSQL & "  SUM(decode(substring(yearmon , 5,2),'" & mvntDataCust(1, j) & "',AMOUNT,0)) A" & j & ","
                Next
                strSQL = strSQL & "  SUM(AMOUNT) SUMAMT"
                strSQL = strSQL & " from md_booking_medium"
                strSQL = strSQL & " where substring(yearmon , 1,4)='" & strYEAR & "'" & Con1 & Con2
                strSQL = strSQL & " GROUP BY REAL_MED_CODE, CLIENTCODE "

                'medcode = '" & mvntData2(1, i) & "' and 

                strSQL = strSQL & " UNION ALL"
                strSQL = strSQL & " SELECT"
                strSQL = strSQL & "  SC_GET_HIGHCOMPANYNAME_FUN(REAL_MED_CODE) YEAR, "
                strSQL = strSQL & "  '계' CUST, "
                For j = 1 To mvntDataCustCNT
                    strSQL = strSQL & "  SUM(decode(substring(yearmon , 5,2),'" & mvntDataCust(1, j) & "',AMOUNT,0)) A" & j & ","
                Next
                strSQL = strSQL & "  SUM(AMOUNT) SUMAMT"
                strSQL = strSQL & " from md_booking_medium"
                strSQL = strSQL & " where  substring(yearmon , 1,4)='" & strYEAR & "'" & Con1 & Con2
                strSQL = strSQL & " GROUP BY REAL_MED_CODE, substring(yearmon , 1,4)"

                mvntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return mvntData
            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn")
            Finally
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

#End Region

#Region "GROUP BLOCK : 외부에 비공개 Method"

    ' Private FunctionInsertRtn_XXX(ByVal xmlRoot As XmlElement) As Integer
    '     '해당 엔티티 클래스 Maker에서 기본 코드 제공(XML)
    ' End Function
    ' Private Function UpdateRtn_XXX(ByValxmlRoot As XmlElement) As Integer
    '      '해당엔티티 클래스 Maker에서 기본코드 제공(XML)
    ' End Function
    ' Private Function InsertRtn_XXX(ByVal vntData As Object,ByVal intColCnt As Integer, ByVal intRow As Integer) As Integer
    '     '해당 엔티티 클래스Maker에서 기본 코드 제공(Sheet)
    ' End Function
    ' Private Function UpdateRtn_XXX(ByVal vntData As Object,ByVal intColCnt As Integer, ByVal intRow As Integer) As Integer
    '     '해당 엔티티 클래스Maker에서 기본코드 제공(Sheet)
    ' End Function

#End Region
End Class