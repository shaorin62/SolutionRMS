'****************************************************************************************
'Generated By: MakeSFAR V.2.0.0 - 컨트롤 클래스 메이커 - 한화 S&C
'시스템구분    : 솔루션명 /시스템명/Server Control Class
'실행   환경    : COM+ Service Server Package
'프로그램명    : ccMDCMEXECUTE.vb
'기         능    : - 기능을 명시 합니다.
'특이  사항     : - 특이사항에 대해 표현
'                     -
'----------------------------------------------------------------------------------------
'HISTORY    :1) 2004-03-30 오전 10:32:13 By MakeSFARV.2.0.0
'           :2) 2004-03-30 오전 10:32:13 By 작성자명을 씁니다.
'****************************************************************************************

Imports System.Xml                  ' XML처리 
Imports SCGLControl                 ' ControlClass의 Base Class 
Imports SCGLUtil.cbSCGLConfig       ' ConfigurationClass
Imports SCGLUtil.cbSCGLErr          '오류처리 클래스
Imports SCGLUtil.cbSCGLXml          'XML처리 클래스
Imports SCGLUtil.cbSCGLUtil         '기타유틸리티 클래스
Imports System.Math
Imports eMDCO                       '엔터티 추가

' 엔티티 클래스 사용시 해당 엔티티 클래스의 프로젝트를 참조한 후 Imports 하십시요. 
' Imports 엔티티프로젝트

Public Class ccMDSCAORMEDIUM
    Inherits ccControl

#Region "GROUP BLOCK : 전역 또는 모듈레벨의 변수/상수 선언"
    Private CLASS_NAME = "ccMDSCAORMEDIUM"                  '자신의 클래스명
    Private mobjceMD_AOR_MEDIUM As eMDCO.ceMD_AOR_MEDIUM    '사용할 Entity 변수 선언
#End Region

#Region "GROUP BLOCK : Property 선언"
#End Region

#Region "GROUP BLOCK : 외부에 공개 Method"
    Public Function SelectRtn(ByVal strInfoXML As String, _
                              ByRef intRowCnt As Integer, _
                              ByRef intColCnt As Integer, _
                              ByVal strYEARMON As String, _
                              ByVal strCLIENTCODE As String, _
                              ByVal strCLIENTNAME As String, _
                              ByVal strREAL_MED_CODE As String, _
                              ByVal strREAL_MED_NAME As String) As Object         'XML  데이터 조회시

        Dim strSQL As String
        Dim strFormet, strSelFields, strWhere As String
        Dim strChkDate As String = ""
        Dim Con1, Con2, Con3, Con4, Con5 As String
        Dim vntData As Object

        With mobjSCGLConfig
            Try
                SetConfig(strInfoXML)   '기본정보 설정
                Con1 = "" : Con2 = "" : Con3 = "" : Con4 = "" : Con5 = ""

                If strYEARMON <> "" Then Con1 = String.Format(" AND (YEARMON = '{0}')", strYEARMON) '년월
                If strCLIENTCODE <> "" Then Con2 = String.Format(" AND (CLIENTCODE = '{0}')", strCLIENTCODE) '광고주코드
                If strCLIENTNAME <> "" Then Con3 = String.Format(" AND (DBO.SC_GET_HIGHCUSTNAME_FUN(CLIENTCODE) LIKE '%{0}%')", strCLIENTNAME) 
                If strREAL_MED_CODE <> "" Then Con4 = String.Format(" AND (REAL_MED_CODE = '{0}')", strREAL_MED_CODE)
                If strREAL_MED_NAME <> "" Then Con5 = String.Format(" AND (DBO.SC_GET_HIGHCUSTNAME_FUN(REAL_MED_CODE) LIKE '%{0}%')", strREAL_MED_NAME)

                strWhere = BuildFields(" ", Con1, Con2, Con3, Con4, Con5)

                strFormet = " SELECT"
                strFormet = strFormet & "  0 CHK,"
                strFormet = strFormet & "  YEARMON,"
                strFormet = strFormet & "  SEQ,"
                strFormet = strFormet & "  CASE MED_FLAG WHEN 'A' THEN '공중파'"
                strFormet = strFormet & "  WHEN 'A2' THEN '케이블'"
                strFormet = strFormet & "  WHEN 'T' THEN '종합편성방송'"
                strFormet = strFormet & "  WHEN 'B' THEN '신문'"
                strFormet = strFormet & "  WHEN 'C' THEN '잡지'"
                strFormet = strFormet & "  WHEN 'O' THEN '인터넷'"
                strFormet = strFormet & "  WHEN 'D' THEN '옥외'END MED_FLAG,"
                strFormet = strFormet & "  CLIENTCODE,"
                strFormet = strFormet & "  DBO.SC_GET_HIGHCUSTNAME_FUN(CLIENTCODE) CLIENTNAME,"
                strFormet = strFormet & "  REAL_MED_CODE,"
                strFormet = strFormet & "  DBO.SC_GET_HIGHCUSTNAME_FUN(REAL_MED_CODE) REAL_MED_NAME,"
                strFormet = strFormet & "  MEDCODE,"
                strFormet = strFormet & "  DBO.SC_GET_CUSTNAME_FUN(MEDCODE) MEDNAME,"
                strFormet = strFormet & "  DEPT_CD,"
                strFormet = strFormet & "  DBO.SC_DEPT_NAME_FUN(DEPT_CD) DEPT_NAME,"
                strFormet = strFormet & "  DEMANDDAY,"
                strFormet = strFormet & "  ISNULL(AMT,0) AMT,"
                strFormet = strFormet & "  ISNULL(AMT,0) * 0.1 VAT,"
                strFormet = strFormet & "  (ISNULL(AMT,0) + ISNULL(AMT,0) * 0.1) SUMAMTVAT,"
                strFormet = strFormet & "  COMMI_RATE,"
                strFormet = strFormet & "  ISNULL(COMMISSION,0) COMMISSION,"
                strFormet = strFormet & "  ISNULL(CARD_AMT,0) CARD_AMT,"
                strFormet = strFormet & "  ISNULL(EX_CARD,0) EX_CARD,"
                strFormet = strFormet & "  EXCLIENTCODE,"
                strFormet = strFormet & "  DBO.SC_GET_HIGHCUSTNAME_FUN(EXCLIENTCODE) EXCLIENTNAME,"
                strFormet = strFormet & "  ISNULL(OUT_AMT,0) OUT_AMT,"
                strFormet = strFormet & "  ISNULL(EX_AMT,0) EX_AMT,"
                strFormet = strFormet & "  MEMO,"
                strFormet = strFormet & "  COMMI_TRANS_NO,"
                strFormet = strFormet & "  COMMI_TAX_NO,"
                strFormet = strFormet & "  COMMI_VOCH_NO"
                strFormet = strFormet & "  FROM MD_AOR_MEDIUM"
                strFormet = strFormet & "  WHERE 1=1"
                strFormet = strFormet & "  {0}"
                strFormet = strFormet & "  ORDER BY SEQ"

                strSQL = String.Format(strFormet, strWhere)

                .mobjSCGLSql.SQLConnect(.DBConnStr)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)

                Return vntData
            Catch err As Exception
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn")
            Finally
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    ' =============== ProcessRtn
    Public Function ProcessRtn(ByVal strInfoXML As String, _
                               ByVal vntData As Object) As Object
        Dim intRtn As Integer
        Dim i, intColCnt, intRows As Integer
        Dim strYEARMON
        Dim strSEQ
        Dim strDEMANDDAY
        Dim strMED_FLAG

        SetConfig(strInfoXML)
        With mobjSCGLConfig
            Try
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                If IsArray(vntData) Then
                    '''사용할 Entity 개체생성(Config 정보를 넘겨생성)
                    mobjceMD_AOR_MEDIUM = New ceMD_AOR_MEDIUM(mobjSCGLConfig)

                    '''vntData의 컬럼수, 로우수를 변수입력
                    intColCnt = UBound(vntData, 1) : intRows = UBound(vntData, 2)
                    For i = 1 To intRows
                        strSEQ = "" : strMED_FLAG = ""
                        If GetElement(vntData, "SEQ", intColCnt, i, NULL_NUM, True) = -999999 Then
                            '년월 정리
                            strYEARMON = GetElement(vntData, "YEARMON", intColCnt, i, OPTIONAL_STR)
                            If GetElement(vntData, "DEMANDDAY", intColCnt, i, OPTIONAL_STR) <> "" Then strDEMANDDAY = GetElement(vntData, "DEMANDDAY", intColCnt, i, OPTIONAL_STR).Substring(0, 4) & GetElement(vntData, "DEMANDDAY", intColCnt, i, OPTIONAL_STR).Substring(5, 2) & GetElement(vntData, "DEMANDDAY", intColCnt, i, OPTIONAL_STR).Substring(8, 2)

                            If GetElement(vntData, "MED_FLAG", intColCnt, i, OPTIONAL_STR) = "공중파" Then
                                strMED_FLAG = "A"
                            ElseIf GetElement(vntData, "MED_FLAG", intColCnt, i, OPTIONAL_STR) = "케이블" Then
                                strMED_FLAG = "A2"
                            ElseIf GetElement(vntData, "MED_FLAG", intColCnt, i, OPTIONAL_STR) = "종합편성방송" Then
                                strMED_FLAG = "T"
                            ElseIf GetElement(vntData, "MED_FLAG", intColCnt, i, OPTIONAL_STR) = "신문" Then
                                strMED_FLAG = "B"
                            ElseIf GetElement(vntData, "MED_FLAG", intColCnt, i, OPTIONAL_STR) = "잡지" Then
                                strMED_FLAG = "C"
                            ElseIf GetElement(vntData, "MED_FLAG", intColCnt, i, OPTIONAL_STR) = "인터넷" Then
                                strMED_FLAG = "O"
                            ElseIf GetElement(vntData, "MED_FLAG", intColCnt, i, OPTIONAL_STR) = "옥외" Then
                                strMED_FLAG = "D"
                            End If

                            strSEQ = SelectRtn_SEQ(strYEARMON)
                            intRtn = InsertRtn_MD_AOR_MEDIUM(vntData, intColCnt, i, strYEARMON, strSEQ, strDEMANDDAY, strMED_FLAG)
                        Else
                            '년월 정리
                            strYEARMON = GetElement(vntData, "YEARMON", intColCnt, i, OPTIONAL_STR)
                            If GetElement(vntData, "DEMANDDAY", intColCnt, i, OPTIONAL_STR) <> "" Then strDEMANDDAY = GetElement(vntData, "DEMANDDAY", intColCnt, i, OPTIONAL_STR).Substring(0, 4) & GetElement(vntData, "DEMANDDAY", intColCnt, i, OPTIONAL_STR).Substring(5, 2) & GetElement(vntData, "DEMANDDAY", intColCnt, i, OPTIONAL_STR).Substring(8, 2)

                            If GetElement(vntData, "MED_FLAG", intColCnt, i, OPTIONAL_STR) = "공중파" Then
                                strMED_FLAG = "A"
                            ElseIf GetElement(vntData, "MED_FLAG", intColCnt, i, OPTIONAL_STR) = "케이블" Then
                                strMED_FLAG = "A2"
                            ElseIf GetElement(vntData, "MED_FLAG", intColCnt, i, OPTIONAL_STR) = "종합편성방송" Then
                                strMED_FLAG = "T"
                            ElseIf GetElement(vntData, "MED_FLAG", intColCnt, i, OPTIONAL_STR) = "신문" Then
                                strMED_FLAG = "B"
                            ElseIf GetElement(vntData, "MED_FLAG", intColCnt, i, OPTIONAL_STR) = "잡지" Then
                                strMED_FLAG = "C"
                            ElseIf GetElement(vntData, "MED_FLAG", intColCnt, i, OPTIONAL_STR) = "인터넷" Then
                                strMED_FLAG = "O"
                            ElseIf GetElement(vntData, "MED_FLAG", intColCnt, i, OPTIONAL_STR) = "옥외" Then
                                strMED_FLAG = "D"
                            End If

                            strSEQ = GetElement(vntData, "SEQ", intColCnt, i, OPTIONAL_STR)
                            '바뀐년월로 신규저장
                            intRtn = UpdateRtn_MD_AOR_MEDIUM(vntData, intColCnt, i, strYEARMON, strSEQ, strDEMANDDAY, strMED_FLAG)
                        End If
                    Next
                End If
                .mobjSCGLSql.SQLCommitTrans()
                Return intRows
            Catch err As Exception
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn")
            Finally
                .mobjSCGLSql.SQLDisconnect()
                mobjceMD_AOR_MEDIUM.Dispose()
            End Try
        End With
    End Function

    '=================== 부킹 신규 시퀀스 생성
    Public Function SelectRtn_SEQ(ByRef strYEARMON As String) As String
        '여기부터 단순조회
        Dim strSQL, strFormat, strRtn As String

        With mobjSCGLConfig '기본정보 Config 개체
            Try
                strSQL = "select "
                strSQL = strSQL & " ISNULL(Max(SEQ),0) +1 "
                strSQL = strSQL & " From MD_AOR_MEDIUM "
                strSQL = strSQL & " WHERE YEARMON = '" & strYEARMON & "'"

                strRtn = .mobjSCGLSql.SQLSelectOneScalar(strSQL)
                Return strRtn

            Catch err As Exception
                ' 오류 전송
                Throw RaiseSysErr(err, CLASS_NAME & ".SelectRtn_SEQ")
            Finally
            End Try
        End With
        '여기까지 단순조회
    End Function

    ' =============== DeleteRtn Sample Code
    Public Function DeleteRtn(ByVal strInfoXML As String, _
                              ByVal strYEARMON As String, _
                              ByVal dblSEQ As Integer) As Integer    '데이터 DELETE

        Dim intRtn As Integer      'Return변수( 처리건수 또는 0 )

        SetConfig(strInfoXML)    '기본정보 Setting
        With mobjSCGLConfig    '기본정보 Config 개체
            Try
                ' 사용할Entity 개체생성(Config 정보를 넘겨생성)
                mobjceMD_AOR_MEDIUM = New ceMD_AOR_MEDIUM(mobjSCGLConfig)
                ' DB 접속 및 트랜잭션 시작
                .mobjSCGLSql.SQLConnect(.DBConnStr)
                .mobjSCGLSql.SQLBeginTrans()
                ' 엔티티 오브젝트의 Delete 메소드 호출
                intRtn = mobjceMD_AOR_MEDIUM.DeleteDo(strYEARMON, dblSEQ)
                ' 트랜잭션 Commit
                .mobjSCGLSql.SQLCommitTrans()
                Return intRtn
            Catch err As Exception
                '트랜잭션 RollBack 및 오류 전송
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & "DeleteRtn")
            Finally
                'DB접속 종료
                .mobjSCGLSql.SQLDisconnect()
                '사용한 Entity(개체Dispose)
                mobjceMD_AOR_MEDIUM.Dispose()
            End Try
        End With
    End Function
#End Region

#Region "GROUP BLOCK : 외부에 비공개 Method"
    Private Function InsertRtn_MD_AOR_MEDIUM(ByVal vntData As Object, _
                                             ByVal intColCnt As Integer, _
                                             ByVal intRow As Integer, _
                                             ByRef strYEARMON As String, _
                                             ByRef strSEQ As Integer, _
                                             ByRef strDEMANDDAY As String, _
                                             ByRef strMED_FLAG As String) As Integer
        Dim intRtn As Integer
        intRtn = mobjceMD_AOR_MEDIUM.InsertDo( _
                                       strYEARMON, _
                                       strSEQ, _
                                       strMED_FLAG, _
                                       GetElement(vntData, "CLIENTCODE", intColCnt, intRow), _
                                       GetElement(vntData, "REAL_MED_CODE", intColCnt, intRow), _
                                       GetElement(vntData, "MEDCODE", intColCnt, intRow), _
                                       GetElement(vntData, "DEPT_CD", intColCnt, intRow), _
                                       strDEMANDDAY, _
                                       GetElement(vntData, "AMT", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "COMMI_RATE", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "COMMISSION", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "CARD_AMT", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "EX_CARD", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "EXCLIENTCODE", intColCnt, intRow), _
                                       GetElement(vntData, "OUT_AMT", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "EX_AMT", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "COMMI_TRANS_NO", intColCnt, intRow), _
                                       GetElement(vntData, "COMMI_TAX_NO", intColCnt, intRow), _
                                       GetElement(vntData, "COMMI_VOCH_NO", intColCnt, intRow), _
                                       GetElement(vntData, "MEMO", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR01", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR02", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR03", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR04", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR05", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR06", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR07", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR08", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR09", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR010", intColCnt, intRow, NULL_NUM, True))

        Return intRtn
    End Function

    Private Function UpdateRtn_MD_AOR_MEDIUM(ByVal vntData As Object, _
                                             ByVal intColCnt As Integer, _
                                             ByVal intRow As Integer, _
                                             ByRef strYEARMON As String, _
                                             ByRef strSEQ As Integer, _
                                             ByRef strDEMANDDAY As String, _
                                             ByRef strMED_FLAG As String) As Integer
        Dim intRtn As Integer
        intRtn = mobjceMD_AOR_MEDIUM.UpdateDo( _
                                       strYEARMON, _
                                       strSEQ, _
                                       strMED_FLAG, _
                                       GetElement(vntData, "CLIENTCODE", intColCnt, intRow), _
                                       GetElement(vntData, "REAL_MED_CODE", intColCnt, intRow), _
                                       GetElement(vntData, "MEDCODE", intColCnt, intRow), _
                                       GetElement(vntData, "DEPT_CD", intColCnt, intRow), _
                                       strDEMANDDAY, _
                                       GetElement(vntData, "AMT", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "COMMI_RATE", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "COMMISSION", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "CARD_AMT", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "EX_CARD", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "EXCLIENTCODE", intColCnt, intRow), _
                                       GetElement(vntData, "OUT_AMT", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "EX_AMT", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "COMMI_TRANS_NO", intColCnt, intRow), _
                                       GetElement(vntData, "COMMI_TAX_NO", intColCnt, intRow), _
                                       GetElement(vntData, "COMMI_VOCH_NO", intColCnt, intRow), _
                                       GetElement(vntData, "MEMO", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR01", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR02", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR03", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR04", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR05", intColCnt, intRow), _
                                       GetElement(vntData, "ATTR06", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR07", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR08", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR09", intColCnt, intRow, NULL_NUM, True), _
                                       GetElement(vntData, "ATTR010", intColCnt, intRow, NULL_NUM, True))
        Return intRtn
    End Function

#End Region
End Class