'****************************************************************************************
'Generated By: MakeSFAR V.2.0.0 - 컨트롤 클래스 메이커
'시스템구분    : 솔루션명 /시스템명/Server Control Class
'실행   환경    : COM+ Service Server Package
'프로그램명    : ccMDCMDEPTMST.vb
'기         능    : - 기능을 명시 합니다.
'특이  사항     : - 특이사항에 대해 표현
'                     -
'----------------------------------------------------------------------------------------
'HISTORY    :1) 
'            2) 
'****************************************************************************************

Imports System.Xml                  ' XML처리
Imports SCGLControl                 ' ControlClass의 Base Class
Imports SCGLUtil.cbSCGLConfig       ' ConfigurationClass
Imports SCGLUtil.cbSCGLErr          '오류처리 클래스
Imports SCGLUtil.cbSCGLXml          'XML처리 클래스
Imports SCGLUtil.cbSCGLUtil         '기타유틸리티 클래스
Imports eMDCO                       '엔터티 추가

' 엔티티 클래스 사용시 해당 엔티티 클래스의 프로젝트를 참조한 후 Imports 하십시요. 
' Imports 엔티티프로젝트

Public Class ccMDCMPREMATTER
    Inherits ccControl
#Region "GROUP BLOCK : 전역 또는 모듈레벨의 변수/상수 선언"
    Private CLASS_NAME = "ccMDCMEMPMST"                  '자신의 클래스명
    'Private mobjceSC_EMPLOYEE_MST As eMDCO.ceSC_EMPLOYEE_MST             '사용할 Entity 변수 선언
    Private mobjceMD_ELECTRIC_PREMATTER As eMDCO.ceMD_ELECTRIC_PREMATTER
    Private Const xConnString = "Provider=SQLOLEDB;Data Source=10.110.10.86;Initial Catalog=MCDEV;DSN=MCDEV;UID=devadmin;Pwd=password" '커넥션Setting
#End Region

#Region "GROUP BLOCK : 외부에비공개"
    Public Function GetCLIENTCODE(ByVal strInfoXML As String, _
                                  ByRef intRowCnt As Integer, _
                                  ByRef intColCnt As Integer, _
                                  ByVal strCODE As String) As Object
        Dim strSQL, strFormat, strSelFields, strKeys As String
        Dim vntData As Object
        SetConfig(strInfoXML)   '기본정보 설정
        With mobjSCGLConfig
            strSQL = "SELECT CUSTCODE FROM SC_CUST_TEMP WHERE ATTR03 = '" & strCODE & "'"
            '데이터 조회
            Try
                .mobjSCGLSql.SQLConnect(xConnString)
                vntData = .mobjSCGLSql.SQLSelectArr(strSQL, intRowCnt, intColCnt, , True)
                Return vntData
            Catch err As Exception
                Throw RaiseSysErr(err, CLASS_NAME & ".GetCLIENTCODE")
            Finally
                .mobjSCGLSql.SQLDisconnect()
            End Try
        End With
    End Function

    Public Function ProcessRtn(ByVal strInfoXML As String, _
                               ByVal vntData As Object) As Integer
        Dim intRtn As Integer
        Dim i, intColCnt, intRows As Integer
        Dim dblID As Double '자동 ID 를사용할 때만 사용
        Dim strSC_EMP_STATUS As String
        Dim strINSERTSQL As String
        Dim strMATTERINSERT As String
        SetConfig(strInfoXML)
        With mobjSCGLConfig
            Try
                .mobjSCGLSql.SQLConnect(xConnString)
                .mobjSCGLSql.SQLBeginTrans()

                If IsArray(vntData) Then
                    '''사용할 Entity 개체생성(Config 정보를 넘겨생성)
                    mobjceMD_ELECTRIC_PREMATTER = New ceMD_ELECTRIC_PREMATTER(mobjSCGLConfig)
                    '''vntData의 컬럼수, 로우수를 변수입력
                    intColCnt = UBound(vntData, 1) : intRows = UBound(vntData, 2)
                    '''해당하는Row 만큼 Loop
                    strSC_EMP_STATUS = ""
                    For i = 1 To intRows
                        intRtn = InsertRtn(vntData, intColCnt, i)
                    Next
                End If
                '브랜드 추가분 쿼리
                strINSERTSQL = "insert into sc_jobcust (seqno,seqname,custcode)"
                strINSERTSQL = strINSERTSQL & " select "
                strINSERTSQL = strINSERTSQL & " dbo.lpad(maxdata.maxnum+seqno,6,'0') as seqno,"
                strINSERTSQL = strINSERTSQL & " subseqname as seqname, "
                strINSERTSQL = strINSERTSQL & " clientcode as custcode"
                strINSERTSQL = strINSERTSQL & " from"
                strINSERTSQL = strINSERTSQL & " ("
                strINSERTSQL = strINSERTSQL & " 	select ROW_NUMBER() OVER(ORDER BY clientcode) AS seqno, "
                strINSERTSQL = strINSERTSQL & " 	clientcode,subseqname"
                strINSERTSQL = strINSERTSQL & " 	from"
                strINSERTSQL = strINSERTSQL & " 	("
                strINSERTSQL = strINSERTSQL & " 		select clientcode,subseqname "
                strINSERTSQL = strINSERTSQL & " 		from md_electric_prematter"
                strINSERTSQL = strINSERTSQL & " 		where not exists	"
                strINSERTSQL = strINSERTSQL & " 		("
                strINSERTSQL = strINSERTSQL & " 			select custcode,seqname"
                strINSERTSQL = strINSERTSQL & " 			from"
                strINSERTSQL = strINSERTSQL & " 				("
                strINSERTSQL = strINSERTSQL & " 				select custcode,seqname"
                strINSERTSQL = strINSERTSQL & " 				from sc_jobcust"
                strINSERTSQL = strINSERTSQL & " 				group by custcode,seqname"
                strINSERTSQL = strINSERTSQL & " 				) b "
                strINSERTSQL = strINSERTSQL & " 			where md_electric_prematter.clientcode = b.custcode "
                strINSERTSQL = strINSERTSQL & " 			and md_electric_prematter.subseqname = b.seqname"
                strINSERTSQL = strINSERTSQL & " 		)"
                strINSERTSQL = strINSERTSQL & " 	) data"
                strINSERTSQL = strINSERTSQL & " 	group by clientcode,subseqname"
                strINSERTSQL = strINSERTSQL & " ) enddata cross join (select max(cast(seqno as int)) as maxnum from sc_jobcust) maxdata"
                '브랜드 추가분 실제저장
                mobjceMD_ELECTRIC_PREMATTER.BrandInsertDo(strINSERTSQL)

                strMATTERINSERT = " INSERT INTO MD_ELECTRIC_MATTER"
                strMATTERINSERT = strMATTERINSERT & " (MATTER,CUSTCODE,SEQNO)"
                strMATTERINSERT = strMATTERINSERT & " select"
                strMATTERINSERT = strMATTERINSERT & " matter,custcode,seqno"
                strMATTERINSERT = strMATTERINSERT & " from"
                strMATTERINSERT = strMATTERINSERT & " ("
                strMATTERINSERT = strMATTERINSERT & " 	select "
                strMATTERINSERT = strMATTERINSERT & " 	matter,"
                strMATTERINSERT = strMATTERINSERT & " 	clientcode as custcode,"
                strMATTERINSERT = strMATTERINSERT & " 	dbo.SC_JOBCUSTCODE_FUN(clientcode,subseqname) seqno"
                strMATTERINSERT = strMATTERINSERT & " 	from md_electric_prematter"
                strMATTERINSERT = strMATTERINSERT & " 	group by matter,subseqname,clientcode"
                strMATTERINSERT = strMATTERINSERT & " ) a "
                strMATTERINSERT = strMATTERINSERT & " where not exists"
                strMATTERINSERT = strMATTERINSERT & " ("
                strMATTERINSERT = strMATTERINSERT & " 			select matter,custcode,seqno"
                strMATTERINSERT = strMATTERINSERT & " 			from"
                strMATTERINSERT = strMATTERINSERT & " 				("
                strMATTERINSERT = strMATTERINSERT & " 				select matter,custcode,seqno"
                strMATTERINSERT = strMATTERINSERT & " 				from md_electric_matter"
                strMATTERINSERT = strMATTERINSERT & " 				) b "
                strMATTERINSERT = strMATTERINSERT & " 			where a.matter = b.matter "
                strMATTERINSERT = strMATTERINSERT & " 			and a.custcode = b.custcode"
                strMATTERINSERT = strMATTERINSERT & " 			and a.seqno = b.seqno"
                strMATTERINSERT = strMATTERINSERT & " )"

                '소재 추가분 실제저장
                mobjceMD_ELECTRIC_PREMATTER.MatterInsertDo(strMATTERINSERT)

                '템프 테이블 삭제
                mobjceMD_ELECTRIC_PREMATTER.DeleteDo()

                .mobjSCGLSql.SQLCommitTrans()
                Return intRows
            Catch err As Exception
                .mobjSCGLSql.SQLRollbackTrans()
                Throw RaiseSysErr(err, CLASS_NAME & ".ProcessRtn")
            Finally
                .mobjSCGLSql.SQLDisconnect()
                mobjceMD_ELECTRIC_PREMATTER.Dispose()

            End Try
        End With
    End Function

#End Region

#Region "GROUP BLOCK : 외부에 비공개 Method"
    Private Function InsertRtn(ByVal vntData As Object, _
                               ByVal intColCnt As Integer, _
                               ByVal intRow As Integer) As Integer
        Dim intRtn As Integer
        'MATTER|SUBSEQNAME|CLIENTCODE
        intRtn = mobjceMD_ELECTRIC_PREMATTER.InsertDo( _
                                       GetElement(vntData, "MATTER", intColCnt, intRow), _
                                       GetElement(vntData, "SUBSEQNAME", intColCnt, intRow), _
                                       GetElement(vntData, "CLIENTCODE", intColCnt, intRow))
        Return intRtn
    End Function
#End Region
End Class

